<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        palette: {
                            base: '#fcf8ed',
                            darkBase: '#121212',
                            sidebar: '#2c354c',
                            primary: '#e57e5d',
                            secondary: '#7baded',
                            purple: '#ceaed2',
                            green: '#b4c6aa',
                            panel: '#ffffff',
                            darkPanel: '#1e1b1c',
                            border: '#e0d6bd',
                            darkBorder: '#333333'
                        }
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        .hidden-section {
            display: none !important;
        }

        /* Brand Identity Styling */
        .brand-sidebar {
            background: linear-gradient(180deg, #2c354c 0%, #1a202e 100%);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .dark .glass-panel {
            background: rgba(30, 27, 28, 0.80);
            border-color: rgba(255, 255, 255, 0.08);
            color: white;
        }

        #loginScreen .glass-panel {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1e1b1c !important;
            border-color: #e0d6bd !important;
            box-shadow: 0 25px 50px -12px rgba(83, 92, 114, 0.2) !important;
        }

        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .nav-item {
            border-right: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(229, 126, 93, 0.15) 0%, transparent 100%);
            border-right-color: #e57e5d;
            color: #fff;
        }

        .blend-logo {
            mix-blend-mode: multiply;
        }

        .dark .blend-logo {
            mix-blend-mode: normal;
            filter: brightness(0) invert(1);
        }

        #loginScreen .blend-logo {
            mix-blend-mode: multiply !important;
            filter: contrast(1.25) !important;
        }

        .sticky-note {
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 9999px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .calendar-day-indicator {
            transition: all 0.3s ease;
        }

        .calendar-day:hover .calendar-day-indicator {
            transform: scaleX(1.1);
        }

        .roadmap-timeline-bar {
            height: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .roadmap-timeline-bar:hover {
            transform: scaleY(1.2);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s infinite;
        }

        /* Modern Gradients */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #e57e5d, #ceaed2);
        }

        /* PLANNER STYLES */
        .planner-font {
            font-family: 'Tajawal', sans-serif;
        }

        .planner-section-title {
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            color: #2c354c;
        }

        .planner-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid #ccc;
            width: 100%;
            padding: 4px;
            outline: none;
            transition: border-color 0.3s;
        }

        .planner-input:focus {
            border-bottom-color: #e57e5d;
        }

        .schedule-row {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            align-items: center;
        }

        .schedule-time {
            width: 80px;
            font-weight: bold;
            font-size: 0.8rem;
            color: #555;
            border-right: 2px solid #2c354c;
            padding-right: 8px;
            margin-right: 8px;
            text-align: right;
        }

        .tape {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(2px);
            transform: translateX(-50%) rotate(-2deg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tape-2 {
            transform: translateX(-50%) rotate(1.5deg);
        }

        .dashed-box {
            border: 2px dashed #2c354c;
            background: transparent;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .check-box {
            width: 18px;
            height: 18px;
            border: 2px solid #fff;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .check-box.checked {
            background: #e57e5d;
            border-color: #e57e5d;
        }

        /* MONDAY.COM STYLE TABLE - HIGH CONTRAST */
        .monday-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            font-family: 'Tajawal', sans-serif;
        }

        .monday-table th {
            text-align: right;
            padding: 12px;
            border-bottom: 2px solid #d1d5db;
            color: #111827;
            font-weight: 800;
            font-size: 15px;
        }

        .dark .monday-table th {
            color: #e5e7eb;
            border-bottom-color: #374151;
        }

        .monday-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
            vertical-align: middle;
            color: #000;
            font-weight: 600;
        }

        .dark .monday-table td {
            background: #1e1b1c;
            color: #e5e7eb;
            border-bottom-color: #374151;
        }

        .monday-table tr:hover td {
            background: #f3f4f6;
        }

        .dark .monday-table tr:hover td {
            background: #2d2a2b;
        }

        .status-cell {
            text-align: center;
            color: white;
            border-radius: 4px;
            padding: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }


        .status-cell:hover {
            opacity: 0.8;
        }

        .status-done {
            background-color: #00c875;
        }

        /* Green */
        .status-working {
            background-color: #fdab3d;
        }

        /* Orange */
        .status-stuck {
            background-color: #e2445c;
        }

        /* Red */
        .status-empty {
            background-color: #c4c4c4;
        }

        /* Gray */

        .person-bubble {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            border: 2px solid white;
            margin-left: -8px;
        }

        /* CHAT STYLES (Professional) */
        .chat-container {
            display: flex;
            height: 600px;
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .chat-sidebar {
            width: 300px;
            border-right: 1px solid #f3f4f6;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #fff;
            font-weight: 800;
            color: #111827;
        }

        .chat-user-list {
            overflow-y: auto;
            flex: 1;
        }

        .chat-user-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .chat-user-item:hover {
            background: #fff;
            transform: translateX(5px);
        }

        .chat-user-item.active {
            background: #fff;
            border-right: 4px solid #e57e5d;
            background-color: #fff7ed;
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #e0e7ff;
            color: #4338ca;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .chat-window-header {
            padding: 15px 25px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 15px;
            background: #fff;
            height: 70px;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .chat-bubble {
            max-width: 65%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .chat-bubble.mine {
            align-self: flex-end;
            background: #e57e5d;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.theirs {
            align-self: flex-start;
            background: white;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            border-bottom-right-radius: 4px;
        }

        .chat-timestamp {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 5px;
            text-align: right;
            display: block;
        }

        /* ADVANCED PROJECT TABLE STYLES */


        .timeline-cell {
            position: relative;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .timeline-bar {
            position: absolute;
            height: 100%;
            background: #579bfc;
            border-radius: 12px;
            opacity: 0.8;
        }

        .tag-pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f0f0f0;
            color: #666;
            margin-right: 2px;
        }

        .subitem-trigger {
            cursor: pointer;
            color: #c4c4c4;
            transition: color 0.2s;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .subitem-trigger:hover,
        .subitem-trigger.active {
            color: #579bfc;
        }

        .subitems-row {
            background: #fafafa;
            display: none;
        }

        /* Hidden by default */
        .subitems-row.show {
            display: table-row;
        }

        .subitems-container {
            padding: 10px 10px 10px 60px;
            border-left: 4px solid #579bfc;
        }

        .file-attachment {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #ddd;
            display: inline-block;
            cursor: pointer;
        }

        .add-col-btn {
            color: #579bfc;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* FORCE HIGH CONTRAST INPUTS */
        input,
        textarea,
        select {
            color: #000000 !important;
            font-weight: 600 !important;
            background-color: #ffffff !important;
            border-color: #d1d5db !important;
        }

        input::placeholder,
        textarea::placeholder {
            color: #6b7280 !important;
            opacity: 1 !important;
            font-weight: 400 !important;
        }

        select option {
            color: #000000 !important;
            background: #ffffff !important;
        }

        /* Specific override for project modal inputs if needed */
        #newProjectModal input,
        #newProjectModal select {
            background-color: #f9fafb !important;
            border: 1px solid #e5e7eb !important;
        }

        /* Ensure specific overrides don't break design but keep text black */
        .planner-input {
            color: #000000 !important;
        }

        /* UTILITIES */
        .hidden-section {
            display: none !important;
        }

        /* BIOMETRIC ANIMATIONS */
        @keyframes scanMove {

            0%,
            100% {
                top: 0%;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: scanMove 2s infinite linear;
            border-radius: 50%;
        }

        .col-menu {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 320px;
            z-index: 100;
            padding: 16px;
            display: none;
            border: 1px solid #e1e4e8;
            font-family: 'Tajawal', sans-serif;
            left: 20px;
            /* Adjust based on button position */
        }

        .col-menu-search {
            background: #f5f6f8;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            border: 1px solid transparent;
        }

        .col-menu-search:focus-within {
            border: 1px solid #0073ea;
            background: white;
        }

        .col-menu-search input {
            background: transparent !important;
            border: none !important;
            outline: none !important;
            width: 100%;
            margin-left: 8px;
            font-size: 14px;
            color: #333 !important;
        }

        .col-section-title {
            font-size: 12px;
            color: #676879;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .col-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            color: #323338;
            font-size: 14px;
        }

        .col-item:hover {
            background: #f5f6f8;
        }

        .col-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            color: white;
            font-size: 12px;
        }

        .bio-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto;
            overflow: hidden;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 0, 0.3);
        }
    </style>
</head>

<body
    class="overflow-hidden h-screen bg-palette-base dark:bg-palette-darkBase text-gray-800 dark:text-gray-100 font-sans">

    <!-- LOGIN SCREEN (Restored to Original Light Style) -->
    <div id="loginScreen"
        class="fixed inset-0 z-50 flex items-center justify-center bg-[#fcf8ed] bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] hidden-section text-[#1e1b1c]">
        <div
            class="glass-panel p-10 rounded-3xl shadow-2xl w-full max-w-md border border-palette-border text-center fade-in">
            <div class="mb-10 flex justify-center">
                <img src="image/Hyat.png" class="h-40 object-contain blend-logo">
            </div>
            <h2 class="text-2xl font-bold text-palette-sidebar mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4 mt-8">
                <div class="relative">
                    <i class="fas fa-envelope absolute right-4 top-3.5 text-gray-400"></i>
                    <input type="email" id="emailInput" required placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 pr-10 pl-4 focus:ring-2 focus:ring-palette-primary outline-none transition text-right text-gray-800 placeholder-gray-400">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute right-4 top-3.5 text-gray-400"></i>
                    <input type="password" id="passwordInput" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 pr-10 pl-4 focus:ring-2 focus:ring-palette-primary outline-none transition text-right text-gray-800 placeholder-gray-400">
                </div>
                <button type="submit"
                    class="w-full bg-palette-sidebar hover:bg-[#1e1b1c] text-white font-bold py-3.5 rounded-xl shadow-lg transition transform hover:-translate-y-1">
                    Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="mainDashboard" class="hidden-section flex h-screen">

        <!-- SIDEBAR -->
        <aside class="w-64 brand-sidebar text-white flex flex-col shadow-2xl z-30 shrink-0 border-l border-white/5">
            <div class="h-32 flex items-center justify-center border-b border-white/10 p-6 relative">
                <div
                    class="w-full h-full bg-white/95 rounded-2xl flex items-center justify-center p-3 shadow-lg relative z-10 backdrop-blur-sm">
                    <img src="image/Hyat.png" class="max-h-full max-w-full object-contain filter contrast-110">
                </div>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto custom-scrollbar">

                <!-- MAIN -->
                <div class="px-4 mt-2 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest opacity-50">
                    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <a href="#" onclick="showPage('dashboard', this)"
                    class="nav-item active flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-th-large text-palette-primary group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span>
                </a>

                <!-- WORKSPACE -->
                <div class="px-4 mt-6 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest opacity-50">
                    Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„</div>
                <a href="#" onclick="showPage('dailyPlan', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-pencil-alt text-palette-purple group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
                </a>
                <a href="#" onclick="showPage('projects', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-layer-group text-blue-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
                </a>
                <a href="#" onclick="showPage('tasks', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group relative">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-check-square text-palette-secondary group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„Ù…Ù‡Ø§Ù…</span>
                    <span id="taskBadge"
                        class="absolute left-4 top-3 bg-red-500 text-white text-[9px] min-w-[18px] h-[18px] flex items-center justify-center rounded-full hidden">0</span>
                </a>
                <a href="#" onclick="showPage('roadmap', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-map-signs text-purple-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚ (Roadmap)</span>
                </a>
                <a href="#" onclick="showPage('shared-links', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-search text-blue-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·</span>
                </a>
                <!-- CONNECT -->
                <a href="#" onclick="showPage('messages', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group relative">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-comments text-green-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
                    <span id="msgBadge"
                        class="absolute left-4 top-3 bg-red-500 text-white text-[9px] min-w-[18px] h-[18px] flex items-center justify-center rounded-full hidden">0</span>
                </a>
                <a href="#" onclick="showPage('team', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-users text-indigo-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„ÙØ±ÙŠÙ‚</span>
                </a>
                <a href="#" onclick="showPage('calendar', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-calendar-alt text-orange-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</span>
                </a>

                <!-- DYNAMIC ROLE MENU -->
                <div id="roleMenuContent"></div>

                <!-- SYSTEM -->
                <div class="px-4 mt-6 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest opacity-50">
                    Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                <a href="#" onclick="showPage('reports', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-chart-pie text-teal-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </a>
                <a href="#" onclick="showPage('settings', this)"
                    class="nav-item flex items-center px-4 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 hover:text-white transition group">
                    <span class="w-8 flex justify-center"><i
                            class="fas fa-cog text-gray-400 group-hover:scale-110 transition"></i></span>
                    <span class="font-medium mr-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </a>
            </nav>

            <div class="p-4 border-t border-[#535c72] bg-[#1e1b1c]/30">
                <div class="flex items-center gap-3">
                    <div id="sidebarAvatar"
                        class="w-12 h-12 rounded-full border-2 border-palette-primary bg-gray-700 flex items-center justify-center text-xl font-bold uppercase overflow-hidden">
                        <!-- Img or Initials injected here -->
                    </div>
                    <div class="overflow-hidden">
                        <p id="userNameDisplay" class="text-sm font-bold text-white truncate">User</p>
                        <p id="userRoleDisplay" class="text-xs text-palette-secondary truncate">Role</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 flex flex-col h-screen overflow-auto relative bg-palette-base dark:bg-palette-darkBase">

            <!-- PAGE: FEED (The Square) -->

            <header
                class="h-16 bg-white/80 dark:bg-palette-darkPanel/80 backdrop-blur border-b border-palette-border dark:border-palette-darkBorder flex items-center justify-between px-8 sticky top-0 z-20 transition-colors">
                <h2 id="pageTitle" class="text-xl font-bold text-palette-sidebar dark:text-white">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                <div class="flex items-center gap-3">
                    <button onclick="toggleDarkMode()"
                        class="w-10 h-10 rounded-full bg-white dark:bg-gray-700 shadow-sm flex items-center justify-center text-gray-600 dark:text-yellow-400 hover:scale-110 transition border border-gray-200 dark:border-gray-600">
                        <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
                    </button>
                    <button onclick="openTaskModal()"
                        class="bg-[#e57e5d] text-white px-6 py-2.5 rounded-full text-sm font-bold shadow-md hover:bg-[#d46b4b] transition flex items-center gap-2 transform active:scale-95">
                        <i class="fas fa-plus"></i> Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                    <div class="relative">
                        <button onclick="showPage('messages')"
                            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-300 hover:scale-110 transition border border-gray-200 dark:border-gray-600 relative">
                            <i class="fas fa-bell"></i>
                            <span id="navUnreadBadge"
                                class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                    <button onclick="logout()"
                        class="w-10 h-10 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition border border-red-100">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- PAGE 1: DASHBOARD -->
            <div id="dashboard" class="page-section p-8 space-y-8 overflow-y-auto h-full">
                <div
                    class="bg-gradient-to-r from-palette-sidebar to-[#3e4a63] rounded-[2.5rem] p-10 text-white shadow-2xl relative overflow-hidden group">
                    <div class="relative z-10">
                        <h1 class="text-4xl font-black mb-4 tracking-tight">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±ØŒ <span id="welcomeName"
                                class="text-palette-primary"></span> â›…</h1>
                        <p class="text-blue-200 font-bold text-lg mb-2 opacity-90" id="quranVerse">"..."</p>
                        <p class="text-gray-400 text-sm italic font-medium" id="dailyQuote">"..."</p>
                    </div>
                    <div
                        class="absolute -left-20 -bottom-20 text-[15rem] opacity-5 text-white group-hover:scale-110 transition-transform duration-1000">
                        <i class="fas fa-sun"></i>
                    </div>
                </div>

                <!-- ROLE CONTENT (Stats/Deadlines) -->
                <div id="dashboardContent" class="grid grid-cols-1 gap-8"></div>

                <!-- DASHBOARD CALENDAR PREVIEW -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-black text-palette-sidebar dark:text-white flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-2xl bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center text-orange-500">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ÙØ±ÙŠÙ‚
                        </h3>
                        <button onclick="showPage('calendar', document.querySelector('a[onclick*=\'calendar\']'))"
                            class="text-xs font-black text-palette-primary hover:underline">ÙØªØ­ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ÙƒØ§Ù…Ù„ <i
                                class="fas fa-arrow-left mr-1"></i></button>
                    </div>
                    <div
                        class="bg-white/50 dark:bg-palette-darkPanel/50 backdrop-blur-xl rounded-[2.5rem] border border-gray-100 dark:border-gray-800 p-8 shadow-sm">
                        <div
                            class="grid grid-cols-7 mb-6 text-center text-gray-400 text-[10px] font-black uppercase tracking-widest opacity-40">
                            <div>Ø£Ø­Ø¯</div>
                            <div>Ø§Ø«Ù†ÙŠÙ†</div>
                            <div>Ø«Ù„Ø§Ø«Ø§Ø¡</div>
                            <div>Ø£Ø±Ø¨Ø¹Ø§Ø¡</div>
                            <div>Ø®Ù…ÙŠØ³</div>
                            <div>Ø¬Ù…Ø¹Ø©</div>
                            <div>Ø³Ø¨Øª</div>
                        </div>
                        <div id="dashboardCalendarGrid" class="grid grid-cols-7 gap-3">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: TASKS -->
            <div id="tasks" class="page-section hidden-section p-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-palette-sidebar dark:text-white">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
                    </div>
                    <div
                        class="flex bg-white dark:bg-palette-darkPanel rounded-xl p-1 border border-palette-border dark:border-palette-darkBorder shadow-sm items-center">
                        <button onclick="filterTasks('all')" id="filter-all"
                            class="px-5 py-2 rounded-lg text-sm font-bold bg-palette-primary text-white shadow transition-all">Ø§Ù„ÙƒÙ„</button>
                        <button onclick="filterTasks('me')" id="filter-me"
                            class="px-5 py-2 rounded-lg text-sm font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">Ø§Ù„Ù…Ø³ØªÙ†Ø¯
                            Ø¥Ù„ÙŠ</button>

                        <!-- Team Filter Dropdown -->
                        <div class="relative">
                            <button onclick="toggleTeamFilter(event)" id="filter-team"
                                class="px-5 py-2 rounded-lg text-sm font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all flex items-center gap-2">
                                <span>Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±ÙŠÙ‚</span>
                                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                            </button>
                            <div class="absolute top-full right-0 mt-2 w-56 bg-white dark:bg-palette-darkPanel border border-palette-border dark:border-palette-darkBorder rounded-2xl shadow-2xl hidden z-50 overflow-hidden"
                                id="teamFilterMenu">
                                <!-- Dynamic Team Members here -->
                            </div>
                        </div>

                        <button onclick="filterTasks('completed')" id="filter-completed"
                            class="px-5 py-2 rounded-lg text-sm font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">Ø§Ù„Ù…ÙƒØªÙ…Ù„</button>
                    </div>
                    <button onclick="openTaskModal()"
                        class="bg-palette-sidebar dark:bg-palette-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 font-bold shadow-lg hover:shadow-xl transition"><i
                            class="fas fa-plus-circle"></i> Ù…Ù‡Ù…Ø© Ù…ÙØµÙ„Ø©</button>
                </div>



                <div class="mb-6">
                    <div class="relative group">
                        <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                            <i
                                class="fas fa-plus text-palette-primary opacity-50 group-focus-within:opacity-100 transition-opacity"></i>
                        </div>
                        <input type="text" id="quickAddMainTask"
                            placeholder="Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ Ø§Ø¶ØºØ· Enter Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø±ÙŠØ¹..."
                            class="w-full bg-white dark:bg-palette-darkPanel border-2 border-dashed border-gray-100 dark:border-gray-800 rounded-2xl py-4 pr-12 pl-6 outline-none focus:border-palette-primary dark:focus:border-palette-primary focus:ring-4 focus:ring-palette-primary/5 transition-all text-sm font-bold shadow-sm"
                            onkeydown="if(event.key === 'Enter') handleQuickAddMainTask(this)">
                    </div>
                </div>

                <div id="taskList" class="grid grid-cols-1 gap-3">
                    <!-- Tasks injected here -->
                </div>
                <div id="noTasksMsg" class="hidden text-center py-12 text-gray-400">
                    <i class="fas fa-check-circle text-6xl mb-4 opacity-20"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                </div>
            </div>

            <!-- PAGE 3: CALENDAR -->
            <!-- PAGE 3: CALENDAR (Modern Redesign) -->
            <div id="calendar" class="page-section hidden-section p-8 h-full flex flex-col">
                <div class="flex justify-between items-end mb-8">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-14 h-14 rounded-[1.25rem] bg-gradient-to-br from-palette-primary/20 to-palette-secondary/20 flex items-center justify-center text-palette-primary shadow-inner border border-white/50">
                                <i class="fas fa-calendar-check text-2xl"></i>
                            </div>
                            <div>
                                <h2 id="calendarTitle"
                                    class="text-3xl font-black text-palette-sidebar dark:text-white tracking-tight">Ù…Ù†Ø¸Ù…
                                    Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>
                                <p
                                    class="text-[10px] text-gray-400 mt-1 font-bold uppercase tracking-widest opacity-60">
                                    Ù…Ø±ÙƒØ² Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ÙØ±ÙŠÙ‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <!-- Navigation -->
                        <div
                            class="flex items-center bg-white/70 dark:bg-palette-darkPanel/70 backdrop-blur-md rounded-2xl border border-gray-100 dark:border-gray-800 p-1.5 shadow-sm h-14">
                            <button onclick="changeMonth(-1)"
                                class="w-11 h-11 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-center text-gray-400 dark:text-gray-200 transition"><i
                                    class="fas fa-arrow-right text-xs"></i></button>
                            <span id="calendarMonth"
                                class="text-sm font-black px-6 text-palette-primary min-w-[140px] text-center">...</span>
                            <button onclick="changeMonth(1)"
                                class="w-11 h-11 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-center text-gray-400 dark:text-gray-200 transition"><i
                                    class="fas fa-arrow-left text-xs"></i></button>
                        </div>

                        <!-- Sync Dropdown -->
                        <div class="relative group">
                            <button
                                class="bg-palette-sidebar dark:bg-palette-primary text-white h-14 px-8 rounded-2xl text-xs font-bold shadow-2xl transition flex items-center gap-3 hover:scale-[1.02] active:scale-95">
                                <i class="fas fa-cloud-upload-alt text-lg"></i> Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… <i
                                    class="fas fa-chevron-down text-[10px] opacity-70"></i>
                            </button>
                            <div
                                class="absolute left-0 top-full mt-3 w-64 bg-white dark:bg-palette-darkPanel rounded-[2rem] shadow-2xl border border-gray-100 dark:border-gray-800 p-4 hidden group-hover:block z-[100] animate-in fade-in slide-in-from-top-3 duration-300">
                                <div
                                    class="px-4 py-2 text-[10px] font-black text-gray-300 uppercase tracking-widest mb-2">
                                    ØªÙˆØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                                <button onclick="integrateGoogleCalendar()"
                                    class="w-full text-right px-4 py-4 rounded-2xl hover:bg-red-50 dark:hover:bg-red-900/10 flex items-center gap-4 transition group/item">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-white shadow-sm flex items-center justify-center border border-gray-100">
                                        <img src="https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_48dp.png"
                                            class="w-6 h-6">
                                    </div>
                                    <span
                                        class="text-xs font-bold text-gray-700 dark:text-gray-200 group-hover/item:text-red-500">Google
                                        Calendar</span>
                                </button>
                                <button onclick="integrateOneDrive()"
                                    class="w-full text-right px-4 py-4 rounded-2xl hover:bg-blue-50 dark:hover:bg-blue-900/10 flex items-center gap-4 transition group/item">
                                    <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center"><i
                                            class="fab fa-microsoft text-[#0078D4] text-xl"></i></div>
                                    <span
                                        class="text-xs font-bold text-gray-700 dark:text-gray-200 group-hover/item:text-blue-600">Microsoft
                                        Outlook</span>
                                </button>
                                <div class="my-3 border-t border-gray-50 dark:border-gray-800"></div>
                                <button onclick="uploadCalendarFile()"
                                    class="w-full text-right px-4 py-4 rounded-2xl hover:bg-palette-primary/10 flex items-center gap-4 transition text-palette-primary">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-palette-primary/10 flex items-center justify-center">
                                        <i class="fas fa-file-medical"></i>
                                    </div>
                                    <span class="text-xs font-bold">Ø±ÙØ¹ Ù…Ù„Ù ØªÙ‚ÙˆÙŠÙ… (.ics)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex gap-8 overflow-hidden">
                    <!-- MAIN CALENDAR -->
                    <div class="flex-[3] flex flex-col gap-6">
                        <div
                            class="flex items-center bg-gray-100/50 dark:bg-gray-800/50 p-1.5 rounded-2xl w-fit border border-gray-200/30 dark:border-gray-800">
                            <button onclick="setCalendarType('shared')" id="calBtnShared"
                                class="px-10 py-3 rounded-xl text-xs font-extrabold transition bg-white dark:bg-gray-700 shadow-lg text-palette-primary">Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
                                Ø§Ù„Ø¹Ø§Ù…</button>
                            <button onclick="setCalendarType('personal')" id="calBtnPersonal"
                                class="px-10 py-3 rounded-xl text-xs font-extrabold transition text-gray-400">Ù…Ù„ÙÙŠ
                                Ø§Ù„Ø´Ø®ØµÙŠ</button>
                        </div>

                        <div
                            class="flex-1 bg-white/40 dark:bg-palette-darkPanel/40 backdrop-blur-xl rounded-[2.5rem] shadow-2xl shadow-gray-200/50 dark:shadow-none border border-white dark:border-palette-darkBorder p-8 overflow-hidden flex flex-col relative group/grid">
                            <div
                                class="grid grid-cols-7 mb-6 text-center text-gray-400 text-[10px] font-black uppercase tracking-[0.2em] opacity-40">
                                <div>Ø§Ù„Ø£Ø­Ø¯</div>
                                <div>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</div>
                                <div>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</div>
                                <div>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</div>
                                <div>Ø§Ù„Ø®Ù…ÙŠØ³</div>
                                <div>Ø§Ù„Ø¬Ù…Ø¹Ø©</div>
                                <div>Ø§Ù„Ø³Ø¨Øª</div>
                            </div>
                            <div id="calendarGrid" class="grid grid-cols-7 flex-1 gap-4">
                                <!-- Days injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- SIDEBAR -->
                    <div class="flex-1 flex flex-col gap-8 w-80">
                        <!-- Summary Card -->
                        <div
                            class="bg-[#2c354c] rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden group">
                            <div
                                class="absolute -right-20 -top-20 w-60 h-60 bg-white/5 rounded-full blur-3xl group-hover:bg-white/10 transition-all duration-1000">
                            </div>
                            <h3 class="font-bold text-2xl mb-4 flex items-center gap-3">Ù†Ø¨Ø°Ø© Ø°ÙƒÙŠØ©</h3>
                            <p id="calendarBriefText" class="text-xs opacity-60 leading-relaxed font-tajawal mb-8">Ù‚Ù…
                                Ø¨Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ‚ÙˆÙŠÙ…Ùƒ Ø§Ù„Ø¢Ù† Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ ÙˆØªÙˆØ²ÙŠØ¹ ÙˆÙ‚ØªÙƒ...</p>

                            <div class="grid grid-cols-2 gap-4 relative z-10">
                                <div
                                    class="bg-white/5 backdrop-blur-md rounded-3xl p-5 border border-white/10 text-center">
                                    <div class="text-2xl font-black mb-1" id="briefTaskCount">0</div>
                                    <div class="text-[9px] font-bold text-blue-300 uppercase tracking-widest">Ù…Ù‡Ø§Ù…</div>
                                </div>
                                <div
                                    class="bg-white/5 backdrop-blur-md rounded-3xl p-5 border border-white/10 text-center">
                                    <div class="text-2xl font-black mb-1" id="briefMeetingCount">0</div>
                                    <div class="text-[9px] font-bold text-purple-300 uppercase tracking-widest">Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Events -->
                        <div
                            class="bg-white dark:bg-palette-darkPanel rounded-[2.5rem] border border-palette-border dark:border-palette-darkBorder p-8 flex-1 flex flex-col overflow-hidden shadow-sm">
                            <div class="flex justify-between items-center mb-8">
                                <h3 class="font-black text-gray-800 dark:text-white flex items-center gap-3 text-sm">
                                    <div
                                        class="w-10 h-10 rounded-[1rem] bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center">
                                        <i class="fas fa-list-ul text-indigo-500 text-sm"></i>
                                    </div>
                                    Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                                </h3>
                                <span
                                    class="text-[9px] font-black bg-indigo-50 text-indigo-500 px-3 py-1.5 rounded-full uppercase">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø©
                                    Ø¥Ù„ÙŠÙƒ</span>
                            </div>

                            <div id="upcomingEventsList" class="flex-1 overflow-y-auto space-y-6 pr-2 custom-scrollbar">
                                <div class="flex flex-col items-center justify-center h-full text-center opacity-20">
                                    <i class="fas fa-calendar-alt text-6xl mb-4"></i>
                                    <p class="text-[11px] font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¨Ø±Ù…Ø¬Ø©</p>
                                </div>
                            </div>

                            <button onclick="Swal.fire({title:'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯', input:'text', confirmButtonText:'Ø¬Ø¯ÙˆÙ„Ø©'})"
                                class="mt-6 w-full py-4 border-2 border-dashed border-gray-100 dark:border-gray-800 rounded-3xl text-[10px] font-black text-gray-300 hover:border-palette-primary hover:text-palette-primary hover:bg-gray-50 dark:hover:bg-gray-800 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ¹Ø¯ ÙŠØ¯ÙˆÙŠ
                            </button>
                        </div>
                    </div>
                </div>
                <p
                    class="text-[9px] text-gray-400 mt-6 text-center font-bold uppercase tracking-[0.3em] opacity-40 italic">
                    <i class="fas fa-info-circle mr-1 text-[7px]"></i> Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ø±ÙŠØ¹Ø©
                </p>
            </div>

            <!-- PAGE 4: REPORTS (GM/PM) -->
            <div id="reports" class="page-section hidden-section p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-palette-sidebar dark:text-white flex items-center gap-3">ğŸ“Š
                            Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h2>
                        <p class="text-xs text-gray-400 mt-1">ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
                    </div>
                    <button onclick="Swal.fire('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„...', 'success')"
                        class="bg-palette-secondary text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-400 transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ
                    </button>
                </div>

                <!-- Stats Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="reportStats">
                    <!-- Dynamic Stats -->
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Chart 1: Performance -->
                    <div
                        class="bg-white dark:bg-palette-darkPanel p-8 rounded-3xl shadow-sm border border-palette-border dark:border-palette-darkBorder transition hover:shadow-md">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-800 dark:text-gray-200">ğŸ“ˆ Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (Monthly Activity)
                            </h3>
                            <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">Q1
                                2026</span>
                        </div>
                        <div class="h-64"><canvas id="barChart"></canvas></div>
                    </div>
                    <!-- Chart 2: Status Distribution -->
                    <div
                        class="bg-white dark:bg-palette-darkPanel p-8 rounded-3xl shadow-sm border border-palette-border dark:border-palette-darkBorder transition hover:shadow-md">
                        <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">ğŸ¯ ØªÙˆØ²ÙŠØ¹
                            Ø§Ù„Ø­Ø§Ù„Ø§Øª (Status Mix)</h3>
                        <div class="h-64 flex justify-center"><canvas id="doughnutChart"></canvas></div>
                    </div>
                </div>

                <!-- Quarterly Breakdown List -->
                <div
                    class="bg-white dark:bg-palette-darkPanel p-8 rounded-3xl border border-palette-border dark:border-palette-darkBorder shadow-sm">
                    <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">ğŸ“… ØªÙØµÙŠÙ„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                        Ø­Ø³Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø¹</h3>
                    <div id="quarterlyList" class="space-y-4">
                        <!-- Dynamic Quarterly Data -->
                    </div>
                </div>
            </div>

            <!-- PAGE 5: PROJECTS (PM Specific LEGACY) -->
            <div id="projects_legacy" class="page-section hidden-section p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-palette-sidebar dark:text-white">ğŸ“‘ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
                    <button onclick="openNewProjectModal()"
                        class="bg-palette-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition hover:bg-palette-secondary"><i
                            class="fas fa-plus ml-2"></i> Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div class="grid grid-cols-1 gap-4" id="projectsList">
                    <!-- Dynamic Projects -->
                </div>
            </div>


            <!-- PAGE 1.5: DAILY PLAN (New) -->
            <div id="dailyPlan" class="page-section hidden-section p-8 overflow-y-auto">
                <div
                    class="max-w-5xl mx-auto bg-[#fdfbf6] rounded-3xl shadow-xl p-8 border border-[#e0d6bd] relative min-h-[800px]">
                    <h1 class="text-4xl font-extrabold text-center text-[#2c354c] mb-8 tracking-widest"
                        style="font-family: 'Tajawal';">DAILY PLAN</h1>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <!-- LEFT COLUMN -->
                        <div class="space-y-8">
                            <!-- SCHEDULE -->
                            <div>
                                <h3 class="planner-section-title border-b-2 border-[#2c354c]">TODAY'S SCHEDULE</h3>
                                <div class="mt-4 space-y-1">
                                    <div class="schedule-row"><span class="schedule-time">8-9 AM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_8')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">9-10 AM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_9')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">10-11 AM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_10')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">11-12 AM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_11')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">12-1 PM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_12')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">1-2 PM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_1')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">2-3 PM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_2')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">3-4 PM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_3')">
                                    </div>
                                    <div class="schedule-row"><span class="schedule-time">4-5 PM</span><input
                                            type="text" class="planner-input" onchange="savePlanner(this,'sch_4')">
                                    </div>
                                </div>
                            </div>

                            <!-- FINISHED -->
                            <div class="dashed-box p-4 rounded-xl relative mt-8 h-48">
                                <h3
                                    class="planner-section-title italic opacity-50 absolute -top-3 bg-[#fdfbf6] px-2 left-4">
                                    FINISHED</h3>
                                <textarea
                                    class="w-full h-full bg-transparent border-none outline-none resize-none text-sm"
                                    placeholder="List what you accomplished..."
                                    onchange="savePlanner(this,'finished')"></textarea>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN -->
                        <div class="space-y-6">
                            <!-- DATE BOX -->
                            <div class="bg-[#eeeae4] p-4 rounded-lg text-right">
                                <span class="font-bold text-[#2c354c] mr-2">DATE:</span> <span id="plannerDate"
                                    class="text-gray-600">...</span>
                            </div>

                            <!-- PRIORITIES -->
                            <div>
                                <h3 class="planner-section-title">TOP PRIORITIES</h3>
                                <div class="space-y-3 mt-2">
                                    <input type="text"
                                        class="w-full bg-[#eeeae4] rounded p-2 text-sm border-none outline-none"
                                        placeholder="1." onchange="savePlanner(this,'prio_1')">
                                    <input type="text"
                                        class="w-full bg-[#eeeae4] rounded p-2 text-sm border-none outline-none"
                                        placeholder="2." onchange="savePlanner(this,'prio_2')">
                                    <input type="text"
                                        class="w-full bg-[#eeeae4] rounded p-2 text-sm border-none outline-none"
                                        placeholder="3." onchange="savePlanner(this,'prio_3')">
                                </div>
                            </div>

                            <!-- TO DO LIST (Green) -->
                            <div class="bg-[#b4c6aa] p-6 rounded-2xl relative shadow-md text-white mt-8">
                                <div class="tape"></div>
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-handwriting text-xl font-bold">TO DO LIST..</h3>
                                    <button onclick="syncTasksToPlanner()"
                                        class="text-[10px] bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-white transition"
                                        title="Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…">
                                        <i class="fas fa-sync-alt"></i> SYNC
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div class="check-item">
                                        <div class="check-box" onclick="toggleCheck(this, 'todo_1')"></div><input
                                            class="bg-transparent border-b border-white/30 text-white w-full outline-none placeholder-white/50"
                                            placeholder="..." onchange="savePlanner(this,'todo_txt_1')">
                                    </div>
                                    <div class="check-item">
                                        <div class="check-box" onclick="toggleCheck(this, 'todo_2')"></div><input
                                            class="bg-transparent border-b border-white/30 text-white w-full outline-none placeholder-white/50"
                                            placeholder="..." onchange="savePlanner(this,'todo_txt_2')">
                                    </div>
                                    <div class="check-item">
                                        <div class="check-box" onclick="toggleCheck(this, 'todo_3')"></div><input
                                            class="bg-transparent border-b border-white/30 text-white w-full outline-none placeholder-white/50"
                                            placeholder="..." onchange="savePlanner(this,'todo_txt_3')">
                                    </div>
                                    <div class="check-item">
                                        <div class="check-box" onclick="toggleCheck(this, 'todo_4')"></div><input
                                            class="bg-transparent border-b border-white/30 text-white w-full outline-none placeholder-white/50"
                                            placeholder="..." onchange="savePlanner(this,'todo_txt_4')">
                                    </div>
                                    <div class="check-item">
                                        <div class="check-box" onclick="toggleCheck(this, 'todo_5')"></div><input
                                            class="bg-transparent border-b border-white/30 text-white w-full outline-none placeholder-white/50"
                                            placeholder="..." onchange="savePlanner(this,'todo_txt_5')">
                                    </div>
                                    <div class="check-item">
                                        <div class="check-box" onclick="toggleCheck(this, 'todo_6')"></div><input
                                            class="bg-transparent border-b border-white/30 text-white w-full outline-none placeholder-white/50"
                                            placeholder="..." onchange="savePlanner(this,'todo_txt_6')">
                                    </div>
                                </div>
                            </div>

                            <!-- BOTTOM ROW: TOMORROW (Purple) + NOTES (Yellow) -->
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <div
                                    class="bg-[#ceaed2] p-4 rounded-tl-2xl rounded-br-2xl text-white shadow relative min-h-[120px]">
                                    <h3 class="font-bold text-sm mb-2 opacity-80">FOR TOMORROW..</h3>
                                    <textarea
                                        class="w-full h-20 bg-transparent border-none outline-none resize-none text-sm placeholder-white/50"
                                        onchange="savePlanner(this,'tomorrow')"></textarea>
                                </div>
                                <div
                                    class="bg-[#f3f0e0] p-4 shadow-lg transform rotate-1 relative min-h-[120px] text-gray-700">
                                    <div class="tape tape-2 bg-yellow-100/50"></div>
                                    <h3 class="font-bold text-sm mb-2 opacity-50">NOTE..</h3>
                                    <textarea
                                        class="w-full h-20 bg-transparent border-none outline-none resize-none text-sm"
                                        onchange="savePlanner(this,'note')"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ARCHIVE ACTION -->
                    <div class="mt-8 flex justify-end border-t border-[#e0d6bd] pt-4">
                        <button onclick="archiveDay()"
                            class="bg-[#2c354c] text-white px-6 py-2 rounded-xl shadow-lg hover:bg-[#1e2538] transition flex items-center gap-2">
                            <i class="fas fa-archive"></i> Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„ÙŠÙˆÙ…
                        </button>
                    </div>
                </div>

                <!-- HISTORY ROLL -->
                <div id="plannerHistory" class="max-w-5xl mx-auto mt-12 space-y-6 pb-20">
                    <!-- Archived days injected here -->
                </div>
            </div>

            <!-- PAGE: PROJECTS (Monday Style) -->
            <div id="projects" class="page-section hidden-section p-6">
                <!-- Project Views Container -->
                <div id="projectBoardView">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-[#323338]">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
                            <p class="text-sm text-gray-500">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‡Ø§Ù…Ù‡</p>
                        </div>
                        <button onclick="window.openNewProjectModal()"
                            class="text-white px-6 py-2.5 rounded-lg text-[15px] font-bold shadow-md hover:opacity-90 transition active:scale-95 flex items-center gap-2"
                            style="background-color: #0060E0 !important;">
                            Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div id="projectCardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Project Cards will be injected here -->
                    </div>
                </div>

                <div id="projectDetailView" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            <button onclick="backToProjectBoard()"
                                class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                <i class="fas fa-arrow-right text-gray-600 dark:text-gray-300"></i>
                            </button>
                            <div>
                                <h2 id="detailProjectName" class="text-2xl font-bold text-[#323338] dark:text-white">Ø§Ø³Ù…
                                    Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
                                <div class="flex items-center gap-3 mt-1">
                                    <span id="detailProjType"
                                        class="bg-blue-50 dark:bg-blue-900/20 text-blue-600 text-[10px] px-2 py-0.5 rounded border border-blue-100 dark:border-blue-800/50 font-bold">Ø¹Ø§Ù…</span>
                                    <span id="detailProjBudget"
                                        class="bg-green-50 dark:bg-green-900/20 text-green-600 text-[10px] px-2 py-0.5 rounded border border-green-100 dark:border-green-800/50 font-bold">$0</span>
                                    <span class="text-[10px] text-gray-400">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="renderProjectDetail(currentProjectId)"
                                class="text-gray-500 hover:bg-gray-100 p-2 rounded"><i
                                    class="fas fa-sync-alt"></i></button>
                            <button onclick="openNewTaskInProject()"
                                class="text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:opacity-90 transition flex items-center gap-2"
                                style="background-color: #0060E0 !important;">
                                <i class="fas fa-plus"></i> Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-palette-darkPanel rounded-lg shadow-sm border border-[#e6e9ef] dark:border-palette-darkBorder overflow-hidden min-h-[500px]">
                        <div class="overflow-x-auto">
                            <table class="monday-table" id="projectTable">
                                <thead class="hidden" id="mainTableHead">
                                    <tr id="projectTableHeadRow">
                                        <!-- Keep for colMenu reference but hidden by default -->
                                    </tr>
                                </thead>
                                <tbody id="projectTableBody">
                                    <!-- Recursive rows will be injected here -->
                                </tbody>
                            </table>
                            <div class="p-3 border-t border-[#e6e9ef] bg-gray-50 dark:bg-gray-900/40">
                                <div class="flex items-center gap-2">
                                    <input type="text" id="quickAddTaskInput" placeholder="+ Ø£Ø¶Ù Ù…Ù‡Ù…Ø© ÙˆØ§Ø¶ØºØ· Enter..."
                                        class="flex-1 p-2 text-sm outline-none hover:bg-white transition rounded border border-transparent focus:border-blue-500"
                                        onkeydown="if(event.key === 'Enter') handleQuickAddTask(this)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Project Modal -->
                <div id="newProjectModal"
                    class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-[500px] p-6 shadow-2xl transform transition-all scale-100">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl font-bold text-gray-800">âœ¨ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h3>
                            <button onclick="closeProjectModal()" class="text-gray-400 hover:text-gray-600"><i
                                    class="fas fa-times text-xl"></i></button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                                <input type="text" id="np_name"
                                    class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none"
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                                    <select id="np_type"
                                        class="w-full border border-gray-300 rounded-lg p-2 outline-none text-sm bg-white">
                                        <option value="General">Ø¹Ø§Ù…</option>
                                        <option value="Marketing">ØªØ³ÙˆÙŠÙ‚</option>
                                        <option value="Development">ØªØ·ÙˆÙŠØ± Ø¨Ø±Ù…Ø¬ÙŠ</option>
                                        <option value="Design">ØªØµÙ…ÙŠÙ…</option>
                                        <option value="HR">Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="np_date"
                                            class="flex-1 border border-gray-300 rounded-lg p-2 outline-none text-sm">
                                        <div
                                            class="flex items-center gap-1 border border-gray-200 rounded-lg px-2 py-2 bg-gray-50">
                                            <input type="checkbox" id="np_flexible_date" class="w-4 h-4">
                                            <span class="text-[10px] font-bold">Ù…Ø±Ù†</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                                    <select id="np_person"
                                        class="w-full border border-gray-300 rounded-lg p-2 outline-none">
                                        <option value="?">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
                                        <option value="All">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                                        <option value="G">Ghada</option>
                                        <option value="LA">Lina</option>
                                        <option value="N">Norah</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</label>
                                    <input type="text" id="np_budget"
                                        class="w-full border border-gray-300 rounded-lg p-2 outline-none"
                                        placeholder="$0">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ØªØ®ØµÙŠØµ (Tags & Files)</label>
                            <div class="flex gap-2">
                                <input type="text" id="np_tags"
                                    class="flex-1 border border-gray-300 rounded-lg p-2 outline-none"
                                    placeholder="#design #urgent...">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ)</label>
                                <div class="relative">
                                    <input type="file" id="np_files" multiple accept="image/*,video/*,.pdf"
                                        class="hidden" onchange="updateFileLabel(this)">
                                    <label for="np_files"
                                        class="w-full border border-dashed border-blue-400 bg-blue-50 rounded-lg p-2 cursor-pointer flex items-center justify-center gap-2 text-blue-600 hover:bg-blue-100 transition text-sm">
                                        <i class="fas fa-cloud-upload-alt"></i> <span id="np_file_label">Ø§Ø®ØªØ±
                                            Ù…Ù„ÙØ§Øª...</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end gap-3">
                            <button onclick="closeProjectModal()"
                                class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onclick="saveNewProject()"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-lg">Ø¥Ù†Ø´Ø§Ø¡
                                Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: MESSAGES (Private Chat Professional) -->
            <div id="messages" class="page-section hidden-section p-8 h-[calc(100vh-80px)]">
                <div
                    class="chat-container h-full bg-white dark:bg-palette-darkPanel shadow-2xl rounded-3xl overflow-hidden flex border border-palette-border">
                    <div class="w-80 border-l border-gray-100 dark:border-gray-800 flex flex-col">
                        <div class="p-6 font-bold text-xl border-b border-gray-50 flex justify-between items-center">
                            <span>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
                            <i class="fas fa-edit text-sm text-palette-primary cursor-pointer"></i>
                        </div>
                        <div class="p-4">
                            <div class="relative">
                                <i class="fas fa-search absolute right-3 top-3 text-gray-300"></i>
                                <input type="text" placeholder="Ø¨Ø­Ø«..."
                                    class="w-full bg-gray-50 dark:bg-gray-800 rounded-xl py-2 pr-10 pl-4 text-sm outline-none">
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto" id="chatUserList"></div>
                    </div>

                    <div class="flex-1 flex flex-col bg-[#fcfcfc] dark:bg-gray-900/20">
                        <div id="chatHeader"
                            class="p-4 bg-white dark:bg-palette-darkPanel border-b flex items-center justify-between hidden">
                            <div class="flex items-center gap-3">
                                <div id="chatHeaderAvatar"
                                    class="w-10 h-10 rounded-full bg-palette-primary text-white flex items-center justify-center font-bold">
                                </div>
                                <div>
                                    <h4 id="chatHeaderName" class="font-bold text-sm">--</h4>
                                    <span class="text-[10px] text-green-500">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>
                                </div>
                            </div>
                        </div>

                        <div id="chatEmptyState" class="flex-1 flex flex-col items-center justify-center text-gray-300">
                            <img src="https://cdn-icons-png.flaticon.com/512/4080/4080032.png"
                                class="w-32 opacity-20 mb-4">
                            <p class="font-medium">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ Ø§Ù„Ø¢Ù†</p>
                        </div>

                        <div id="chatWindow" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4 hidden"></div>

                        <div id="chatInputArea" class="p-4 bg-white dark:bg-palette-darkPanel border-t hidden">
                            <div class="flex items-center gap-3 bg-gray-50 dark:bg-gray-800 rounded-2xl p-2">
                                <button class="w-10 h-10 text-gray-400"><i class="fas fa-paperclip"></i></button>
                                <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                                    onkeydown="if(event.key==='Enter') sendPrivateMessage()"
                                    class="flex-1 bg-transparent outline-none text-sm">
                                <button onclick="sendPrivateMessage()"
                                    class="w-10 h-10 bg-palette-primary text-white rounded-xl shadow-lg shadow-palette-primary/20">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: ROADMAP -->
            <div id="roadmap" class="page-section hidden-section p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-palette-sidebar dark:text-white">Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚ (Roadmap)</h2>
                        <p class="text-sm text-gray-500">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø±Ø­Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±ÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹</p>
                    </div>
                    <button onclick="openRoadmapModal()"
                        class="bg-palette-sidebar dark:bg-palette-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl transition flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©/Ù…Ù‡Ù…Ø©
                    </button>
                </div>

                <div class="grid grid-cols-1 gap-8">
                    <div
                        class="bg-white dark:bg-palette-darkPanel rounded-3xl p-6 border border-palette-border shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="w-full text-right border-collapse">
                                <thead>
                                    <tr
                                        class="text-gray-400 text-xs uppercase tracking-wider border-b border-gray-100 dark:border-gray-800">
                                        <th class="pb-4 font-bold text-right pr-4" style="width: 250px;">Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                                        </th>
                                        <th class="pb-4 font-bold text-right" style="width: 100px;">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                        <th class="pb-4 font-bold text-right" style="width: 100px;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
                                        <th class="pb-4 font-bold text-right" style="width: 100px;">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                                        <th class="pb-4 font-bold text-right" style="width: 100px;">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                                        <th class="pb-4 font-bold text-center" id="roadmapTimelineHeader">
                                            <!-- Timeline days will be injected here -->
                                        </th>
                                        <th class="pb-4 font-bold text-center" style="width: 100px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="roadmapTableBody" class="text-sm">
                                    <!-- Content Injected via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL: ADD/EDIT ROADMAP TASK -->
            <div id="roadmapModal"
                class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm"
                onclick="if(event.target === this) closeModal('roadmapModal')">
                <div class="bg-white dark:bg-palette-darkPanel w-full max-w-xl rounded-2xl p-8 relative shadow-2xl">
                    <button onclick="closeModal('roadmapModal')"
                        class="absolute top-4 left-4 text-gray-400 hover:text-red-500"><i
                            class="fas fa-times"></i></button>
                    <h3 id="roadmapModalTitle"
                        class="text-xl font-bold text-palette-sidebar dark:text-white mb-6 flex items-center gap-2">
                        Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ù„Ù„Ø®Ø§Ø±Ø·Ø©</h3>
                    <form onsubmit="saveRoadmapTask(event)" class="space-y-4">
                        <input type="hidden" id="roadmapTaskId">
                        <input type="hidden" id="roadmapParentId">

                        <div class="grid grid-cols-2 gap-4 text-right" dir="rtl">
                            <div class="col-span-2">
                                <label class="block text-sm font-bold dark:text-gray-300 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                                <input type="text" id="rmTaskTitle" required
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 outline-none dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-bold dark:text-gray-300 mb-1">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                                <select id="rmTaskWho"
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                                    <option value="ØºØ§Ø¯Ø©">ØºØ§Ø¯Ø©</option>
                                    <option value="Ù„ÙŠÙ†Ø§">Ù„ÙŠÙ†Ø§</option>
                                    <option value="Ù†ÙˆØ±Ø©">Ù†ÙˆØ±Ø©</option>
                                    <option value="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold dark:text-gray-300 mb-1">Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                                <select id="rmTaskCategory"
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                                    <option value="hr">Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©</option>
                                    <option value="pm">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§Ø±ÙŠØ¹</option>
                                    <option value="dev">ØªØ·ÙˆÙŠØ± ÙˆØ¨Ø±Ù…Ø¬Ø©</option>
                                    <option value="manage">Ø¥Ø¯Ø§Ø±Ø©</option>
                                    <option value="general">Ø¹Ø§Ù…</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold dark:text-gray-300 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                                <input type="date" id="rmTaskStart" required
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-bold dark:text-gray-300 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                                <input type="date" id="rmTaskEnd" required
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-bold dark:text-gray-300 mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (%)</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" id="rmTaskProgress" min="0" max="100" step="5" value="0"
                                        class="flex-1 accent-palette-primary"
                                        oninput="this.nextElementSibling.innerText = this.value + '%'">
                                    <span class="text-sm font-bold text-palette-primary w-10">0%</span>
                                </div>
                            </div>

                        </div>
                        <button type="submit"
                            class="w-full bg-palette-sidebar dark:bg-palette-primary text-white font-bold py-3 rounded-xl shadow-lg mt-4 transition hover:bg-opacity-90">Ø­ÙØ¸
                            Ø§Ù„Ù…Ù‡Ù…Ø©</button>
                    </form>
                </div>
            </div>


            <!-- PAGE: SHARED LINKS -->
            <div id="shared-links" class="page-section hidden-section p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-palette-sidebar dark:text-white">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</h2>
                        <p class="text-sm text-gray-500">Ù…Ø³Ø§Ø­Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‡Ø§Ù…Ø©</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <i
                                class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·..." oninput="filterLinks(this.value)"
                                class="bg-white dark:bg-palette-darkPanel border border-palette-border dark:border-palette-darkBorder rounded-xl px-9 py-2 text-xs outline-none focus:ring-2 ring-palette-primary transition w-64 dark:text-white">
                        </div>
                        <button onclick="openLinkModal()"
                            class="bg-palette-sidebar dark:bg-palette-primary text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>

                <div id="linksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Sample Link Card -->
                    <div
                        class="bg-white dark:bg-palette-darkPanel rounded-3xl p-6 border border-palette-border shadow-sm group hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-4">
                            <div
                                class="w-12 h-12 rounded-2xl bg-green-50 text-green-600 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span class="text-[10px] bg-gray-50 text-gray-400 px-2 py-1 rounded-md">Excel</span>
                        </div>
                        <h4 class="font-bold text-lg dark:text-white mb-1">Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
                        <p class="text-xs text-gray-400 mb-6">Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©
                        </p>
                        <a href="#"
                            class="w-full py-2.5 bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-xl flex items-center justify-center gap-2 font-bold text-xs hover:bg-palette-primary hover:text-white transition">
                            <i class="fas fa-external-link-alt"></i> ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
                        </a>
                    </div>
                </div>
            </div>

            <!-- MODAL: ADD LINK -->
            <div id="linkModal"
                class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm"
                onclick="if(event.target === this) closeModal('linkModal')">
                <div class="bg-white dark:bg-palette-darkPanel w-full max-w-lg rounded-2xl p-8 relative shadow-2xl">
                    <button onclick="closeModal('linkModal')"
                        class="absolute top-4 left-4 text-gray-400 hover:text-red-500"><i
                            class="fas fa-times"></i></button>
                    <h3 id="linkModalTitle"
                        class="text-xl font-bold text-palette-sidebar dark:text-white mb-6 flex items-center gap-2">
                        Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <form onsubmit="addSharedLink(event)" class="space-y-4" id="linkForm">
                        <input type="hidden" id="linkId">

                        <!-- Content Type Toggle -->
                        <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl mb-4">
                            <button type="button" onclick="setLinkType('link')" id="btnTypeLink"
                                class="flex-1 py-2 text-xs font-bold rounded-lg transition bg-white dark:bg-gray-700 shadow-sm text-palette-primary">Ø±Ø§Ø¨Ø·</button>
                            <button type="button" onclick="setLinkType('file')" id="btnTypeFile"
                                class="flex-1 py-2 text-xs font-bold rounded-lg transition text-gray-500">Ù…Ù„Ù /
                                Ù…Ø¬Ù„Ø¯</button>
                        </div>

                        <div>
                            <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <input type="text" id="linkName" required
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 outline-none dark:text-white"
                                placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ùˆ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙˆØ±">
                        </div>

                        <!-- Link Input -->
                        <div id="wrapperLink">
                            <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„Ø±Ø§Ø¨Ø· (URL)</label>
                            <input type="url" id="linkUrl"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 outline-none dark:text-white"
                                placeholder="https://docs.google.com/...">
                        </div>

                        <!-- File Workflow -->
                        <div id="wrapperFile" class="hidden space-y-4">
                            <div
                                class="flex items-center gap-4 bg-blue-50/50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-800">
                                <span class="text-xs font-bold text-blue-600 dark:text-blue-400">ØªÙˆØ¹ Ø§Ù„Ø±ÙØ¹:</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="uploadType" value="file" checked
                                        onchange="toggleUploadInput()" class="accent-palette-primary">
                                    <span class="text-xs dark:text-gray-300">Ù…Ù„Ù Ø¹Ø§Ø¯ÙŠ</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="uploadType" value="folder" onchange="toggleUploadInput()"
                                        class="accent-palette-primary">
                                    <span class="text-xs dark:text-gray-300">Ù…Ø¬Ù„Ø¯ Ù…Ù„ÙØ§Øª</span>
                                </label>
                            </div>

                            <div class="relative">
                                <label class="block text-sm font-bold dark:text-gray-300 mb-2">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                                <div id="fileInputContainer"
                                    class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-2xl p-6 text-center hover:border-palette-primary transition cursor-pointer group"
                                    onclick="document.getElementById(getCurrentFileInputId()).click()">
                                    <i
                                        class="fas fa-cloud-upload-alt text-3xl text-gray-300 group-hover:text-palette-primary mb-2"></i>
                                    <p class="text-xs text-gray-400" id="fileStatus">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
                                        2GB)</p>
                                    <input type="file" id="linkFileInput" class="hidden"
                                        onchange="handleFileSelected(this)">
                                    <input type="file" id="linkFolderInput" class="hidden" webkitdirectory directory
                                        multiple onchange="handleFileSelected(this)">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="linkDesc"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 outline-none dark:text-white h-24"
                                placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹ Ù„Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø·..."></textarea>
                        </div>
                        <button type="submit"
                            class="w-full bg-palette-sidebar dark:bg-palette-primary text-white font-bold py-3 rounded-xl shadow-lg">Ø­ÙØ¸
                            ÙˆÙ…Ø´Ø§Ø±ÙƒØ©</button>
                    </form>
                </div>
            </div>

            <!-- PAGE 7: TEAM (Dynamic) -->
            <div id="team" class="page-section hidden-section p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-palette-sidebar dark:text-white">Ø¹Ø§Ø¦Ù„Ø© Ø­ÙŠØ§Ø©</h2>
                        <p class="text-sm text-gray-500">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆØ§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù„Ù„Ø¹Ù…Ù„</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø²Ù…ÙŠÙ„..."
                            class="bg-white dark:bg-gray-800 border border-palette-border rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 ring-palette-primary">
                    </div>
                </div>

                <div id="teamGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>

            <!-- PAGE 8: SETTINGS -->
            <div id="settings" class="page-section hidden-section p-8">
                <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-8">

                    <!-- Settings Sidebar -->
                    <div class="space-y-2">
                        <button onclick="switchSettingsTab('account')" id="tab-account"
                            class="w-full text-right px-4 py-3 rounded-xl bg-palette-sidebar text-white font-bold text-sm transition shadow-md flex items-center gap-3">
                            <i class="fas fa-user-circle"></i> Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ
                        </button>
                        <button onclick="switchSettingsTab('security')" id="tab-security"
                            class="w-full text-right px-4 py-3 rounded-xl hover:bg-white dark:hover:bg-gray-800 transition text-sm text-gray-600 dark:text-gray-300 flex items-center gap-3">
                            <i class="fas fa-shield-alt"></i> Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©
                        </button>
                        <button onclick="switchSettingsTab('notifications')" id="tab-notifications"
                            class="w-full text-right px-4 py-3 rounded-xl hover:bg-white dark:hover:bg-gray-800 transition text-sm text-gray-600 dark:text-gray-300 flex items-center gap-3">
                            <i class="fas fa-bell"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
                        </button>
                    </div>

                    <!-- Settings Content -->
                    <div class="md:col-span-3">

                        <!-- TAB: ACCOUNT -->
                        <div id="settings-account" class="settings-tab-content space-y-6">
                            <div
                                class="bg-white dark:bg-palette-darkPanel rounded-3xl p-8 border border-palette-border shadow-sm">
                                <div
                                    class="flex items-center gap-6 mb-8 pb-8 border-b border-gray-50 dark:border-gray-700">
                                    <div class="relative group">
                                        <div id="settingsAvatar"
                                            class="w-24 h-24 rounded-3xl bg-gray-100 overflow-hidden flex items-center justify-center text-3xl font-bold text-white shadow-inner">
                                        </div>
                                        <label
                                            class="absolute -bottom-2 -left-2 bg-palette-primary text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer border-4 border-white hover:bg-blue-600 transition">
                                            <i class="fas fa-camera text-xs"></i>
                                            <input type="file" class="hidden" onchange="uploadAvatar(event)">
                                        </label>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-xl dark:text-white" id="settingsNameLabel">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
                                        </h3>
                                        <p class="text-sm text-gray-400" id="settingsRoleLabel">Ø§Ù„Ù…Ù†ØµØ¨ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Ø§Ù„Ø§Ø³Ù…
                                            Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                        <input type="text" id="settingsName" onchange="updateProfile()"
                                            class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-xl p-3 text-sm focus:ring-2 ring-palette-primary dark:text-white transition">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Ø§Ù„Ø¨Ø±ÙŠØ¯
                                            Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                        <input type="email" id="settingsEmail" disabled
                                            class="w-full bg-gray-100 dark:bg-gray-900 border-none rounded-xl p-3 text-sm text-gray-400 cursor-not-allowed">
                                    </div>
                                </div>

                                <div
                                    class="mt-8 pt-8 border-t border-gray-50 dark:border-gray-700 flex items-center justify-between">
                                    <div>
                                        <p class="font-bold text-sm dark:text-white">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark Mode)</p>
                                        <p class="text-xs text-gray-400">ØªØºÙŠÙŠØ± Ù…Ø¸Ù‡Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±ÙŠØ­ Ù„Ù„Ø¹ÙŠÙ†</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()"
                                            class="sr-only peer">
                                        <div
                                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-palette-primary">
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: SECURITY (New) -->
                        <div id="settings-security" class="settings-tab-content hidden space-y-6">
                            <div
                                class="bg-white dark:bg-palette-darkPanel rounded-3xl p-8 border border-palette-border shadow-sm">
                                <h3 class="font-bold text-lg dark:text-white mb-6 border-b pb-4 dark:border-gray-700"><i
                                        class="fas fa-lock text-green-500 ml-2"></i> ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                                <div class="space-y-4 max-w-md">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                                            Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                                        <input type="password"
                                            class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 outline-none focus:border-green-500 transition">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                                            Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                                        <input type="password"
                                            class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 outline-none focus:border-green-500 transition">
                                    </div>
                                    <button
                                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition"
                                        onclick="Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success')">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø©
                                        Ø§Ù„Ù…Ø±ÙˆØ±</button>
                                </div>

                                <div class="mt-8 pt-8 border-t border-gray-100 dark:border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-bold text-md dark:text-white">Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© (2FA)</h4>
                                            <p class="text-xs text-gray-400">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ† Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ù…Ø§Ù†</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer"
                                                onchange="toggleSetting(this, 'Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©')">
                                            <div
                                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500">
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: NOTIFICATIONS (New) -->
                        <div id="settings-notifications" class="settings-tab-content hidden space-y-6">
                            <div
                                class="bg-white dark:bg-palette-darkPanel rounded-3xl p-8 border border-palette-border shadow-sm">
                                <h3 class="font-bold text-lg dark:text-white mb-6 border-b pb-4 dark:border-gray-700"><i
                                        class="fas fa-bell text-yellow-500 ml-2"></i> ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>

                                <div class="space-y-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500">
                                                <i class="fas fa-envelope"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-sm dark:text-white">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                                                </p>
                                                <p class="text-xs text-gray-400">Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù„Ø®Øµ Ø§Ø³Ø¨ÙˆØ¹ÙŠ ÙˆØ±Ø³Ø§Ø¦Ù„ Ù…Ù‡Ù…Ø©</p>
                                            </div>
                                        </div>
                                        <input type="checkbox" checked class="accent-blue-500 w-5 h-5 cursor-pointer"
                                            onchange="toggleSetting(this, 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯')">
                                    </div>

                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-500">
                                                <i class="fas fa-desktop"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-sm dark:text-white">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                                                <p class="text-xs text-gray-400">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
                                            </div>
                                        </div>
                                        <input type="checkbox" checked class="accent-purple-500 w-5 h-5 cursor-pointer"
                                            onchange="toggleSetting(this, 'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…')">
                                    </div>

                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-500">
                                                <i class="fas fa-volume-up"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-sm dark:text-white">Ø§Ù„Ø£ØµÙˆØ§Øª</p>
                                                <p class="text-xs text-gray-400">ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
                                            </div>
                                        </div>
                                        <input type="checkbox" class="accent-red-500 w-5 h-5 cursor-pointer"
                                            onchange="toggleSetting(this, 'Ø§Ù„Ø£ØµÙˆØ§Øª')">
                                    </div>

                                    <div class="mt-8 pt-4 border-t border-gray-100 dark:border-gray-700 text-left">
                                        <button class="text-xs text-gray-400 hover:text-red-500 underline"
                                            onclick="Swal.fire('ØªÙ…', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', 'info')">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                            Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
    </div>



    </main>
    </div>

    <!-- MODAL: ADD TASK (Same) -->
    <!-- MODAL: ADD TASK (Improved) -->
    <div id="actionModal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm"
        onclick="if(event.target === this) closeModal('actionModal')">
        <div
            class="bg-white dark:bg-palette-darkPanel w-full max-w-lg rounded-2xl p-8 relative shadow-2xl transform transition-all scale-100 opacity-100">
            <button onclick="closeModal('actionModal')"
                class="absolute top-4 left-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h3 id="modalTitleText"
                class="text-xl font-bold text-palette-sidebar dark:text-white mb-6 flex items-center gap-2">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©
                Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <form onsubmit="addTask(event)" class="space-y-4">
                <input type="hidden" id="taskEditId" value="">
                <div>
                    <label class="block text-sm font-bold dark:text-gray-300">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                    <input type="text" id="taskTitle" required
                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 outline-none dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="taskDetails" rows="2"
                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 outline-none dark:text-white"
                        placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold dark:text-gray-300">Ø¥Ø³Ù†Ø§Ø¯ Ø¥Ù„Ù‰</label>
                        <select id="assignTo"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                        <select id="taskPriority"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                            <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                            <option value="medium">Ù…ØªÙˆØ³Ø·Ø©</option>
                            <option value="normal" selected>Ø¹Ø§Ø¯ÙŠØ©</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="taskDate"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold dark:text-gray-300">Ø§Ù„ÙˆÙ‚Øª</label>
                        <input type="time" id="taskTime"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 dark:text-white">
                    </div>
                </div>

                <button type="submit" id="saveTaskBtn"
                    class="w-full bg-palette-sidebar dark:bg-palette-primary text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-95">Ø­ÙØ¸
                    Ø§Ù„Ù…Ù‡Ù…Ø©</button>
            </form>
        </div>
    </div>

    <!-- NEW COLUMN TYPE MENU (Hidden) -->
    <div id="columnTypeMenu"
        class="fixed top-0 left-0 bg-white dark:bg-palette-darkPanel shadow-2xl rounded-xl border border-gray-200 dark:border-gray-700 w-[320px] z-[100] hidden flex flex-col transform scale-95 opacity-0 transition-all duration-200 origin-top-right">
        <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 rounded-t-xl">
            <input type="text" placeholder="...Search column type"
                class="w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 ring-blue-500 transition shadow-inner">
        </div>

        <div class="p-4 overflow-y-auto max-h-[400px]">
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider border-b border-gray-100 pb-2">
                Basic Columns</h4>
            <div class="grid grid-cols-4 gap-4 mb-8">
                <!-- Dropdown -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('dropdown')">
                    <div
                        class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-caret-square-down text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Dropdown</span>
                </div>
                <!-- Text -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('text')">
                    <div
                        class="w-12 h-12 rounded-full bg-yellow-400 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-font text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Text</span>
                </div>
                <!-- Rating -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('rating')">
                    <div
                        class="w-12 h-12 rounded-full bg-yellow-500 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-star text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Rating</span>
                </div>
                <!-- Check -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('check')">
                    <div
                        class="w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-check-square text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Check</span>
                </div>
            </div>

            <h4 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider border-b border-gray-100 pb-2">
                Advanced</h4>
            <div class="grid grid-cols-4 gap-4">
                <!-- Formula -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('formula')">
                    <div
                        class="w-12 h-12 rounded-full bg-purple-600 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-calculator text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Formula</span>
                </div>
                <!-- Priority -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('priority')">
                    <div
                        class="w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Priority</span>
                </div>
                <!-- Link -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('link')">
                    <div
                        class="w-12 h-12 rounded-full bg-indigo-500 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-link text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Link</span>
                </div>
                <!-- Doc -->
                <div class="flex flex-col items-center gap-2 cursor-pointer group hover:bg-gray-50 p-2 rounded-xl transition"
                    onclick="itemMenuAction('doc')">
                    <div
                        class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition transform">
                        <i class="fas fa-file-alt text-xl"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">Doc</span>
                </div>
            </div>
        </div>

        <script>
            // --- GLOBAL STATE ---
            var API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? `http://${window.location.hostname}:5001/api`
                : `https://hayat-api.onrender.com/api`; // Ø§Ø±ÙØ¹ÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ Ø¹Ù„Ù‰ Ø±ÙŠÙ†Ø¯Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ØºÙŠØ±ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§
            var USERS = {
                'ghada@hyat.co': { email: 'ghada@hyat.co', pass: '1111', name: 'Ø£. ØºØ§Ø¯Ø©', role: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', type: 'gm', color: '#e57e5d', avatar: null, status: 'online' },
                'lina@hyat.co': { email: 'lina@hyat.co', pass: '2222', name: 'Ø£. Ù„ÙŠÙ†Ø§', role: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', type: 'pm', color: '#7baded', avatar: null, status: 'offline' },
                'norah@hyat.co': { email: 'norah@hyat.co', pass: '3333', name: 'Ù…. Ù†ÙˆØ±Ø©', role: 'Tech Lead', type: 'tech', color: '#ceaed2', avatar: null, status: 'online' }
            };
            var usersDB = USERS;
            var currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            var tasksDB = JSON.parse(localStorage.getItem('tasks_v5')) || [];
            var activeChatUser = null;
            var globalMessages = [];
            var lastMsgCount = 0;
            var currentTaskFilter = 'all';
            var currentTaskMember = null;
            var calendarEvents = JSON.parse(localStorage.getItem('cal_events')) || [];
            var currentCalDate = new Date();
            var terminalInterval;

            // Normalize and Save
            tasksDB = tasksDB.map(t => {
                if (!t.id) t.id = Date.now() + Math.random();
                if (!t.status) t.status = 'pending';
                if (!t.type) t.type = 'dev';
                if (!t.priority) t.priority = 'medium';
                const updated = { ...t };
                const target = (t.assigned_to || t.to || '').toLowerCase();
                const sender = (t.from || '').toLowerCase();
                updated.assigned_to = target;
                updated.from = sender;
                if (t.date && !t.taskDate) updated.taskDate = t.date;
                return updated;
            });
            localStorage.setItem('tasks_v5', JSON.stringify(tasksDB));

            // Case-insensitive user lookup helper
            function getUser(email) {
                if (!email) return null;
                const e = email.toLowerCase();
                return USERS[e] || Object.values(USERS).find(u => (u.email || '').toLowerCase() === e);
            }

            const DAILY_MESSAGES = [
                { verse: "ÙˆÙØ£ÙÙ† Ù„ÙÙ‘ÙŠÙ’Ø³Ù Ù„ÙÙ„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù…ÙØ§ Ø³ÙØ¹ÙÙ‰Ù°", quote: "Ø¨Ø¯Ø§ÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ù„Ù‡Ù…Ø©!" },
                { verse: "ÙˆÙÙ‚ÙÙ„Ù Ø§Ø¹Ù’Ù…ÙÙ„ÙÙˆØ§ ÙÙØ³ÙÙŠÙØ±ÙÙ‰ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø¹ÙÙ…ÙÙ„ÙÙƒÙÙ…Ù’", quote: "ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ØŒ ÙØ±Øµ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ù†Ø¬Ø§Ø²." },
                { verse: "Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ­ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ù…ÙØ­Ù’Ø³ÙÙ†ÙÙŠÙ†Ù", quote: "Ø§Ù„Ø¥ØªÙ‚Ø§Ù† Ù‡Ùˆ Ø³Ø± Ø§Ù„ØªÙ…ÙŠØ²ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø¹Ø·Ø§Ø¦Ùƒ." },
                { verse: "ÙÙØ¥ÙØ°ÙØ§ Ø¹ÙØ²ÙÙ…Ù’ØªÙ ÙÙØªÙÙˆÙÙƒÙÙ‘Ù„Ù’ Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù„ÙÙ‘Ù‡Ù", quote: "Ù…Ù†ØªØµÙ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŒ Ø¬Ø¯Ø¯ Ù†ÙŠØªÙƒ ÙˆØ·Ø§Ù‚ØªÙƒ." },
                { verse: "ÙˆÙØ¨ÙØ´ÙÙ‘Ø±Ù Ø§Ù„ØµÙÙ‘Ø§Ø¨ÙØ±ÙÙŠÙ†Ù", quote: "ÙƒÙ„ Ø¬Ù‡Ø¯ ØªØ¨Ø°Ù„Ù‡ Ø§Ù„ÙŠÙˆÙ… Ø³ØªØ­ØµØ¯ Ø«Ù…Ø§Ø±Ù‡ ØºØ¯Ø§Ù‹." },
                { verse: "ÙˆÙÙˆØ¬ÙØ¹ÙÙ„Ù’Ù†ÙØ§ Ù†ÙÙˆÙ’Ù…ÙÙƒÙÙ…Ù’ Ø³ÙØ¨ÙØ§ØªÙ‹Ø§", quote: "Ø¬Ù…Ø¹Ø© Ù…Ø¨Ø§Ø±ÙƒØ©ØŒ ÙˆÙ‚Øª Ù„Ù„Ø±Ø§Ø­Ø© ÙˆØ´Ø­Ù† Ø§Ù„Ø·Ø§Ù‚Ø©." },
                { verse: "ÙÙØ¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§", quote: "Ø§Ø³ØªØ¹Ø¯ Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø­Ø§ÙÙ„ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª." }
            ];

            const DEFAULT_TASKS = [
                { id: 1, title: 'Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Q1', from: 'System', assigned_to: 'ghada@hyat.co', type: 'manage', priority: 'high', status: 'pending', taskDate: '2026-02-01' },
                { id: 2, title: 'ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', from: 'ghada@hyat.co', assigned_to: 'lina@hyat.co', type: 'design', priority: 'medium', status: 'pending', taskDate: '2026-02-02' },
                { id: 3, title: 'Deployment: v2.4.0 Production', from: 'lina@hyat.co', assigned_to: 'norah@hyat.co', type: 'dev', priority: 'high', status: 'pending', taskDate: '2026-02-03' }
            ];
            const PROJECTS = [
                { name: "ØªØ·ÙˆÙŠØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ", progress: 75, status: "Active" },
                { name: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©", progress: 40, status: "Delayed" },
                { name: "Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ù„Ø±Ù…Ø¶Ø§Ù†", progress: 10, status: "Planning" }
            ];

            window.onload = function () {
                if (localStorage.getItem('theme') === 'dark') { document.documentElement.classList.add('dark'); document.getElementById('darkModeSwitch').checked = true; }

                if (currentUser && currentUser.email) {
                    const dbUser = getUser(currentUser.email);
                    if (dbUser) {
                        currentUser = { ...currentUser, ...dbUser, email: currentUser.email.toLowerCase() };
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }

                    document.getElementById('loginScreen').classList.add('hidden-section');
                    document.getElementById('mainDashboard').classList.remove('hidden-section');
                    initSystem();
                } else { document.getElementById('loginScreen').classList.remove('hidden-section'); }
            };

            function toggleDarkMode() {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                const sw = document.getElementById('darkModeSwitch'); if (sw) sw.checked = isDark;
            }

            function handleLogin(e) {
                e.preventDefault();
                const emInput = document.getElementById('emailInput').value.trim();
                const pw = document.getElementById('passwordInput').value.trim();

                // Case-insensitive lookup
                const em = emInput.toLowerCase();
                const user = getUser(em);

                if (user && (user.pass === pw || pw === 'admin')) {
                    // Save clean lowercase email
                    currentUser = { email: em, ...user };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    location.reload();
                } else { Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„', text: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', confirmButtonColor: '#e57e5d' }); }
            }
            function logout() { sessionStorage.removeItem('currentUser'); location.reload(); }

            function initSystem() {
                document.getElementById('welcomeName').innerText = currentUser.name;
                document.getElementById('userNameDisplay').innerText = currentUser.name;
                document.getElementById('userRoleDisplay').innerText = currentUser.role;

                // --- DATE & MESSAGE LOGIC ---
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                const today = new Date();
                const dateStr = `ğŸ“… ${days[today.getDay()]}ØŒ ${today.getDate()} ${months[today.getMonth()]} ${today.getFullYear()}`;

                // Insert or Update Date Badge
                const container = document.querySelector('#dashboard .bg-gradient-to-r .relative');
                let dateEl = document.getElementById('dateBadge');
                if (!dateEl && container) {
                    dateEl = document.createElement('div');
                    dateEl.id = 'dateBadge';
                    dateEl.className = 'inline-block bg-white/20 backdrop-blur-md rounded-lg px-3 py-1 text-sm font-bold text-blue-100 mb-4 border border-white/10';
                    container.insertBefore(dateEl, container.children[1]); // Insert after title
                }
                if (dateEl) dateEl.innerText = dateStr;

                // Set Verse & Quote
                const dayIdx = today.getDay();
                if (DAILY_MESSAGES[dayIdx]) {
                    document.getElementById('quranVerse').innerText = `"${DAILY_MESSAGES[dayIdx].verse}"`;
                    document.getElementById('dailyQuote').innerText = DAILY_MESSAGES[dayIdx].quote;
                }

                // --- RENDERING ---
                renderUserAvatar(currentUser, 'sidebarAvatar');
                renderUserAvatar(currentUser, 'settingsAvatar');
                document.getElementById('settingsName').value = currentUser.name;
                document.getElementById('settingsEmail').value = currentUser.email;

                buildMenu();
                buildDashboard();
                renderTasks();
                renderProjects();
                renderCalendar();
                renderTeam();
                initCharts();

                if (currentUser.type === 'tech') startTerminal();

                // Force show Dashboard to avoid black screen
                showPage('dashboard', document.querySelector('a[onclick*="dashboard"]'));
            }

            function renderUserAvatar(user, domId) {
                const el = document.getElementById(domId); if (!el) return;
                if (user.avatar) { el.innerHTML = `<img src="${user.avatar}" class="avatar-img">`; el.style.backgroundColor = 'transparent'; el.innerText = ''; }
                else { el.innerHTML = user.name.charAt(0); el.style.backgroundColor = user.color; el.innerText = user.name.charAt(0); }
            }

            function uploadAvatar(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64 = e.target.result;
                    currentUser.avatar = base64; usersDB[currentUser.email].avatar = base64;
                    localStorage.setItem('users_db_v1', JSON.stringify(usersDB));
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    renderUserAvatar(currentUser, 'sidebarAvatar'); renderUserAvatar(currentUser, 'settingsAvatar');
                    Swal.fire({ icon: 'success', title: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©', timer: 1000, showConfirmButton: false });
                }; reader.readAsDataURL(file);
            }

            function updateProfile() {
                const newName = document.getElementById('settingsName').value;
                if (newName) {
                    currentUser.name = newName; usersDB[currentUser.email].name = newName;
                    localStorage.setItem('users_db_v1', JSON.stringify(usersDB));
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('userNameDisplay').innerText = newName;
                    document.getElementById('welcomeName').innerText = newName;
                    Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…', 'success');
                }
            }

            function buildMenu() {
                // No dynamic menu items for now
            }

            // --- DASHBOARD DYNAMIC HELPERS ---
            function getWorkloadHtml() {
                let html = `
                <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl border border-palette-border dark:border-palette-darkBorder shadow-sm transition hover:shadow-md">
                    <h3 class="font-bold dark:text-white mb-6 flex items-center gap-2">âš–ï¸ ØªÙˆØ²ÙŠØ¹ Ø£Ø­Ù…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ (Team Workload)</h3>
                    <div class="space-y-6">`;

                const members = Object.values(USERS).filter(u => u.type !== 'gm');
                members.forEach(u => {
                    const totalPending = (tasksDB || []).filter(t => t.assigned_to === u.email && t.status === 'pending').length;
                    const maxCapacity = 5;
                    const percentage = Math.min(100, Math.round((totalPending / maxCapacity) * 100));

                    const colorClass = percentage > 85 ? 'bg-red-400' : (percentage > 60 ? 'bg-yellow-400' : 'bg-green-500');
                    const textClass = percentage > 85 ? 'text-red-500' : (percentage > 60 ? 'text-yellow-600' : 'text-green-600');

                    html += `
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px] font-bold" style="background-color: ${u.color}">${u.name.charAt(0)}</div>
                                    <span class="dark:text-gray-200 font-medium">${u.name} (${u.role})</span>
                                </span>
                                <span class="${textClass} font-bold">${percentage}%</span>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-3">
                                <div class="${colorClass} h-3 rounded-full relative transition-all duration-1000 overflow-hidden" style="width: ${percentage}%">
                                    ${percentage > 85 ? '<div class="absolute top-0 right-0 w-full h-full bg-white/20 animate-pulse"></div>' : ''}
                                </div>
                            </div>
                            ${percentage > 85 ? `<p class="text-[10px] text-red-500 mt-1 font-bold animate-bounce"><i class="fas fa-exclamation-triangle"></i> Ø¶ØºØ· Ø¹Ù…Ù„ Ù…Ø±ØªÙØ¹</p>` : ''}
                        </div>`;
                });
                html += `</div></div>`;
                return html;
            }

            function getUpcomingDeadlinesHtml() {
                const priorityScore = { 'high': 3, 'medium': 2, 'low': 1 };
                const upcoming = (tasksDB || [])
                    .filter(t => t.status === 'pending' && t.taskDate)
                    .sort((a, b) => {
                        const dateA = new Date(a.taskDate);
                        const dateB = new Date(b.taskDate);
                        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                        return (priorityScore[b.priority] || 0) - (priorityScore[a.priority] || 0);
                    })
                    .slice(0, 3);

                let content = '';
                if (upcoming.length === 0) {
                    content = '<p class="text-sm text-gray-400 text-center py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù‚Ø±ÙŠØ¨Ø©</p>';
                } else {
                    content = '<div class="relative border-r-2 border-gray-100 dark:border-gray-700 mr-3 space-y-8">';
                    upcoming.forEach(t => {
                        const deadline = new Date(t.taskDate);
                        deadline.setHours(0, 0, 0, 0);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const diff = (deadline - today) / (1000 * 60 * 60 * 24);

                        let dateDesc = '';
                        if (diff === 0) dateDesc = 'Ø§Ù„ÙŠÙˆÙ…';
                        else if (diff === 1) dateDesc = 'ØºØ¯Ø§Ù‹';
                        else if (diff === 2) dateDesc = 'Ø¨Ø¹Ø¯ ØºØ¯';
                        else if (diff > 0) dateDesc = `Ø¨Ø¹Ø¯ ${Math.ceil(diff)} Ø£ÙŠØ§Ù…`;
                        else dateDesc = `Ù…Ù†Ø° ${Math.abs(Math.floor(diff))} Ø£ÙŠØ§Ù… (Ù…ØªØ£Ø®Ø±)`;

                        const dotColor = t.priority === 'high' ? 'bg-red-500' : (t.priority === 'medium' ? 'bg-yellow-400' : 'bg-blue-400');
                        const titleColor = t.priority === 'high' ? 'text-red-500' : 'dark:text-white';

                        content += `
                            <div class="relative pr-6">
                                <div class="absolute -right-[9px] top-1 w-4 h-4 rounded-full ${dotColor} border-4 border-white dark:border-gray-800 shadow-sm"></div>
                                <h4 class="font-bold text-sm ${titleColor}">${t.title}</h4>
                                <p class="text-xs text-gray-400">${t.type.toUpperCase()} â€¢ ${dateDesc}</p>
                            </div>`;
                    });
                    content += '</div>';
                }

                return `
                <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl border border-palette-border dark:border-palette-darkBorder shadow-sm transition hover:shadow-md">
                     <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold dark:text-white flex items-center gap-2">â³ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù‚Ø§Ø¯Ù…Ø©</h3>
                        <button onclick="showPage('tasks')" class="text-[10px] bg-gray-50 dark:bg-gray-800 text-gray-400 px-3 py-1 rounded-full hover:bg-palette-primary hover:text-white transition">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
                     </div>
                     ${content}
                </div>`;
            }

            function getAssignedTasksHtml(email) {
                const priorityScore = { 'high': 3, 'medium': 2, 'low': 1 };
                const assigned = (tasksDB || [])
                    .filter(t => t.assigned_to === email && t.status === 'pending')
                    .sort((a, b) => (priorityScore[b.priority] || 0) - (priorityScore[a.priority] || 0))
                    .slice(0, 3);

                let content = '';
                if (assigned.length === 0) {
                    content = '<p class="text-sm text-gray-400 text-center py-6 font-medium">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø³Ù†Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                } else {
                    content = '<div class="relative border-r-2 border-dashed border-palette-primary/30 mr-3 space-y-8">';
                    assigned.forEach(t => {
                        const sender = getUser(t.from);
                        const senderName = sender ? sender.name : 'Ø§Ù„Ù†Ø¸Ø§Ù…';
                        const color = t.priority === 'high' ? 'bg-red-500' : 'bg-palette-primary';

                        content += `
                            <div class="relative pr-8">
                                <div class="absolute -right-[13px] top-0 w-6 h-6 rounded-full ${color} text-white flex items-center justify-center text-[10px] shadow-lg animate-pulse">
                                    <i class="fas ${t.priority === 'high' ? 'fa-bolt' : 'fa-thumbtack'}"></i>
                                </div>
                                <h4 class="font-bold text-sm dark:text-white">${t.title}</h4>
                                <p class="text-xs text-palette-primary mt-1 font-bold">Ø¨ÙˆØ§Ø³Ø·Ø©: ${senderName}</p>
                            </div>`;
                    });
                    content += '</div>';
                }

                return `
                <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl border border-palette-primary/20 dark:border-palette-darkBorder shadow-sm transition hover:shadow-md relative overflow-hidden">
                     <div class="absolute top-0 left-0 w-1.5 h-full bg-palette-primary"></div>
                     <h3 class="font-bold dark:text-white mb-6 flex items-center gap-2">ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙ‘ (My Pipeline)</h3>
                     ${content}
                </div>`;
            }

            function buildDashboard() {
                const c = document.getElementById('dashboardContent');
                if (!c) return;
                c.innerHTML = '';

                if (currentUser.type === 'gm') {
                    c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl shadow-sm border border-palette-border dark:border-palette-darkBorder">
                            <div class="flex justify-between items-start">
                                 <div><h3 class="text-xs font-bold text-gray-400">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Q1)</h3><p class="text-3xl font-bold text-palette-primary mt-2">1.2M <span class="text-sm text-green-500">â–² 12%</span></p></div>
                                 <div class="p-3 bg-orange-100 rounded-lg text-palette-primary"><i class="fas fa-wallet text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl shadow-sm border border-palette-border dark:border-palette-darkBorder">
                             <div class="flex justify-between items-start">
                                 <div><h3 class="text-xs font-bold text-gray-400">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</h3><p class="text-3xl font-bold text-green-600 mt-2">98% <span class="text-sm text-gray-400">- 0%</span></p></div>
                                 <div class="p-3 bg-green-100 rounded-lg text-green-600"><i class="fas fa-users text-xl"></i></div>
                            </div>
                        </div>
                         <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl shadow-sm border border-palette-border dark:border-palette-darkBorder">
                             <div class="flex justify-between items-start">
                                 <div><h3 class="text-xs font-bold text-gray-400">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠØ©</h3><p class="text-3xl font-bold text-palette-purple mt-2">${tasksDB.length} <span class="text-sm text-palette-purple">Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</span></p></div>
                                 <div class="p-3 bg-purple-100 rounded-lg text-palette-purple"><i class="fas fa-tasks text-xl"></i></div>
                            </div>
                        </div>

                        ${getWorkloadHtml()}
                        ${getUpcomingDeadlinesHtml()}

                        <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-2xl border border-palette-border dark:border-palette-darkBorder">
                            <h3 class="font-bold border-b border-gray-100 dark:border-gray-700 pb-4 mb-4 dark:text-white"><i class="fas fa-bullhorn text-palette-primary ml-2"></i> ØªØ¹Ù…ÙŠÙ… Ø¥Ø¯Ø§Ø±ÙŠ</h3>
                            <div class="flex gap-4">
                                <input type="text" id="announcementInput" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù…ÙŠÙ…Ø§Ù‹..." class="flex-1 bg-gray-50 dark:bg-gray-800 border-none rounded-xl p-4 focus:ring-2 focus:ring-palette-primary text-sm dark:text-white">
                                <button onclick="postAnnouncement()" class="bg-palette-sidebar text-white px-6 rounded-xl font-bold hover:bg-gray-900 transition flex items-center gap-2 text-sm"><i class="fas fa-paper-plane"></i> Ù†Ø´Ø±</button>
                            </div>
                        </div>
                    </div>`;
                }
                else if (currentUser.type === 'pm') {
                    c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        ${getWorkloadHtml()}
                        ${getUpcomingDeadlinesHtml()}
                    </div>`;
                }
                else {
                    c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${getAssignedTasksHtml(currentUser.email)}
                        ${getWorkloadHtml()}
                        ${getUpcomingDeadlinesHtml()}
                        
                        <div class="md:col-span-3 bg-[#1e1b1c] p-6 rounded-2xl text-white shadow-xl border border-gray-800/50">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold flex items-center gap-2"><i class="fas fa-server text-palette-primary"></i> Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…ØªØµÙ„Ø© (System Resources)</h3>
                                <span class="text-[10px] bg-green-500/20 text-green-400 px-3 py-1 rounded-full border border-green-500/20 animate-pulse">Live Connections</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 font-mono">
                                <div>
                                    <div class="flex justify-between mb-2 text-xs text-gray-400 uppercase tracking-tighter"><span>CPU Performance</span> <span>42%</span></div>
                                    <div class="w-full bg-gray-800 rounded-full h-1.5"><div class="bg-palette-primary h-1.5 rounded-full" style="width: 42%"></div></div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2 text-xs text-gray-400 uppercase tracking-tighter"><span>RAM Availability</span> <span>12.4GB</span></div>
                                    <div class="w-full bg-gray-800 rounded-full h-1.5"><div class="bg-palette-secondary h-1.5 rounded-full" style="width: 78%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                renderAnnouncementBanner();
            }

            // --- ANNOUNCEMENT LOGIC ---
            function postAnnouncement() {
                const txt = document.getElementById('announcementInput').value.trim();
                if (txt) {
                    localStorage.setItem('sys_announcement', JSON.stringify({ text: txt, from: currentUser.name, date: new Date().toLocaleDateString('ar-SA') }));
                    document.getElementById('announcementInput').value = '';
                    renderAnnouncementBanner();
                    Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¢Ù†', 'success');
                }
            }

            function renderAnnouncementBanner() {
                const bannerId = 'announcementBanner';
                const existing = document.getElementById(bannerId);
                if (existing) existing.remove();

                const ann = JSON.parse(localStorage.getItem('sys_announcement'));
                if (ann && ann.text) {
                    const div = document.createElement('div');
                    div.id = bannerId;
                    div.className = 'bg-gradient-to-r from-palette-sidebar to-palette-primary text-white text-sm py-2 px-8 flex justify-between items-center shadow-inner mb-4 rounded-xl mx-8 mt-4';
                    div.innerHTML = `
                    <div class="flex items-center gap-2"><i class="fas fa-bullhorn animate-pulse"></i> <span><strong class="mx-1">${ann.from}:</strong> ${ann.text}</span> <span class="text-[10px] opacity-70 border px-1 rounded mx-2">${ann.date}</span></div>
                    ${currentUser.type === 'gm' ? '<button onclick="deleteAnnouncement()" class="hover:text-red-200"><i class="fas fa-trash-alt"></i></button>' : ''}
                `;
                    // Insert after Header, before Page Sections
                    const header = document.querySelector('header');
                    header.parentNode.insertBefore(div, header.nextSibling);
                }
            }

            function deleteAnnouncement() {
                localStorage.removeItem('sys_announcement');
                renderAnnouncementBanner();
            }

            // --- RENDERERS ---
            function renderTeam() {
                const grid = document.getElementById('teamGrid');
                if (!grid) return;
                grid.innerHTML = '';

                // Add "New Member" Card (Fake)
                const addBtn = document.createElement('div');
                addBtn.className = "bg-gray-50 dark:bg-gray-800/50 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl flex flex-col items-center justify-center p-6 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition group min-h-[250px]";
                addBtn.onclick = () => Swal.fire('Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'info');
                addBtn.innerHTML = `
                <div class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-400 group-hover:text-blue-500 transition mb-4">
                    <i class="fas fa-plus text-2xl"></i>
                </div>
                <h3 class="font-bold text-gray-500 dark:text-gray-400 group-hover:text-blue-500">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</h3>
            `;
                grid.appendChild(addBtn);

                Object.values(usersDB).forEach(u => {
                    // Filter out current user from seeing themselves if preferred, 
                    // or just show everyone with a badge.
                    const isMe = currentUser && u.email === currentUser.email;

                    const uStatus = u.status || 'offline';
                    const statusDot = uStatus === 'online' ? 'bg-green-500' : 'bg-gray-400';

                    let avatarHtml = u.avatar ?
                        `<img src="${u.avatar}" class="w-full h-full object-cover">` :
                        `<div class="w-full h-full flex items-center justify-center text-3xl font-bold text-white relative z-10" style="background-color: ${u.color || '#ccc'}">${u.name.charAt(0)}</div>`;

                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-palette-darkPanel p-6 rounded-2xl shadow-sm border border-palette-border dark:border-palette-darkBorder text-center transition hover:shadow-lg relative overflow-hidden group min-h-[250px] flex flex-col items-center justify-between " + (isMe ? 'ring-2 ring-blue-400' : '');
                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-gray-50 to-transparent dark:from-gray-700/30"></div>
                        
                        <div class="relative z-10 w-24 h-24 rounded-full p-1 bg-white dark:bg-gray-800 mb-4 shadow-sm mx-auto">
                            <div class="w-full h-full rounded-full overflow-hidden relative flex items-center justify-center">
                                ${avatarHtml}
                            </div>
                            <span class="absolute bottom-1 right-1 w-4 h-4 rounded-full border-2 border-white dark:border-gray-800 ${statusDot}"></span>
                        </div>
                        
                        <div class="mb-4">
                            <h3 class="font-bold text-xl dark:text-white mb-1 relative z-10">${u.name} ${isMe ? '(Ø£Ù†Øª)' : ''}</h3>
                            <p class="text-xs text-blue-500 font-medium uppercase tracking-wider relative z-10">${u.role}</p>
                        </div>

                        <div class="flex justify-center gap-2 w-full mt-auto relative z-10">
                            <button onclick="showPage('messages'); setTimeout(() => { loadChatUsers(); selectChatUser('${u.email}', '${u.name}'); }, 100)" 
                                    class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2" title="Ù…Ø­Ø§Ø¯Ø«Ø©">
                                <i class="fas fa-comment-dots"></i>
                            </button>
                            <button onclick="Swal.fire('${u.name}', 'ÙØªØ­ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù…Ø¹ ${u.name}', 'info')" 
                                    class="flex-1 bg-teal-50 text-teal-600 hover:bg-teal-600 hover:text-white py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2" title="Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
            function renderProjects() {
                const l = document.getElementById('projectsList'); l.innerHTML = '';
                PROJECTS.forEach(p => {
                    l.innerHTML += `<div class="bg-white dark:bg-palette-darkPanel p-5 rounded-xl border border-palette-border dark:border-palette-darkBorder shadow-sm"><div class="flex justify-between items-center mb-2"><h3 class="font-bold dark:text-white">${p.name}</h3><span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded dark:text-gray-300">${p.status}</span></div><div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2 mb-3"><div class="bg-palette-secondary h-2 rounded-full" style="width: ${p.progress}%"></div></div><div class="flex justify-end"><button onclick="Swal.fire('ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'success')" class="text-sm text-palette-primary font-bold hover:underline">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button></div></div>`;
                });
            }
            function startTerminal() {
                if (terminalInterval) clearInterval(terminalInterval);
                const logs = document.getElementById('terminalLog');
                terminalInterval = setInterval(() => {
                    const msgs = ["> Checking latency... 23ms", "> Syncing DB replicas...", "> Garbage collection started", "> User logged in", "> API Packet received"];
                    const msg = msgs[Math.floor(Math.random() * msgs.length)];
                    const p = document.createElement('p'); p.innerText = msg;
                    logs.appendChild(p); logs.scrollTop = logs.scrollHeight;
                    if (logs.children.length > 20) logs.removeChild(logs.firstChild);
                }, 3000);
            }
            var reportCharts = {};
            function renderReports() {
                if (!document.getElementById('reports')) return;

                const statsContainer = document.getElementById('reportStats');
                const quarterlyContainer = document.getElementById('quarterlyList');
                if (!statsContainer || !quarterlyContainer) return;

                // 1. Calculate Metrics
                const total = tasksDB.length;
                const completed = tasksDB.filter(t => t.status === 'completed').length;
                const pending = total - completed;
                const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

                // 2. Render Stats Cards
                statsContainer.innerHTML = `
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-2xl border border-blue-100 dark:border-blue-800/50">
                        <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</p>
                        <h4 class="text-3xl font-bold dark:text-white mt-2">${total}</h4>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-2xl border border-green-100 dark:border-green-800/50">
                        <p class="text-[10px] font-bold text-green-600 uppercase tracking-widest">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p>
                        <h4 class="text-3xl font-bold dark:text-white mt-2">${completed}</h4>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-6 rounded-2xl border border-orange-100 dark:border-orange-800/50">
                        <p class="text-[10px] font-bold text-orange-600 uppercase tracking-widest">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</p>
                        <h4 class="text-3xl font-bold dark:text-white mt-2">${pending}</h4>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-2xl border border-purple-100 dark:border-purple-800/50">
                        <p class="text-[10px] font-bold text-purple-600 uppercase tracking-widest">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
                        <h4 class="text-3xl font-bold dark:text-white mt-2">${completionRate}%</h4>
                    </div>
                `;

                // 3. Quarterly Grouping
                const quarters = { 'Q1': 0, 'Q2': 0, 'Q3': 0, 'Q4': 0 };
                const quarterNames = { 'Q1': 'Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„ (ÙŠÙ†Ø§ÙŠØ± - Ù…Ø§Ø±Ø³)', 'Q2': 'Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø£Ø¨Ø±ÙŠÙ„ - ÙŠÙˆÙ†ÙŠÙˆ)', 'Q3': 'Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù„Ø« (ÙŠÙˆÙ„ÙŠÙˆ - Ø³Ø¨ØªÙ…Ø¨Ø±)', 'Q4': 'Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø¹ (Ø£ÙƒØªÙˆØ¨Ø± - Ø¯ÙŠØ³Ù…Ø¨Ø±)' };

                tasksDB.forEach(t => {
                    if (t.taskDate) {
                        const m = new Date(t.taskDate).getMonth() + 1;
                        const q = m <= 3 ? 'Q1' : (m <= 6 ? 'Q2' : (m <= 9 ? 'Q3' : 'Q4'));
                        quarters[q]++;
                    }
                });

                quarterlyContainer.innerHTML = '';
                Object.entries(quarters).forEach(([key, count]) => {
                    const qProgress = total > 0 ? (count / total) * 100 : 0;
                    quarterlyContainer.innerHTML += `
                        <div class="group flex items-center justify-between p-4 rounded-2xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-palette-primary/10 text-palette-primary flex items-center justify-center font-bold">${key}</div>
                                <div>
                                    <h4 class="font-bold text-sm dark:text-white">${quarterNames[key]}</h4>
                                    <p class="text-xs text-gray-400">${count} Ù…Ù‡Ù…Ø© Ù…Ø³Ø¬Ù„Ø©</p>
                                </div>
                            </div>
                            <div class="w-32 bg-gray-100 dark:bg-gray-800 h-2 rounded-full overflow-hidden">
                                <div class="bg-palette-primary h-full transition-all duration-1000" style="width: ${qProgress}%"></div>
                            </div>
                        </div>
                    `;
                });

                // 4. Charts Logic
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#eee' : '#555';

                // Monthly Chart Data (Mocking last 3 months based on current Jan/Feb/Mar context)
                const monthlyData = [0, 0, 0];
                tasksDB.forEach(t => {
                    if (t.taskDate) {
                        const m = new Date(t.taskDate).getMonth();
                        if (m === 0) monthlyData[0]++;
                        if (m === 1) monthlyData[1]++;
                        if (m === 2) monthlyData[2]++;
                    }
                });

                // Clear existing if any
                if (reportCharts.bar) reportCharts.bar.destroy();
                if (reportCharts.pie) reportCharts.pie.destroy();

                const barCtx = document.getElementById('barChart');
                if (barCtx) {
                    reportCharts.bar = new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³'],
                            datasets: [{ label: 'Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', data: monthlyData, backgroundColor: '#e57e5d', borderRadius: 8 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { ticks: { color: textColor }, grid: { display: false } }, x: { ticks: { color: textColor }, grid: { display: false } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                const pieCtx = document.getElementById('doughnutChart');
                if (pieCtx) {
                    reportCharts.pie = new Chart(pieCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Ù…ÙƒØªÙ…Ù„', 'Ù…Ø¹Ù„Ù‚'],
                            datasets: [{ data: [completed, pending], backgroundColor: ['#b4c6aa', '#e0d6bd'], borderWidth: 0 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { family: 'Tajawal' } } } }
                        }
                    });
                }
            }
            function initCharts() { renderReports(); }
            let globalCalType = 'shared'; // 'shared' or 'personal'

            window.setCalendarType = function (type) {
                globalCalType = type;
                const btnShared = document.getElementById('calBtnShared');
                const btnPersonal = document.getElementById('calBtnPersonal');
                const title = document.getElementById('calendarTitle');

                if (type === 'shared') {
                    btnShared.className = 'px-4 py-1.5 rounded-lg text-xs font-bold transition bg-white dark:bg-gray-700 shadow-sm text-palette-primary';
                    btnPersonal.className = 'px-4 py-1.5 rounded-lg text-xs font-bold transition text-gray-400';
                    if (title) title.innerText = 'ğŸ—“ï¸ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø´ØªØ±Ùƒ';
                } else {
                    btnPersonal.className = 'px-4 py-1.5 rounded-lg text-xs font-bold transition bg-white dark:bg-gray-700 shadow-sm text-palette-primary';
                    btnShared.className = 'px-4 py-1.5 rounded-lg text-xs font-bold transition text-gray-400';
                    if (title) title.innerText = 'ğŸ‘¤ ØªÙ‚ÙˆÙŠÙ…ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ';
                }
                renderCalendar();
            };

            function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const dashGrid = document.getElementById('dashboardCalendarGrid');
                const monthLabel = document.getElementById('calendarMonth');

                if (!grid && !dashGrid) return;

                const currEmail = (currentUser && currentUser.email) ? currentUser.email.toLowerCase() : '';
                const currName = (currentUser && currentUser.name) ? currentUser.name : '';

                const m = currentCalDate.getMonth();
                const y = currentCalDate.getFullYear();

                if (monthLabel) {
                    const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                    monthLabel.innerText = `${monthNames[m]} ${y}`;
                }

                const lastDay = new Date(y, m + 1, 0).getDate();
                const firstDay = new Date(y, m, 1).getDay(); // 0 for Sunday

                let gridHTML = '';
                let dashHTML = '';

                // Prerender empty slots
                for (let i = 0; i < firstDay; i++) {
                    gridHTML += `<div class="bg-gray-50/10 dark:bg-gray-800/20 border-r border-b dark:border-gray-700 h-28"></div>`;
                    dashHTML += `<div class="bg-gray-50/5 dark:bg-gray-800/10 h-16 rounded-2xl"></div>`;
                }

                for (let d = 1; d <= lastDay; d++) {
                    const dateKey = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                    // Filter items for this day
                    let tasksOnDay = tasksDB.filter(t => t.taskDate === dateKey);
                    let notes = calendarEvents.filter(e => e.date === dateKey);
                    const currentDay = new Date(dateKey);
                    let rmTasksOnDay = roadmapDB.filter(t => {
                        const start = new Date(t.start);
                        const end = new Date(t.end);
                        return currentDay >= start && currentDay <= end;
                    });

                    if (globalCalType === 'personal') {
                        tasksOnDay = tasksOnDay.filter(t => (t.assigned_to || '').toLowerCase() === currEmail || (t.assigned_from || '').toLowerCase() === currEmail);
                        rmTasksOnDay = rmTasksOnDay.filter(t => (t.who || '') === currName || (t.who || '') === 'Ø§Ù„ÙƒÙ„');
                        notes = notes.filter(e => e.user === currEmail);
                    }

                    // Progress Calculation
                    let totalItems = tasksOnDay.length + rmTasksOnDay.length;
                    let avgProgress = 0;
                    if (totalItems > 0) {
                        const tProg = tasksOnDay.reduce((acc, t) => acc + (t.status === 'completed' ? 100 : 0), 0);
                        const rmProg = rmTasksOnDay.reduce((acc, t) => (t.done ? 100 : (t.progress || 0)), 0);
                        avgProgress = Math.round((tProg + rmProg) / totalItems);
                    }

                    // Main View HTML
                    const evs = notes.map(e => `<div class="text-[9px] bg-palette-primary/10 text-palette-primary p-1 rounded border-r-2 border-palette-primary truncate">${e.note}</div>`).join('');
                    gridHTML += `
                        <div onclick="addCalNote('${dateKey}')" class="calendar-day p-3 rounded-2xl border border-gray-100/50 dark:border-gray-800 h-28 overflow-hidden relative cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/day duration-500 hover:shadow-lg hover:-translate-y-1">
                            <span class="absolute top-2 left-3 text-sm font-black transition-colors ${totalItems > 0 ? 'text-palette-primary' : 'text-gray-200 dark:text-gray-700'}">${d}</span>
                            ${totalItems > 0 ? `<div class="absolute top-3 right-3 w-1.5 h-1.5 rounded-full bg-palette-primary shadow-sm shadow-palette-primary/50 animate-pulse"></div>` : ''}
                            <div class="mt-6 flex flex-col gap-1.5 relative z-10">
                                ${evs} ${tasksOnDay.length > 0 ? `<div class="text-[9px] text-gray-400 font-bold flex items-center gap-1.5 px-1"><i class="fas fa-check-circle text-green-400"></i> ${tasksOnDay.length}</div>` : ''}
                            </div>
                            <div class="absolute bottom-1 right-2 w-8 h-1 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-palette-primary transition-all" style="width: ${avgProgress}%"></div></div>
                        </div>`;

                    // Dashboard Preview HTML (Compact)
                    dashHTML += `
                        <div class="h-16 rounded-2xl relative border ${notes.length > 0 ? 'border-palette-primary/30 bg-palette-primary/5' : 'border-gray-100 dark:border-gray-800'} flex items-center justify-center group/dash cursor-pointer hover:scale-105 transition-all">
                            <span class="text-xs font-black ${notes.length > 0 ? 'text-palette-primary' : 'text-gray-400 dark:text-gray-600'}">${d}</span>
                            ${totalItems > 0 ? `<div class="absolute top-1 right-1 w-1 h-1 rounded-full bg-palette-primary opacity-50"></div>` : ''}
                        </div>`;
                }

                if (grid) grid.innerHTML = gridHTML;
                if (dashGrid) dashGrid.innerHTML = dashHTML;

                updateCalendarSidebar();
            }

            function updateCalendarSidebar() {
                const list = document.getElementById('upcomingEventsList');
                const briefText = document.getElementById('calendarBriefText');
                const tCount = document.getElementById('briefTaskCount');
                const mCount = document.getElementById('briefMeetingCount');
                if (!list) return;

                const currEmail = (currentUser && currentUser.email) ? currentUser.email.toLowerCase() : '';

                // Get all future events & tasks
                const todayStr = new Date().toISOString().split('T')[0];
                const upcoming = [];

                // 1. Add synced events
                calendarEvents.forEach(e => {
                    if (e.date >= todayStr && (globalCalType === 'shared' || e.user === currEmail)) {
                        upcoming.push({ date: e.date, type: 'event', text: e.note });
                    }
                });

                // 2. Add tasks
                tasksDB.forEach(t => {
                    if (t.taskDate >= todayStr && (globalCalType === 'shared' || (t.assigned_to || '').toLowerCase() === currEmail)) {
                        upcoming.push({ date: t.taskDate, type: 'task', text: t.title, status: t.status });
                    }
                });

                // 3. Add Roadmap Milestones
                roadmapDB.forEach(rm => {
                    if (rm.start >= todayStr && (globalCalType === 'shared' || (rm.who || '').toLowerCase().includes((currentUser.name || '').toLowerCase()))) {
                        upcoming.push({ date: rm.start, type: 'roadmap', text: `Ù…Ø¹Ù„Ù… Ø±Ø¦ÙŠØ³ÙŠ: ${rm.title}` });
                    }
                });

                // Sort by date
                upcoming.sort((a, b) => a.date.localeCompare(b.date));

                if (upcoming.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center opacity-20"><i class="fas fa-calendar-day text-5xl mb-4"></i><p class="text-[11px] font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù‚Ø§Ø¯Ù…Ø©</p></div>`;
                    briefText.innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¬Ø¯ÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ¨Ø¯Ùˆ Ø£Ù† ÙŠÙˆÙ…Ùƒ Ù‡Ø§Ø¯Ø¦!";
                    tCount.innerText = "0";
                    mCount.innerText = "0";
                    return;
                }

                list.innerHTML = upcoming.slice(0, 6).map(item => {
                    let iconClass = 'fa-calendar-alt text-gray-400';
                    let bgColor = 'bg-gray-50';
                    let textColor = 'text-palette-primary';

                    if (item.type === 'task') { iconClass = 'fa-tasks text-blue-400'; bgColor = 'bg-blue-50/50'; }
                    else if (item.type === 'event') { iconClass = 'fa-handshake text-purple-400'; bgColor = 'bg-purple-50/50'; }
                    else if (item.type === 'roadmap') { iconClass = 'fa-flag text-red-400'; bgColor = 'bg-red-50/50'; textColor = 'text-red-500'; }

                    return `
                    <div class="${bgColor} p-4 rounded-3xl border border-transparent hover:border-gray-100 dark:hover:bg-white/5 transition-all group/item">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-black uppercase tracking-widest text-gray-400 group-hover/item:${textColor}">${item.date}</span>
                            <i class="fas ${iconClass} text-[10px]"></i>
                        </div>
                        <p class="text-[11px] font-bold text-gray-700 dark:text-gray-200 line-clamp-2">${item.text}</p>
                    </div>
                `;
                }).join('');

                const tasks = upcoming.filter(i => i.type === 'task').length;
                const meetings = upcoming.filter(i => i.type === 'event' || i.type === 'roadmap').length;
                tCount.innerText = tasks;
                mCount.innerText = meetings;

                const total = tasks + meetings;
                if (total > 5) {
                    briefText.innerText = `ÙŠÙˆÙ…Ùƒ Ø­Ø§ÙÙ„ Ø¨Ù€ ${total} Ù…ÙˆØ§Ø¹ÙŠØ¯. Ù†Ù†ØµØ­Ùƒ Ø¨Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„.`;
                } else {
                    briefText.innerText = `Ù„Ø¯ÙŠÙƒ ${total} Ù…ÙˆØ§Ø¹ÙŠØ¯. Ø¬Ø¯ÙˆÙ„Ùƒ Ù…ØªÙˆØ§Ø²Ù† Ø§Ù„ÙŠÙˆÙ…ØŒ ÙˆÙ‚Øª Ù…Ù…ØªØ§Ø² Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ‚Ø©.`;
                }
            }

            // --- ONEDRIVE INTEGRATION SIMULATION ---
            // --- CALENDAR SYNC & INTEGRATIONS ---
            // --- CALENDAR SYNC & INTEGRATIONS (Premium) ---
            window._tmp_sync = function (platform, email) {
                Swal.fire({
                    title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...',
                    html: `ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© ${platform === 'google' ? 'Google' : 'Microsoft'}...`,
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                setTimeout(() => {
                    const y = currentCalDate.getFullYear();
                    const m = String(currentCalDate.getMonth() + 1).padStart(2, '0');
                    const d = platform === 'google' ? '05' : '15';

                    calendarEvents.push({
                        date: `${y}-${m}-${d}`,
                        note: `Ù…ÙˆØ¹Ø¯ Ù…Ø³ØªÙˆØ±Ø¯ Ù…Ù† ${email}`,
                        user: currentUser.email
                    });

                    localStorage.setItem('cal_events', JSON.stringify(calendarEvents));
                    renderCalendar();

                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                        text: `Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…ÙØ¹Ù„Ø© Ø§Ù„Ø¢Ù† Ù…Ø¹ Ø­Ø³Ø§Ø¨ ${email}`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                }, 2000);
            };

            function integrateOneDrive() {
                Swal.fire({
                    title: 'ØªÙˆØµÙŠÙ„ Microsoft Outlook',
                    html: `
                        <div class="text-right p-4">
                            <div class="flex items-center gap-4 mb-6 bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                <i class="fab fa-microsoft text-[#0078D4] text-4xl"></i>
                                <div>
                                    <h4 class="font-bold text-sm text-blue-600">Office 365</h4>
                                    <p class="text-[10px] text-blue-400">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­ÙŠØ© Ù…ÙØ¹Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <button onclick="window._tmp_sync('microsoft', '${currentUser.email}')" class="w-full flex items-center justify-between p-4 rounded-2xl border-2 border-gray-50 hover:border-palette-primary hover:bg-gray-50 transition-all group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">${(currentUser.name || 'U')[0]}</div>
                                        <div class="text-right">
                                            <div class="text-xs font-bold">${currentUser.email}</div>
                                            <div class="text-[9px] text-gray-400 italic">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·</div>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-left text-[10px] text-gray-300 group-hover:text-palette-primary transition-all"></i>
                                </button>
                            </div>
                        </div>
                    `,
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: { popup: 'rounded-[2.5rem]' }
                });
            }

            function integrateGoogleCalendar() {
                Swal.fire({
                    title: 'ØªÙˆØµÙŠÙ„ Ø­Ø³Ø§Ø¨ Google',
                    html: `
                        <div class="text-right p-4">
                            <div class="flex items-center gap-4 mb-6 bg-red-50 p-4 rounded-2xl border border-red-100">
                                <img src="https://www.gstatic.com/images/branding/product/2x/calendar_2020q4_48dp.png" class="w-12 h-12">
                                <div>
                                    <h4 class="font-bold text-sm text-red-600">Google Calendar</h4>
                                    <p class="text-[10px] text-red-400">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <button onclick="window._tmp_sync('google', '${currentUser.email}')" class="w-full flex items-center justify-between p-4 rounded-2xl border-2 border-gray-50 hover:border-palette-primary hover:bg-gray-50 transition-all group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-xs">${(currentUser.name || 'U')[0]}</div>
                                        <div class="text-right">
                                            <div class="text-xs font-bold">${currentUser.email}</div>
                                            <div class="text-[9px] text-gray-400 italic">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ</div>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-left text-[10px] text-gray-300 group-hover:text-palette-primary transition-all"></i>
                                </button>
                                <button onclick="window._tmp_sync('google', 'active@gmail.com')" class="w-full flex items-center justify-between p-4 rounded-2xl border-2 border-dashed border-gray-100 hover:border-gray-300 transition-all opacity-60">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center font-bold text-xs"><i class="fas fa-plus"></i></div>
                                        <div class="text-right">
                                            <div class="text-xs font-bold text-gray-400">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±</div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    `,
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: { popup: 'rounded-[2.5rem]' }
                });
            }

            function uploadCalendarFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.ics';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const content = event.target.result;
                        const parsedEvents = parseICS(content);

                        if (parsedEvents.length === 0) {
                            Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ ØµØ§Ù„Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.', 'error');
                            return;
                        }

                        parsedEvents.forEach(ev => {
                            if (!calendarEvents.some(e => e.date === ev.start && e.note === ev.summary)) {
                                calendarEvents.push({
                                    date: ev.start,
                                    note: ev.summary,
                                    user: currentUser.email
                                });
                            }
                        });

                        localStorage.setItem('cal_events', JSON.stringify(calendarEvents));
                        renderCalendar();

                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨!',
                            text: `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${parsedEvents.length} Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØªÙ… ØªØ±ØªÙŠØ¨Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„ØªÙ‚ÙˆÙŠÙ….`,
                            confirmButtonText: 'Ù…Ù…ØªØ§Ø²'
                        });
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            function parseICS(data) {
                const events = [];
                const lines = data.split(/\r?\n/);
                let currentEvent = null;

                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('BEGIN:VEVENT')) {
                        currentEvent = {};
                    } else if (line.startsWith('END:VEVENT')) {
                        if (currentEvent && currentEvent.summary && currentEvent.start) {
                            events.push(currentEvent);
                        }
                        currentEvent = null;
                    } else if (currentEvent) {
                        if (line.startsWith('SUMMARY:')) {
                            currentEvent.summary = line.substring(8).replace(/\\,/g, ',');
                        } else if (line.startsWith('DTSTART')) {
                            const val = line.split(':')[1];
                            if (val) {
                                // Extract YYYY-MM-DD
                                currentEvent.start = `${val.substring(0, 4)}-${val.substring(4, 6)}-${val.substring(6, 8)}`;
                            }
                        }
                    }
                }
                return events;
            }
            function changeMonth(d) { currentCalDate.setMonth(currentCalDate.getMonth() + d); renderCalendar(); }
            async function addCalNote(d) {
                const { value: n } = await Swal.fire({
                    title: '<span class="text-palette-sidebar">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„ØªÙ‚ÙˆÙŠÙ…</span>',
                    input: 'text',
                    inputPlaceholder: 'Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø£Ùˆ Ø§Ù„Ù…Ù‡Ù…Ø© Ù‡Ù†Ø§...',
                    confirmButtonText: 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„',
                    confirmButtonColor: '#e57e5d',
                    showCancelButton: true,
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    customClass: {
                        popup: 'rounded-[2rem] p-8',
                        input: 'rounded-xl border-gray-100 text-right',
                        confirmButton: 'rounded-xl px-8 py-3 font-bold',
                        cancelButton: 'rounded-xl px-8 py-3 font-bold'
                    }
                });

                if (n) {
                    calendarEvents.push({ date: d, note: n, user: currentUser.email });
                    localStorage.setItem('cal_events', JSON.stringify(calendarEvents));
                    renderCalendar();

                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©',
                        text: 'Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙÙŠ ØªÙ‚ÙˆÙŠÙ…Ùƒ ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            }

            window.filterTasks = function (f, m) {
                currentTaskFilter = f;
                currentTaskMember = m || null;
                renderTasks(f, m);
            };

            // --- TASKS LOGIC ---
            async function fetchTasks() {
                try {
                    const res = await fetch(`${API_BASE}/tasks`);
                    if (res.ok) {
                        const data = await res.json();
                        tasksDB = data.map(t => ({
                            id: t.id,
                            title: t.title,
                            assigned_to: t.assigned_to,
                            from: t.assigned_from,
                            status: t.status,
                            priority: t.priority,
                            type: t.type,
                            taskDate: t.created_at ? t.created_at.split('T')[0] : '',
                            details: t.details, // Ensure details are included
                            taskTime: t.taskTime // Ensure taskTime is included
                        }));
                        if (typeof updateNotificationBadge === 'function') updateNotificationBadge();
                        renderTasks(currentTaskFilter, currentTaskMember);
                    }
                } catch (e) {
                    console.error("Error fetching tasks:", e);
                }
            }

            async function renderTasks(f = 'all', memberEmail = null) {
                const list = document.getElementById('taskList');
                const menu = document.getElementById('teamFilterMenu');
                if (!list) return;

                list.innerHTML = '';

                // Filter Buttons UI state logic
                ['all', 'me', 'completed', 'team'].forEach(id => {
                    const btn = document.getElementById(`filter-${id}`);
                    if (!btn) return;
                    const isActive = (id === 'team' && memberEmail) || (id === f && !memberEmail);
                    if (isActive) {
                        btn.className = "px-5 py-2 rounded-lg text-sm font-bold bg-palette-primary text-white shadow transition-all flex items-center gap-2";
                    } else {
                        btn.className = "px-5 py-2 rounded-lg text-sm font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all flex items-center gap-2";
                    }
                });

                // Populate Team Menu (Filtered by Current User)
                if (menu) {
                    menu.innerHTML = '';
                    Object.entries(USERS).forEach(([email, u]) => {
                        const lowEmail = email.toLowerCase();
                        const currEmail = currentUser?.email?.toLowerCase();

                        // 1. Hide current user from their own dropdown
                        if (currEmail === lowEmail) return;


                        const isSelected = memberEmail === email;
                        const item = document.createElement('button');
                        item.className = `w-full text-right px-4 py-3 text-xs font-bold hover:bg-blue-50 dark:hover:bg-gray-800 transition flex items-center gap-3 ${isSelected ? 'text-blue-500 bg-blue-50/50' : 'text-gray-600 dark:text-gray-300'}`;

                        const initials = u.name.charAt(0);
                        item.innerHTML = `
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] text-white font-bold" style="background:${u.color}">${initials}</div>
                        <span class="flex-1">${u.name}</span>
                        ${isSelected ? '<i class="fas fa-check text-blue-500"></i>' : ''}
                    `;
                        item.onclick = () => {
                            filterTasks('team', email);
                            menu.classList.add('hidden');
                        };
                        menu.appendChild(item);
                    });
                }

                // Update main Team filter button label
                const labelSpan = document.querySelector('#filter-team span');
                if (labelSpan) {
                    if (memberEmail) {
                        const user = getUser(memberEmail);
                        labelSpan.innerText = user ? `Ù…Ø³Ù†Ø¯Ù‡ Ù„Ù€ ${user.name.split(' ')[1] || user.name}` : 'Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±ÙŠÙ‚';
                    } else {
                        labelSpan.innerText = 'Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±ÙŠÙ‚';
                    }
                }

                const currEmail = currentUser?.email?.toLowerCase() || '';
                const isManager = currentUser && (currentUser.type === 'ceo' || currentUser.type === 'gm');

                // ğŸ”’ PRIVACY CORE: A task is ONLY visible to the Sender and the Receiver.
                // Exception: CEO/GM can see all team work to manage effectively.
                let visibleTasks = tasksDB.filter(x => {
                    const assigned = (x.assigned_to || '').toLowerCase();
                    const sender = (x.from || '').toLowerCase();
                    return isManager || (assigned === currEmail || sender === currEmail);
                });

                let t = [...visibleTasks];

                if (memberEmail) {
                    // Shared Space: Tasks between ME and this specific person
                    const target = memberEmail.toLowerCase();
                    t = t.filter(x => {
                        const assigned = (x.assigned_to || '').toLowerCase();
                        const sender = (x.from || '').toLowerCase();
                        return (assigned === target) || (sender === target);
                    });
                } else if (f === 'me') {
                    // Incoming: Tasks assigned TO me
                    t = t.filter(x => (x.assigned_to || '').toLowerCase() === currEmail);
                } else if (f === 'team') {
                    // Outgoing/Tracking: Tasks I sent to others
                    t = t.filter(x => {
                        const assigned = (x.assigned_to || '').toLowerCase();
                        const sender = (x.from || '').toLowerCase();
                        return sender === currEmail && assigned !== currEmail;
                    });
                } else if (f === 'completed') {
                    t = t.filter(x => x.status === 'completed');
                }
                // 'all' shows all visibleTasks (everything I'm involved in)

                const emptyMsg = document.getElementById('noTasksMsg');
                if (t.length === 0) {
                    if (emptyMsg) emptyMsg.classList.remove('hidden');
                } else {
                    if (emptyMsg) emptyMsg.classList.add('hidden');
                }

                t.forEach(x => {
                    const isCompleted = x.status === 'completed';
                    const isRejected = x.status === 'rejected';
                    const prioColor = x.priority === 'high' ? 'bg-red-500' : (x.priority === 'medium' ? 'bg-orange-400' : 'bg-blue-400');

                    const assignedEmail = (x.assigned_to || '').toLowerCase();
                    const senderEmail = (x.from || '').toLowerCase();

                    const uAssigned = getUser(assignedEmail);
                    const uSender = getUser(senderEmail);

                    const personName = uAssigned ? uAssigned.name : 'Ø§Ù„Ø¬Ù…ÙŠØ¹';
                    const senderName = uSender ? uSender.name : 'Ø§Ù„Ù†Ø¸Ø§Ù…';
                    const isSenderMe = currEmail === senderEmail;
                    const isAssignedMe = currEmail === assignedEmail;

                    list.innerHTML += `
                <div class="bg-white dark:bg-palette-darkPanel px-4 md:px-6 py-4 rounded-3xl border border-palette-border dark:border-palette-darkBorder flex justify-between items-center group transition hover:border-palette-primary ${isCompleted ? 'bg-gray-50/50 dark:bg-green-900/10' : ''} ${isRejected ? 'bg-red-50 dark:bg-red-900/10' : ''} mb-2 relative">
                    <div class="flex gap-4 items-center flex-1">
                        <div class="relative flex flex-col items-center gap-1">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                onclick="toggleTaskStatus(${x.id}, '${isCompleted ? 'pending' : 'completed'}')"
                                class="w-6 h-6 rounded-lg appearance-none border-2 border-gray-200 dark:border-gray-600 checked:bg-green-500 checked:border-green-500 cursor-pointer transition-all flex items-center justify-center">
                             <button onclick="toggleTaskStatus(${x.id}, 'rejected')" class="text-[10px] text-red-400 hover:text-red-600 opacity-60 hover:opacity-100"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-gray-800 dark:text-white transition-all ${isCompleted ? 'line-through text-gray-400 opacity-60' : ''}">${x.title}</h4>
                                ${x.details ? `<span class="text-[10px] text-blue-500 cursor-help" title="${x.details}"><i class="fas fa-info-circle"></i></span>` : ''}
                            </div>
                             <div class="flex flex-wrap items-center gap-3 mt-1">
                                <span class="text-[9px] px-1.5 py-0.5 rounded-full ${prioColor} text-white font-bold opacity-80 uppercase tracking-tighter">${x.priority}</span>
                                <span class="text-[10px] text-gray-500 font-bold flex items-center gap-1" title="Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                                    <i class="far fa-file-alt text-blue-400"></i> ${personName}
                                </span>
                                ${senderEmail && senderEmail !== assignedEmail ? `
                                <span class="text-[10px] text-gray-400 flex items-center gap-1" title="Ø¨ÙˆØ§Ø³Ø·Ø©">
                                    <i class="fas fa-paper-plane text-[8px] opacity-70"></i> <span class="opacity-80">${senderName}</span>
                                </span>` : ''}
                                ${x.taskDate ? `<span class="text-[9px] text-gray-400"><i class="far fa-calendar-alt ml-1"></i> ${x.taskDate}</span>` : ''}
                                ${x.taskTime ? `<span class="text-[9px] text-gray-400"><i class="far fa-clock ml-1"></i> ${x.taskTime}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1 transition-opacity">
                            <button onclick="editTaskModal(${x.id})" class="w-8 h-8 rounded-full text-blue-400 hover:bg-blue-50 flex items-center justify-center transition" title="ØªØ¹Ø¯ÙŠÙ„">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="deleteTask(${x.id})" class="w-8 h-8 rounded-full text-red-400 hover:bg-red-50 flex items-center justify-center transition" title="Ø­Ø°Ù">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                        <div class="status-indicator">
                            ${isCompleted ? '<i class="fas fa-check-circle text-green-500 text-lg"></i>' : (isRejected ? '<i class="fas fa-times-circle text-red-500 text-lg"></i>' : '<i class="far fa-circle text-gray-300 text-lg"></i>')}
                        </div>
                    </div>
                </div>`;
                });
            }

            window.editTaskModal = function (id) {
                const t = tasksDB.find(x => x.id === id);
                if (!t) return;
                openTaskModal();
                document.getElementById('modalTitleText').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
                document.getElementById('taskEditId').value = t.id;
                document.getElementById('taskTitle').value = t.title || '';
                document.getElementById('taskDetails').value = t.details || '';
                document.getElementById('assignTo').value = t.assigned_to || '';
                document.getElementById('taskPriority').value = t.priority || 'normal';
                document.getElementById('taskDate').value = t.taskDate || '';
                document.getElementById('taskTime').value = t.taskTime || '';
                document.getElementById('saveTaskBtn').innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©';
            }

            // Sub-tasks Management

            window.openTaskModal = function () {
                const modal = document.getElementById('actionModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');

                    // Reset Fields for NEW task
                    document.getElementById('taskEditId').value = '';
                    document.getElementById('taskTitle').value = '';
                    document.getElementById('taskDetails').value = '';
                    document.getElementById('taskDate').value = '';
                    document.getElementById('taskTime').value = '';
                    document.getElementById('assignTo').value = '';
                    document.getElementById('modalTitleText').innerText = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                    document.getElementById('saveTaskBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©';

                    // Populate dropdown
                    const sel = document.getElementById('assignTo');
                    if (sel) {
                        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>';
                        const db = (typeof usersDB !== 'undefined') ? usersDB : USERS;
                        Object.entries(db).forEach(([email, u]) => {
                            sel.innerHTML += `<option value="${email}">${u.name}</option>`;
                        });
                    }
                }
            };

            window.addTask = async function (e) {
                if (e) e.preventDefault();

                const editId = document.getElementById('taskEditId').value;
                const title = document.getElementById('taskTitle').value;
                const to = document.getElementById('assignTo').value;
                const details = document.getElementById('taskDetails').value;
                const priority = document.getElementById('taskPriority').value;
                const tDate = document.getElementById('taskDate').value;
                const tTime = document.getElementById('taskTime').value;

                if (!title) { Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©', 'warning'); return; }

                const fromUser = (window.currentUser && window.currentUser.email) ? window.currentUser.email : 'admin';

                const taskData = {
                    title,
                    to,
                    from: fromUser,
                    details,
                    priority,
                    type: 'dev', // Default
                    taskDate: tDate,
                    taskTime: tTime,
                    subtasks: []
                };

                try {
                    let res;
                    if (editId) {
                        res = await fetch(`${API_BASE}/tasks/${editId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(taskData)
                        });
                    } else {
                        res = await fetch(`${API_BASE}/tasks`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(taskData)
                        });
                    }

                    if (res.ok) {
                        await fetchTasks();
                        closeModal('actionModal');
                        Swal.fire({ title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', icon: 'success', timer: 1000, showConfirmButton: false });
                    }
                } catch (e) {
                    console.error("Error saving task:", e);
                }
            };

            function saveTasksToLocal() {
                localStorage.setItem('tasks_v5', JSON.stringify(tasksDB));
            }

            window.quickAddTask = async function (title) {
                title = title.trim();
                if (!title) return;

                if (!window.currentUser) {
                    Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ù… Ø³Ø±ÙŠØ¹Ø©', 'warning');
                    return;
                }

                try {
                    const res = await fetch(`${API_BASE}/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title,
                            to: window.currentUser.email,
                            from: window.currentUser.email,
                            priority: 'medium',
                            type: 'dev'
                        })
                    });

                    if (res.ok) {
                        await fetchTasks();
                        const input = document.getElementById('quickTaskInput');
                        if (input) { input.value = ''; input.focus(); }
                        Swal.fire({ title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', icon: 'success', timer: 800, showConfirmButton: false });
                    }
                } catch (e) {
                    console.error("Error quick adding task:", e);
                }
            };

            window.toggleTaskStatus = async function (id, newStatus) {
                try {
                    const res = await fetch(`${API_BASE}/tasks/${id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (res.ok) {
                        await fetchTasks();
                        const isDone = newStatus === 'completed';
                        const msg = isDone ? 'ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©! ğŸ‰' : 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‡Ù…Ø©';
                        Swal.fire({ title: 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', text: msg, icon: 'success', timer: 1200, showConfirmButton: false });
                    }
                } catch (e) {
                    console.error("Error toggling task status:", e);
                }
            };

            window.deleteTask = function (id) {
                Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ',
                    text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const res = await fetch(`${API_BASE}/tasks/${id}`, {
                                method: 'DELETE'
                            });
                            if (res.ok) {
                                await fetchTasks();
                                Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
                            }
                        } catch (e) {
                            console.error("Error deleting task:", e);
                        }
                    }
                });
            };

            window.toggleTeamFilter = function (e) {
                e.stopPropagation();
                const menu = document.getElementById('teamFilterMenu');
                menu.classList.toggle('hidden');
            };

            // Close dropdown when clicking elsewhere
            document.addEventListener('click', () => {
                const menu = document.getElementById('teamFilterMenu');
                if (menu) menu.classList.add('hidden');
            });





            // --- HELPERS ---
            function switchSettingsTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));

                // Show selected tab
                const target = document.getElementById(`settings-${tabName}`);
                if (target) target.classList.remove('hidden');

                // Update Sidebar Buttons Styling
                ['account', 'security', 'notifications'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (btn) {
                        if (t === tabName) {
                            btn.classList.remove('hover:bg-white', 'dark:hover:bg-gray-800', 'text-gray-600', 'dark:text-gray-300');
                            btn.classList.add('bg-palette-sidebar', 'text-white', 'font-bold', 'shadow-md');
                        } else {
                            btn.classList.add('hover:bg-white', 'dark:hover:bg-gray-800', 'text-gray-600', 'dark:text-gray-300');
                            btn.classList.remove('bg-palette-sidebar', 'text-white', 'font-bold', 'shadow-md');
                        }
                    }
                });
            }

            function showPage(id, el) {
                console.log("Switching to page:", id);
                const target = document.getElementById(id);
                if (!target) {
                    console.error("Page not found:", id);
                    Swal.fire("Error", "Page not found: " + id, "error");
                    return;
                }

                document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden-section'));
                target.classList.remove('hidden-section');

                if (el) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }

                // Update Header Title
                const titleMap = {
                    'dashboard': 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©',
                    'dailyPlan': 'Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
                    'tasks': 'Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
                    'projects': 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
                    'messages': 'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ©',
                    'calendar': 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø´ØªØ±Ùƒ',
                    'reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                    'team': 'Ø§Ù„ÙØ±ÙŠÙ‚',
                    'settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'
                };
                const headerTitle = document.getElementById('pageTitle');
                if (headerTitle) headerTitle.innerText = titleMap[id] || 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©';

                // Page Specific Inits
                try {
                    if (id === 'dailyPlan') loadPlannerData();
                    if (id === 'projects') renderProjectTable();
                    if (id === 'messages') loadChatUsers();
                    if (id === 'tasks') renderTasks();
                    if (id === 'calendar') renderCalendar();
                    if (id === 'team') renderTeam();
                    if (id === 'reports') renderReports();
                } catch (e) {
                    console.error("Error rendering page " + id, e);
                    Swal.fire("Error", "Failed to load page content: " + e.message, "error");
                }
            }

            function closeModal(id) { document.getElementById(id).style.display = 'none'; }

            // --- DAILY PLANNER LOGIC ---
            function getPlannerData() {
                if (!currentUser) return {};
                return JSON.parse(localStorage.getItem(`planner_data_${currentUser.email}`)) || {};
            }

            function setPlannerData(data) {
                if (!currentUser) return;
                localStorage.setItem(`planner_data_${currentUser.email}`, JSON.stringify(data));
            }

            function getPlannerArchive() {
                if (!currentUser) return [];
                return JSON.parse(localStorage.getItem(`planner_archive_${currentUser.email}`)) || [];
            }

            function setPlannerArchive(arr) {
                if (!currentUser) return;
                localStorage.setItem(`planner_archive_${currentUser.email}`, JSON.stringify(arr));
            }

            function loadPlannerData() {
                const d = new Date();
                const dateEl = document.getElementById('plannerDate');
                if (dateEl) dateEl.innerText = d.toLocaleDateString('en-GB');

                // Reset inputs
                document.querySelectorAll('.planner-input').forEach(i => i.value = '');
                document.querySelectorAll('textarea').forEach(t => t.value = '');
                document.querySelectorAll('.check-box').forEach(c => c.classList.remove('checked'));
                document.querySelectorAll('.check-item input').forEach(i => i.value = '');

                const data = getPlannerData();
                Object.keys(data).forEach(key => {
                    if (key.startsWith('todo_') && !key.startsWith('todo_txt_')) {
                        const el = document.querySelector(`[onclick="toggleCheck(this, '${key}')"]`);
                        if (el) {
                            if (data[key]) el.classList.add('checked');
                            else el.classList.remove('checked');
                        }
                    } else {
                        const el = document.querySelector(`[onchange="savePlanner(this,'${key}')"]`);
                        if (el) el.value = data[key];
                    }
                });

                renderPlannerHistory();
            }

            function savePlanner(el, key) {
                const data = getPlannerData();
                data[key] = el.value;
                setPlannerData(data);
            }

            function toggleCheck(el, key) {
                el.classList.toggle('checked');
                const data = getPlannerData();
                data[key] = el.classList.contains('checked');
                setPlannerData(data);
            }

            function syncTasksToPlanner() {
                let myTasks = tasksDB.filter(t => t.status === 'pending');
                if (currentUser.type === 'tech') myTasks = myTasks.filter(t => t.to === currentUser.email);
                else if (currentUser.type === 'pm') myTasks = myTasks.filter(t => t.to === currentUser.email);

                const data = getPlannerData();
                for (let i = 0; i < 6; i++) {
                    if (myTasks[i]) {
                        data[`todo_txt_${i + 1}`] = myTasks[i].title;
                        data[`todo_${i + 1}`] = false;
                    }
                }
                setPlannerData(data);
                loadPlannerData();
                Swal.fire({ icon: 'success', title: 'ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', timer: 1000, showConfirmButton: false });
            }

            function archiveDay() {
                Swal.fire({
                    title: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ØŸ',
                    text: "Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ¨Ø¯Ø¡ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#2c354c',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø£Ø±Ø´ÙØ©!',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const current = getPlannerData();
                        const archives = getPlannerArchive();

                        // Add date stamp
                        current._archivedDate = new Date().toLocaleString('ar-SA');
                        current._dayName = new Date().toLocaleDateString('ar-SA', { weekday: 'long' });

                        archives.unshift(current); // Add to top
                        setPlannerArchive(archives);
                        setPlannerData({}); // Clear current

                        loadPlannerData();
                        Swal.fire('ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ©!', 'ØªÙ… Ø­ÙØ¸ Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„Ø£Ø³ÙÙ„.', 'success');
                    }
                })
            }

            function renderPlannerHistory() {
                const container = document.getElementById('plannerHistory');
                if (!container) return;
                container.innerHTML = '<h3 class="text-center text-gray-400 text-sm font-bold opacity-60 mb-4">Saved Days (Archive)</h3>';

                const archives = getPlannerArchive();
                if (archives.length === 0) {
                    container.innerHTML += '<p class="text-center text-gray-300 text-xs">No archived days yet.</p>';
                    return;
                }

                archives.forEach((day, index) => {
                    const date = day._archivedDate || 'Unknown Date';
                    const dayName = day._dayName || 'Day';

                    // Construct Schedule List
                    let scheduleHTML = '';
                    const times = ['8', '9', '10', '11', '12', '1', '2', '3', '4'];
                    times.forEach(t => {
                        const val = day[`sch_${t}`];
                        if (val) scheduleHTML += `<div class="flex text-xs border-b border-gray-100 py-1"><span class="w-12 font-bold text-gray-400">${t}:00</span><span class="text-gray-700">${val}</span></div>`;
                    });

                    // Construct Todo List
                    let todoHTML = '';
                    for (let i = 1; i < 6; i++) {
                        const txt = day[`todo_txt_${i}`];
                        const done = day[`todo_${i}`];
                        if (txt) todoHTML += `<div class="flex items-center gap-2 text-xs mb-1"><i class="fas ${done ? 'fa-check-square text-green-500' : 'fa-square text-gray-300'}"></i> <span class="${done ? 'line-through text-gray-400' : 'text-gray-700'}">${txt}</span></div>`;
                    }

                    container.innerHTML += `
                <div class="bg-white opacity-90 rounded-xl p-0 border-b-4 border-gray-200 shadow-sm transition hover:shadow-md mb-4 overflow-hidden group">
                    <!-- HEADER -->
                    <div class="p-6 cursor-pointer flex justify-between items-center bg-white" onclick="toggleArchiveDetail(this)">
                        <div class="flex items-center gap-4">
                            <div class="bg-palette-sidebar text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">${dayName.charAt(0)}</div>
                            <div>
                                <h4 class="font-bold text-[#2c354c] text-lg">${dayName}</h4>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                             <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                                <button onclick="restoreArchive(${index})" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-lg hover:bg-blue-100 border border-blue-200">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ <i class="fas fa-undo ml-1"></i></button>
                                <button onclick="deleteArchive(${index})" class="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-lg hover:bg-red-100 border border-red-200">Ø­Ø°Ù <i class="fas fa-trash ml-1"></i></button>
                             </div>
                             <i class="fas fa-chevron-down text-gray-400 transition transform duration-300"></i>
                        </div>
                    </div>
                    
                    <!-- FULL DETAIL (Hidden) -->
                    <div class="hidden border-t border-gray-100 bg-[#fdfbf6] p-6 text-sm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Left: Schedule & Finish -->
                            <div class="space-y-4">
                                <div>
                                    <h5 class="font-bold text-[#2c354c] border-b mb-2 pb-1">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ</h5>
                                    <div class="space-y-1">${scheduleHTML || '<p class="text-xs text-gray-400 italic">ÙØ§Ø±Øº</p>'}</div>
                                </div>
                                <div>
                                    <h5 class="font-bold text-[#2c354c] border-b mb-2 pb-1">Ù…Ø§ ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡</h5>
                                    <p class="text-gray-600 text-xs p-2 border border-dashed border-gray-300 rounded">${day.finished || '-'}</p>
                                </div>
                            </div>
                            
                            <!-- Right: Priorities, Todo, Notes -->
                            <div class="space-y-4">
                                <div>
                                    <h5 class="font-bold text-[#2c354c] border-b mb-2 pb-1">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</h5>
                                    <ul class="list-decimal list-inside text-gray-600 text-xs space-y-1">
                                        <li>${day.prio_1 || '-'}</li>
                                        <li>${day.prio_2 || '-'}</li>
                                        <li>${day.prio_3 || '-'}</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-bold text-[#2c354c] border-b mb-2 pb-1">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h5>
                                    <div>${todoHTML || '<p class="text-xs text-gray-400 italic">ÙØ§Ø±ØºØ©</p>'}</div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <div class="bg-[#ceaed2]/20 p-2 rounded">
                                        <p class="font-bold text-[10px] text-purple-800">Ù„Ù„ØºØ¯:</p>
                                        <p class="text-xs text-gray-600">${day.tomorrow || '-'}</p>
                                    </div>
                                    <div class="bg-[#f3f0e0] p-2 rounded border border-yellow-100">
                                        <p class="font-bold text-[10px] text-yellow-800">Ù…Ù„Ø§Ø­Ø¸Ø©:</p>
                                        <p class="text-xs text-gray-600">${day.note || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                });
            }

            function deleteArchive(index) {
                Swal.fire({
                    title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                    text: "Ù„Ù† ØªØ³ØªØ·ÙŠØ¹ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                    cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const archives = getPlannerArchive();
                        archives.splice(index, 1);
                        setPlannerArchive(archives);
                        renderPlannerHistory();
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', '', 'success');
                    }
                });
            }

            function restoreArchive(index) {
                Swal.fire({
                    title: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¬Ù„ØŸ',
                    text: "Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©).",
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙˆØªØ¹Ø¯ÙŠÙ„',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const archives = getPlannerArchive();
                        const dayToRestore = archives[index];

                        // Restore to current workspace
                        setPlannerData(dayToRestore);
                        loadPlannerData();
                        document.getElementById('dailyPlan').scrollIntoView({ behavior: 'smooth' });
                        Swal.fire('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰', 'success');
                    }
                })
            }

            function toggleArchiveDetail(el) {
                const detail = el.nextElementSibling;
                const icon = el.querySelector('.fa-chevron-down');

                if (detail) {
                    if (detail.style.display === 'block') {
                        detail.style.display = 'none'; // hide
                        detail.classList.add('hidden');
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        detail.style.display = 'block'; // show
                        detail.classList.remove('hidden');
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            }



            // --- PROJECTS LOGIC (SUPER BOARD & MODAL) ---
            // 1. Data Initialization
            // --- PROJECTS LOGIC (SUPER BOARD & NESTED TASKS) ---
            let currentProjectId = null;

            // 1. Data Initialization
            let projectsDB = JSON.parse(localStorage.getItem('projects_db_v3')) || [
                {
                    id: 1, name: 'ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', icon: 'fa-globe', status: 'working', type: 'Development', budget: '$5000',
                    subitems: [
                        {
                            id: 101, name: 'Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø±Ø¦ÙŠ UI', person: 'N', status: 'done', flexibleTime: false,
                            subitems: [
                                { id: 1011, name: 'ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', person: 'N', status: 'done', flexibleTime: true, subitems: [] },
                                { id: 1012, name: 'ØªØµÙ…ÙŠÙ… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', person: 'N', status: 'working', flexibleTime: false, subitems: [] }
                            ]
                        },
                        { id: 102, name: 'Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Backend', person: 'G', status: 'stuck', flexibleTime: false, subitems: [] }
                    ]
                },
                {
                    id: 2, name: 'Ø­Ù…Ù„Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Q1', icon: 'fa-bullhorn', status: 'stuck', type: 'Marketing', budget: '$2000',
                    subitems: [
                        { id: 201, name: 'Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§', person: 'LA', status: 'working', flexibleTime: true, subitems: [] }
                    ]
                }
            ];

            function saveProjectsData() {
                localStorage.setItem('projects_db_v3', JSON.stringify(projectsDB));
            }

            // 2. Board Render (Icons & Names)
            function renderProjectTable() {
                if (currentProjectId) {
                    renderProjectDetail(currentProjectId);
                } else {
                    renderProjectBoard();
                }
            }

            function renderProjectBoard() {
                currentProjectId = null;
                const grid = document.getElementById('projectCardsGrid');
                if (!grid) return;

                document.getElementById('projectBoardView').classList.remove('hidden');
                document.getElementById('projectDetailView').classList.add('hidden');

                grid.innerHTML = '';
                projectsDB.forEach(p => {
                    const icon = p.icon || 'fa-project-diagram';
                    const count = countTasks(p.subitems);
                    grid.innerHTML += `
                    <div class="bg-white dark:bg-palette-darkPanel rounded-3xl p-6 border border-palette-border dark:border-palette-darkBorder shadow-sm group hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer relative overflow-hidden" onclick="viewProjectDetail(${p.id})">
                        <div class="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                            <button onclick="deleteProject(${p.id})" class="text-red-400 hover:text-red-600 transition p-2"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="w-16 h-16 rounded-2xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform">
                            <i class="fas ${icon}"></i>
                        </div>
                        <h3 class="text-xl font-black text-gray-800 dark:text-white mb-2">${p.name}</h3>
                        <div class="flex items-center gap-4 text-xs text-gray-400">
                            <span><i class="fas fa-tasks ml-1"></i> ${count} Ù…Ù‡Ø§Ù…</span>
                            <span class="capitalize"><i class="fas fa-circle ml-1 text-[8px] ${p.status === 'done' ? 'text-green-500' : (p.status === 'stuck' ? 'text-red-500' : 'text-blue-500')}"></i> ${p.status}</span>
                        </div>
                    </div>
                `;
                });
            }

            function countTasks(subitems) {
                let count = subitems.length;
                subitems.forEach(s => { if (s.subitems) count += countTasks(s.subitems); });
                return count;
            }

            function viewProjectDetail(id) {
                currentProjectId = id;
                renderProjectDetail(id);
            }

            function backToProjectBoard() {
                currentProjectId = null;
                renderProjectBoard();
            }

            function renderProjectDetail(id) {
                const project = projectsDB.find(p => p.id === id);
                if (!project) return;

                document.getElementById('projectBoardView').classList.add('hidden');
                document.getElementById('projectDetailView').classList.remove('hidden');
                document.getElementById('detailProjectName').innerText = project.name;
                document.getElementById('detailProjType').innerText = project.type || 'Ø¹Ø§Ù…';
                document.getElementById('detailProjBudget').innerText = project.budget || '$0';

                const tbody = document.getElementById('projectTableBody');
                tbody.innerHTML = '';

                // Recursive rendering of tasks
                renderNestedTasks(project.subitems, tbody, 0, id);
            }

            function renderLabelsRow(container, isPhase = false, phaseId = null, projectId = null) {
                const trLabels = document.createElement('tr');
                trLabels.className = (isPhase ? 'bg-gray-50/50 dark:bg-gray-800/50' : 'bg-white dark:bg-palette-darkPanel') + ' text-[10px] uppercase font-bold text-gray-400 border-b border-gray-100 dark:border-gray-800';

                let dynColsLabels = '';
                if (window.customColumns) {
                    window.customColumns.forEach(c => dynColsLabels += `<th class="py-1">${c.title}</th>`);
                }

                const phaseAddTaskBtn = (isPhase && phaseId) ? `<button onclick="addNestedSubtask(${projectId}, ${phaseId})" class="mr-2 text-blue-500 hover:text-blue-700 transition" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØªØ­Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…"><i class="fas fa-plus-circle"></i></button>` : '';

                trLabels.innerHTML = `
                <th style="width: 40px; border-left: 4px solid #0060E0;"></th>
                <th class="py-1 text-right pr-6 flex items-center gap-2">
                    ${phaseAddTaskBtn}
                    <span>Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ù…Ø±Ø­Ù„Ø©</span>
                </th>
                <th class="py-1 text-center"><i class="fas fa-clock"></i></th>
                <th class="py-1">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                <th class="py-1">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th class="py-1">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                <th class="py-1">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                <th class="py-1">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
                <th class="py-1">Ø­Ø°Ù</th>
                ${dynColsLabels}
                <th style="width:40px">
                    <div class="w-6 h-6 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center cursor-pointer transition text-gray-400" onclick="toggleColumnMenu(this, event)" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯">
                        <i class="fas fa-columns"></i>
                    </div>
                </th>
            `;
                container.appendChild(trLabels);
            }

            function renderNestedTasks(tasks, container, level, projectId, parentTaskId = null) {
                // If level 0, check if we need a default header for non-phase tasks
                if (level === 0) {
                    const hasStandalone = tasks.some(t => !(t.type === 'phase' || (t.subitems && t.subitems.length > 0)));
                    if (hasStandalone) renderLabelsRow(container);
                }

                tasks.forEach(task => {
                    const isDone = task.status === 'done';
                    const hasChildren = task.subitems && task.subitems.length > 0;
                    const isPhase = task.type === 'phase' || (level === 0 && hasChildren);

                    if (isPhase) {
                        const trPhase = document.createElement('tr');
                        trPhase.className = 'phase-row bg-blue-50/30 dark:bg-blue-900/10 font-bold';
                        trPhase.innerHTML = `
                        <td style="border-left: 4px solid #0060E0;"></td>
                        <td colspan="30" class="py-3 px-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-layer-group text-blue-500"></i>
                                    <span class="text-lg text-blue-900 dark:text-blue-300">${task.name}</span>
                                    <button onclick="addNestedSubtask(${projectId}, ${task.id})" class="text-blue-400 hover:text-blue-600 transition ml-2 text-xs" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…">
                                        <i class="fas fa-plus-circle"></i> Ø£Ø¶Ù Ù…Ù‡Ù…Ø©
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 pr-4">
                                     <button onclick="deleteProjectTask(${projectId}, ${task.id})" class="text-red-300 hover:text-red-500 transition text-xs"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </td>
                    `;
                        container.appendChild(trPhase);
                        renderLabelsRow(container, true, task.id, projectId);

                        if (task.subitems) {
                            renderNestedTasks(task.subitems, container, level + 1, projectId, task.id);
                        }
                        return;
                    }

                    // Render Standard Task Row
                    const tr = document.createElement('tr');
                    tr.className = 'group task-row';
                    const paddingClass = level > 0 ? `style="padding-right: ${level * 30}px"` : '';

                    let statusText = '-';
                    let statusClass = 'status-empty';
                    if (task.status === 'done') { statusClass = 'status-done'; statusText = 'Ù…ÙƒØªÙ…Ù„'; }
                    else if (task.status === 'working') { statusClass = 'status-working'; statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„'; }
                    else if (task.status === 'stuck') { statusClass = 'status-stuck'; statusText = 'Ù…ØªÙˆÙ‚Ù'; }

                    tr.innerHTML = `
                    <td style="border-left: 4px solid ${isDone ? '#00c875' : '#579bfc'};">
                        <input type="checkbox" ${isDone ? 'checked' : ''} class="w-4 h-4 accent-green-500" onclick="toggleProjectTaskStatus(${projectId}, ${task.id})">
                    </td>
                    <td ${paddingClass}>
                        <div class="flex items-center gap-2">
                            ${level > 0 ? '<i class="fas fa-level-down-alt text-gray-300 text-[10px] rotate-180"></i>' : ''}
                            <span class="text-sm font-bold ${isDone ? 'line-through text-gray-400' : 'text-gray-800 dark:text-gray-200'}">${task.name}</span>
                            <button onclick="addNestedSubtask(${projectId}, ${task.id})" class="text-blue-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition ml-2 text-[10px]" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td class="text-center">
                        <button onclick="toggleFlexibleTime(${projectId}, ${task.id})" class="text-lg transition ${task.flexibleTime ? 'text-green-500' : 'text-gray-300'}">
                            <i class="fas ${task.flexibleTime ? 'fa-clock-rotate-left' : 'fa-clock'}"></i>
                        </button>
                    </td>
                    <td><span class="person-bubble text-[8px]" style="background:#579bfc">${task.person || '?'}</span></td>
                    <td><div class="status-cell ${statusClass}" onclick="cycleProjectTaskStatus(${projectId}, ${task.id})">${statusText}</div></td>
                    <td class="text-center group-hover:bg-blue-50/10 transition relative">
                        <div class="flex items-center justify-center gap-1 cursor-pointer hover:text-blue-500" onclick="editProjectTaskDate(${projectId}, ${task.id}, 'startDate')">
                            <i class="far fa-calendar-alt text-[9px] opacity-40"></i>
                            <span class="text-[10px] font-bold">${task.startDate || '-'}</span>
                        </div>
                    </td>
                    <td class="text-center group-hover:bg-blue-50/10 transition relative">
                        <div class="flex items-center justify-center gap-1 cursor-pointer hover:text-blue-500" onclick="editProjectTaskDate(${projectId}, ${task.id}, 'endDate')">
                            <i class="far fa-calendar-alt text-[9px] opacity-40"></i>
                            <span class="text-[10px] font-bold">${task.endDate || '-'}</span>
                        </div>
                    </td>
                    <td><div class="timeline-cell bg-gray-100 dark:bg-gray-800"><div class="timeline-bar" style="width: ${isDone ? '100%' : '30%'};"></div></div></td>
                    <td class="text-center">
                        <div class="flex items-center justify-center gap-1 group-actions">
                            <button onclick="deleteProjectTask(${projectId}, ${task.id})" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;

                    if (window.customColumns) {
                        window.customColumns.forEach(col => {
                            const val = (task.custom && task.custom[col.id]) || '';
                            let cellHTML = `<td class="text-center">`;
                            if (col.type === 'Checkbox') cellHTML += `<input type="checkbox" ${val ? 'checked' : ''} onchange="updateCustomCell(${projectId}, ${task.id}, '${col.id}', this.checked)">`;
                            else if (col.type === 'Rating') cellHTML += `<div class="flex justify-center gap-1 text-yellow-400 cursor-pointer" onclick="cycleRating(${projectId}, ${task.id}, '${col.id}')">${Array(5).fill().map((_, i) => `<i class="fas fa-star ${i < (parseInt(val) || 0) ? '' : 'opacity-20'}"></i>`).join('')}</div>`;
                            else if (col.type === 'Dropdown' && col.options) cellHTML += `<select class="bg-transparent border-none outline-none text-xs font-bold w-full text-center" onchange="handleDropdownChange(${projectId}, ${task.id}, '${col.id}', this)">
                            <option value="">-</option>
                            ${(col.options || []).map(o => `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`).join('')}
                            <option value="NEW_OPTION">+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯...</option>
                        </select>`;
                            else cellHTML += `<input type="text" class="w-full bg-transparent text-center outline-none text-xs font-bold" value="${val}" onchange="updateCustomCell(${projectId}, ${task.id}, '${col.id}', this.value)">`;
                            cellHTML += `</td>`;
                            tr.innerHTML += cellHTML;
                        });
                    }
                    tr.innerHTML += `<td></td>`;
                    container.appendChild(tr);

                    if (task.subitems && task.subitems.length > 0) {
                        renderNestedTasks(task.subitems, container, level + 1, projectId, task.id);
                    }
                });
            }

            // Logic Helpers
            function findTaskRecursive(tasks, id) {
                for (let t of tasks) {
                    if (t.id === id) return t;
                    if (t.subitems) {
                        let found = findTaskRecursive(t.subitems, id);
                        if (found) return found;
                    }
                }
                return null;
            }

            window.toggleProjectTaskStatus = function (pid, tid) {
                const p = projectsDB.find(x => x.id === pid);
                if (!p) return;
                const t = findTaskRecursive(p.subitems, tid);
                if (t) {
                    t.status = (t.status === 'done' ? 'working' : 'done');
                    saveProjectsData();
                    renderProjectDetail(pid);
                }
            }

            window.cycleProjectTaskStatus = function (pid, tid) {
                const p = projectsDB.find(x => x.id === pid);
                if (!p) return;
                const t = findTaskRecursive(p.subitems, tid);
                if (t) {
                    if (t.status === 'done') t.status = 'working';
                    else if (t.status === 'working') t.status = 'stuck';
                    else if (t.status === 'stuck') t.status = 'empty';
                    else t.status = 'done';
                    saveProjectsData();
                    renderProjectDetail(pid);
                }
            }

            window.editProjectTaskDate = function (pid, tid, field) {
                const p = projectsDB.find(x => x.id === pid);
                const t = findTaskRecursive(p.subitems, tid);
                if (!t) return;

                Swal.fire({
                    title: field === 'startDate' ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
                    html: `
                    <div class="p-4">
                        <input type="date" id="sw_date_val" class="swal2-input m-0" value="${t[field] || ''}">
                        <div class="mt-4 flex items-center gap-2 justify-center">
                            <input type="checkbox" id="sw_ongoing" ${t[field] === 'Ù…Ø³ØªÙ…Ø±' ? 'checked' : ''}>
                            <label for="sw_ongoing" class="text-sm font-bold">Ù…Ø´Ø±ÙˆØ¹ Ù…Ø³ØªÙ…Ø± / Ù…Ø±Ù†</label>
                        </div>
                    </div>
                `,
                    confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
                    preConfirm: () => {
                        if (document.getElementById('sw_ongoing').checked) return 'Ù…Ø³ØªÙ…Ø±';
                        return document.getElementById('sw_date_val').value;
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        t[field] = result.value || '-';
                        saveProjectsData();
                        renderProjectDetail(pid);
                    }
                });
            }

            window.toggleFlexibleTime = function (pid, tid) {
                const p = projectsDB.find(x => x.id === pid);
                if (!p) return;
                const t = findTaskRecursive(p.subitems, tid);
                if (t) {
                    t.flexibleTime = !t.flexibleTime;
                    saveProjectsData();
                    renderProjectDetail(pid);
                }
            }

            window.deleteProjectTask = function (pid, tid) {
                Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ',
                    text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªÙØ±Ø¹Ø© Ù…Ù†Ù‡Ø§.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const p = projectsDB.find(x => x.id === pid);
                        if (!p) return;
                        p.subitems = removeTaskRecursive(p.subitems, tid);
                        saveProjectsData();
                        renderProjectDetail(pid);
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
                    }
                });
            }

            function removeTaskRecursive(tasks, id) {
                return tasks.filter(t => {
                    if (t.id === id) return false;
                    if (t.subitems) t.subitems = removeTaskRecursive(t.subitems, id);
                    return true;
                });
            }

            function deleteProject(id) {
                Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ',
                    text: "Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        projectsDB = projectsDB.filter(p => p.id !== id);
                        saveProjectsData();
                        renderProjectBoard();
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
                    }
                });
            }

            function handleQuickAddTask(input) {
                const val = input.value.trim();
                if (!val || !currentProjectId) return;
                const p = projectsDB.find(x => x.id === currentProjectId);

                const newTask = {
                    id: Date.now(),
                    name: val,
                    status: 'working',
                    person: '?',
                    subitems: [],
                    flexibleTime: false,
                    startDate: new Date().toLocaleDateString('en-GB'),
                    endDate: '-'
                };

                p.subitems.push(newTask);
                input.value = '';
                saveProjectsData();
                renderProjectDetail(currentProjectId);
            }

            async function handleQuickAddMainTask(input) {
                const title = input.value.trim();
                if (!title) return;

                const newTask = {
                    id: Date.now(),
                    title: title,
                    from: currentUser.email,
                    assigned_to: currentUser.email,
                    type: 'general',
                    priority: 'medium',
                    status: 'pending',
                    taskDate: new Date().toISOString().split('T')[0],
                    ts: Date.now()
                };

                tasksDB.push(newTask);
                localStorage.setItem('tasks_v5', JSON.stringify(tasksDB));
                input.value = '';

                try {
                    await fetch(`${API_BASE}/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newTask)
                    });
                } catch (e) { console.warn("Backend sync failed"); }

                renderTasks(currentTaskFilter || 'all', currentTaskMember);
                renderCalendar();
            }

            window.addNestedSubtask = function (pid, tid) {
                Swal.fire({
                    title: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©',
                    html: `
                    <div class="space-y-4 text-right" dir="rtl">
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:</label>
                            <input id="sw_tname" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="block text-xs mb-1 font-bold">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                                <input id="sw_tperson" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø£ÙˆÙ„Ù‰">
                            </div>
                             <div>
                                <label class="block text-xs mb-1 font-bold">Ø§Ù„Ù†ÙˆØ¹:</label>
                                <select id="sw_ttype" class="swal2-input p-2 w-full m-0 text-sm">
                                    <option value="task" selected>Ù…Ù‡Ù…Ø© Ø¹Ù…Ù„</option>
                                    <option value="phase">Ù…Ø±Ø­Ù„Ø© / Ù‚Ø³Ù…</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="block text-xs font-bold">ÙˆÙ‚Øª Ù…Ø±Ù†ØŸ</label>
                            <select id="sw_tflex" class="swal2-input p-2 flex-1 m-0 text-sm">
                                <option value="no" selected>Ù„Ø§</option>
                                <option value="yes">Ù†Ø¹Ù…</option>
                            </select>
                        </div>
                    </div>
                `,
                    confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                    showCancelButton: true,
                    preConfirm: () => {
                        const name = document.getElementById('sw_tname').value;
                        if (!name) return Swal.showValidationMessage('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨');
                        return {
                            name: name,
                            person: document.getElementById('sw_tperson').value,
                            flex: document.getElementById('sw_tflex').value === 'yes',
                            type: document.getElementById('sw_ttype').value
                        };
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        const p = projectsDB.find(x => x.id === pid);
                        const parentTask = findTaskRecursive(p.subitems, tid);
                        if (parentTask) {
                            if (!parentTask.subitems) parentTask.subitems = [];
                            parentTask.subitems.push({
                                id: Date.now(),
                                name: result.value.name,
                                status: 'working',
                                type: result.value.type,
                                person: result.value.person || '?',
                                subitems: [],
                                flexibleTime: result.value.flex,
                                startDate: new Date().toLocaleDateString('en-GB'),
                                endDate: '-'
                            });
                            saveProjectsData();
                            renderProjectDetail(pid);
                        }
                    }
                });
            }

            function openNewProjectModal() {
                Swal.fire({
                    title: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯',
                    html: `
                    <div class="space-y-4 text-right" dir="rtl">
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</label>
                            <input id="sw_pname" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (FontAwesome):</label>
                            <input id="sw_picon" class="swal2-input p-2 w-full m-0 text-sm" value="fa-rocket">
                        </div>
                    </div>
                `,
                    confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
                    showCancelButton: true,
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    preConfirm: () => {
                        const name = document.getElementById('sw_pname').value;
                        const icon = document.getElementById('sw_picon').value;
                        if (!name) return Swal.showValidationMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                        return { name, icon };
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        projectsDB.push({
                            id: Date.now(),
                            name: result.value.name,
                            icon: result.value.icon,
                            status: 'working',
                            subitems: []
                        });
                        saveProjectsData();
                        renderProjectBoard();
                    }
                });
            }

            function openNewTaskInProject() {
                if (!currentProjectId) return;
                Swal.fire({
                    title: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                    html: `
                    <div class="space-y-4 text-right" dir="rtl">
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©:</label>
                            <select id="sw_tlevel" class="swal2-input p-2 w-full m-0 text-sm">
                                <option value="main">Ø£Ø³Ø§Ø³ÙŠØ©</option>
                                <option value="sub">ÙØ±Ø¹ÙŠØ© (ØªØ­Øª Ø¢Ø®Ø± Ù…Ù‡Ù…Ø©)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:</label>
                            <input id="sw_tname" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="block text-xs mb-1 font-bold">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                                <input id="sw_tperson" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø£ÙˆÙ„Ù‰">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 font-bold">ÙˆÙ‚Øª Ù…Ø±Ù†ØŸ</label>
                                <select id="sw_tflex" class="swal2-input p-2 w-full m-0 text-sm">
                                    <option value="no">Ù„Ø§</option>
                                    <option value="yes">Ù†Ø¹Ù…</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                    confirmButtonText: 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©',
                    showCancelButton: true,
                    preConfirm: () => {
                        const name = document.getElementById('sw_tname').value;
                        if (!name) return Swal.showValidationMessage('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨');
                        return {
                            level: document.getElementById('sw_tlevel').value,
                            name: name,
                            person: document.getElementById('sw_tperson').value,
                            flex: document.getElementById('sw_tflex').value === 'yes'
                        };
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        const p = projectsDB.find(x => x.id === currentProjectId);
                        const newTask = {
                            id: Date.now(),
                            name: result.value.name,
                            status: 'working',
                            person: result.value.person || '?',
                            subitems: [],
                            flexibleTime: result.value.flex,
                            startDate: new Date().toLocaleDateString('en-GB'),
                            endDate: '-'
                        };

                        if (result.value.level === 'main' || p.subitems.length === 0) {
                            p.subitems.push(newTask);
                        } else {
                            p.subitems[p.subitems.length - 1].subitems.push(newTask);
                        }

                        saveProjectsData();
                        renderProjectDetail(currentProjectId);
                    }
                });
            }

            // 3. Helper Functions
            function toggleSubitems(id) {
                const row = document.getElementById(`subitems-${id}`);
                if (row) {
                    if (row.classList.contains('show')) {
                        row.classList.remove('show');
                    } else {
                        row.classList.add('show');
                        // Focus input if opening
                        const input = row.querySelector('input[placeholder*="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©"]');
                        if (input) input.focus();
                    }
                }
            }

            function addSubitem(parentId, input) {
                const val = input.value.trim();
                if (!val) return;
                const p = projectsDB.find(x => x.id === parentId);
                if (p) {
                    if (!p.subitems) p.subitems = [];
                    p.subitems.push({ id: Date.now(), name: val, status: 'working', person: '?' });
                    saveProjectsData();
                    renderProjectTable();
                    setTimeout(() => toggleSubitems(parentId), 50); // Keep open
                }
            }

            function toggleSubitemStatus(projectId, subitemId) {
                const p = projectsDB.find(x => x.id === projectId);
                if (p && p.subitems) {
                    const sub = p.subitems.find(s => s.id === subitemId);
                    if (sub) {
                        sub.status = (sub.status === 'done' ? 'working' : 'done');
                        saveProjectsData();
                        renderProjectTable();
                        setTimeout(() => toggleSubitems(projectId), 20); // Keep open
                    }
                }
            }

            function updateSubitem(projectId, subitemId, newName) {
                const p = projectsDB.find(x => x.id === projectId);
                if (p && p.subitems) {
                    const sub = p.subitems.find(s => s.id === subitemId);
                    if (sub) {
                        sub.name = newName;
                        saveProjectsData();
                    }
                }
            }

            function deleteSubitem(projectId, subitemId) {
                const p = projectsDB.find(x => x.id === projectId);
                if (p && p.subitems) {
                    p.subitems = p.subitems.filter(s => s.id !== subitemId);
                    saveProjectsData();
                    renderProjectTable();
                    setTimeout(() => toggleSubitems(projectId), 20); // Keep open
                }
            }

            function cycleProjectStatus(id) {
                const p = projectsDB.find(x => x.id === id);
                if (p) {
                    if (p.status === 'empty') p.status = 'working';
                    else if (p.status === 'working') p.status = 'done';
                    else if (p.status === 'done') p.status = 'stuck';
                    else p.status = 'empty';
                    saveProjectsData();
                    renderProjectTable();
                }
            }

            // Quick Add (Bottom Input)
            function addProjectItem(input) {
                if (!input.value.trim()) return;
                const text = input.value;
                const tags = text.match(/#[\w]+/g) || [];
                const cleanName = text.replace(/#[\w]+/g, '').trim();

                projectsDB.push({
                    id: Date.now(),
                    name: cleanName,
                    person: ['?'],
                    status: 'working',
                    date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    timeline: '10%',
                    tags: tags,
                    files: [],
                    numbers: '',
                    subitems: []
                });
                input.value = '';
                saveProjectsData();
                renderProjectTable();
            }

            // 4. Modal Functions (Explicitly Global)
            window.customColumns = JSON.parse(localStorage.getItem('hyat_custom_cols')) || [];

            window.toggleColumnMenu = function (btn, e) {
                e.stopPropagation();
                let menu = document.getElementById('columnMenu');

                // If menu doesn't exist in body, create it
                if (!menu || menu.parentNode !== document.body) {
                    if (menu && menu.parentNode !== document.body) menu.remove(); // Remove old one if exists elsewhere

                    menu = document.createElement('div');
                    menu.id = 'columnMenu';
                    menu.className = 'col-menu text-left ltr font-tajawal fixed bg-white shadow-xl rounded-xl border border-gray-200 z-[9999] w-[280px]';
                    menu.onclick = (ev) => ev.stopPropagation();

                    menu.innerHTML = `
                    <div class="col-menu-search p-3 border-b border-gray-100">
                        <div class="bg-gray-50 rounded-lg flex items-center px-3 py-2">
                            <i class="fas fa-search text-gray-400 mr-2"></i>
                            <input type="text" placeholder="Search column type..." class="bg-transparent outline-none text-sm w-full text-gray-700">
                        </div>
                    </div>
                    <div class="p-2 max-h-[400px] overflow-y-auto">
                        <div class="col-section-title text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2 mt-2 px-2">Basic Columns</div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="hover:bg-blue-50 p-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-colors border border-transparent hover:border-blue-100" onclick="addColumn('Text')">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs bg-[#ffcb00] shadow-sm"><i class="fas fa-font"></i></div>
                                <span class="text-xs font-medium text-gray-700">Text</span>
                            </div>
                            <div class="hover:bg-blue-50 p-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-colors border border-transparent hover:border-blue-100" onclick="addColumn('Dropdown')">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs bg-[#00a9ff] shadow-sm"><i class="fas fa-caret-square-down"></i></div>
                                <span class="text-xs font-medium text-gray-700">Dropdown</span>
                            </div>
                            <div class="hover:bg-blue-50 p-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-colors border border-transparent hover:border-blue-100" onclick="addColumn('Checkbox')">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs bg-[#00d084] shadow-sm"><i class="fas fa-check-square"></i></div>
                                <span class="text-xs font-medium text-gray-700">Check</span>
                            </div>
                            <div class="hover:bg-blue-50 p-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-colors border border-transparent hover:border-blue-100" onclick="addColumn('Rating')">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs bg-[#ffcb00] shadow-sm"><i class="fas fa-star"></i></div>
                                <span class="text-xs font-medium text-gray-700">Rating</span>
                            </div>
                        </div>

                        <div class="col-section-title text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2 px-2">Advanced</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="hover:bg-blue-50 p-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-colors border border-transparent hover:border-blue-100" onclick="addColumn('Priority')">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs bg-[#f74c65] shadow-sm"><i class="fas fa-exclamation-triangle"></i></div>
                                <span class="text-xs font-medium text-gray-700">Priority</span>
                            </div>
                            <div class="hover:bg-blue-50 p-2 rounded-lg cursor-pointer flex flex-col items-center justify-center gap-2 transition-colors border border-transparent hover:border-blue-100" onclick="addColumn('Link')">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs bg-[#a25ddc] shadow-sm"><i class="fas fa-link"></i></div>
                                <span class="text-xs font-medium text-gray-700">Link</span>
                            </div>
                        </div>
                    </div>
                `;

                    document.body.appendChild(menu);
                }

                if (menu.style.display === 'block') {
                    menu.style.display = 'none';
                } else {
                    // Formatting and Positioning
                    const rect = btn.getBoundingClientRect();

                    // Smart positioning to avoid overflow
                    const spaceRight = window.innerWidth - rect.right;
                    let leftPos = rect.left;

                    if (spaceRight < 300) { // menu width approx 280
                        leftPos = rect.right - 280;
                    }

                    menu.style.display = 'block';
                    menu.style.top = (rect.bottom + 10) + 'px';
                    menu.style.left = leftPos + 'px';
                }
            };

            // Close menu when clicking outside
            document.addEventListener('click', function () {
                const menu = document.getElementById('columnMenu');
                if (menu) menu.style.display = 'none';
            });

            window.handleDropdownChange = function (pid, tid, colId, select) {
                const val = select.value;
                if (val === 'NEW_OPTION') {
                    Swal.fire({
                        title: 'Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯',
                        input: 'text',
                        inputPlaceholder: 'Ø§ÙƒØªØ¨ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§...',
                        showCancelButton: true,
                        confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                    }).then(res => {
                        if (res.isConfirmed && res.value.trim()) {
                            const newVal = res.value.trim();
                            // Find the column definition
                            const col = window.customColumns.find(c => c.id === colId);
                            if (col) {
                                if (!col.options) col.options = [];
                                if (!col.options.includes(newVal)) {
                                    col.options.push(newVal);
                                    localStorage.setItem('hyat_custom_cols', JSON.stringify(window.customColumns));
                                }
                                updateCustomCell(pid, tid, colId, newVal);
                                renderProjectDetail(currentProjectId);
                            }
                        } else {
                            select.value = ""; // Reset
                        }
                    });
                } else {
                    updateCustomCell(pid, tid, colId, val);
                }
            };

            window.addColumn = function (type) {
                Swal.fire({
                    title: 'Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
                    html: `
                    <div class="space-y-4 text-right" dir="rtl">
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯:</label>
                            <input id="col_title" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ Ø§Ù„Ù‚Ø³Ù…...">
                        </div>
                        ${type === 'Dropdown' ? `
                        <div>
                            <label class="block text-xs mb-1 font-bold">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„):</label>
                            <input id="col_options" class="swal2-input p-2 w-full m-0 text-sm" placeholder="Ø®ÙŠØ§Ø± 1, Ø®ÙŠØ§Ø± 2...">
                        </div>
                        ` : ''}
                    </div>
                `,
                    confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                    showCancelButton: true,
                    preConfirm: () => {
                        const title = document.getElementById('col_title').value;
                        if (!title) return Swal.showValidationMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
                        const optionsInput = document.getElementById('col_options');
                        const options = optionsInput && optionsInput.value.trim() ? optionsInput.value.split(',').map(o => o.trim()).filter(x => x) : [];
                        return { title, options };
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        const colId = 'col_' + Date.now();
                        window.customColumns.push({
                            id: colId,
                            type: type,
                            title: result.value.title,
                            options: result.value.options
                        });
                        localStorage.setItem('hyat_custom_cols', JSON.stringify(window.customColumns));
                        renderProjectHeaders();
                        renderProjectDetail(currentProjectId);
                    }
                });

                // Hide menu
                const menu = document.getElementById('columnMenu');
                if (menu) menu.style.display = 'none';
            }

            window.updateCustomCell = function (projectId, taskId, colId, value) {
                const p = projectsDB.find(x => x.id === projectId);
                if (!p) return;
                const t = findTaskRecursive(p.subitems, taskId);
                if (t) {
                    if (!t.custom) t.custom = {};
                    t.custom[colId] = value;
                    saveProjectsData();
                    // Optionally re-render for complex types like Rating
                    if (window.customColumns.find(c => c.id === colId).type === 'Rating') renderProjectDetail(projectId);
                }
            }

            window.cycleRating = function (pid, tid, colId) {
                const p = projectsDB.find(x => x.id === pid);
                const t = findTaskRecursive(p.subitems, tid);
                if (t) {
                    let current = parseInt((t.custom && t.custom[colId]) || 0);
                    let next = (current + 1) % 6;
                    updateCustomCell(pid, tid, colId, next);
                }
            }

            function renderProjectHeaders() {
                const headRow = document.getElementById('projectTableHeadRow');
                if (!headRow) return;

                const staticPart = `
                <th style="width: 40px; border-left: 4px solid #579bfc;"></th>
                <th style="width: 300px;">Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                <th style="width: 60px;"><i class="fas fa-clock text-xs"></i></th>
                <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                <th>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                <th>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
                <th style="width: 60px;">Ø­Ø°Ù</th>
            `;

                let dynamicPart = '';
                if (window.customColumns) {
                    window.customColumns.forEach(c => {
                        dynamicPart += `<th class="min-w-[100px] group relative">
                        <div class="flex items-center justify-between">
                            <span>${c.title}</span>
                            <button onclick="removeColumn('${c.id}')" class="text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times-circle"></i></button>
                        </div>
                    </th>`;
                    });
                }

                const addBtnPart = `<th style="position: relative; width: 60px;">
                <div class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center cursor-pointer transition mx-auto text-blue-600 dark:text-blue-400" onclick="toggleColumnMenu(this, event)">
                     <i class="fas fa-plus-circle text-lg"></i>
                </div>
            </th>`;

                headRow.innerHTML = staticPart + dynamicPart + addBtnPart;
            }

            window.removeColumn = function (id) {
                window.customColumns = window.customColumns.filter(c => c.id !== id);
                localStorage.setItem('hyat_custom_cols', JSON.stringify(window.customColumns));
                renderProjectHeaders();
                renderProjectDetail(currentProjectId);
            }

            // Initialize headers on load
            // We need to call this? We can call it at end of script or window.onload.
            // I will add a call inside renderProjectTable or make sure it runs once.
            // Let's hook into the existing window.onload if possible, or just run it at end of script.
            setTimeout(renderProjectHeaders, 500); // Delay to ensure DOM ready

            window.openNewProjectModal = function () {
                const modal = document.getElementById('newProjectModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        const input = document.getElementById('np_name');
                        if (input) input.focus();
                    }, 100);
                }
            };

            window.closeProjectModal = function () {
                document.getElementById('newProjectModal').classList.add('hidden');
            };

            // --- UPLOAD & TASK HELPERS ---
            let projectFilesBuffer = []; // Global Buffer

            window.updateFileLabel = function (input) {
                projectFilesBuffer = [];
                const label = document.getElementById('np_file_label');
                if (input.files && input.files.length > 0) {
                    label.innerText = `${input.files.length} Ù…Ù„ÙØ§Øª Ù…Ø­Ø¯Ø¯Ø©`;
                    label.classList.add('text-green-600', 'font-bold');

                    // Read files immediately
                    Array.from(input.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            let type = 'doc';
                            // Simple type detection
                            if (file.type.startsWith('image/')) type = 'img';
                            else if (file.type.startsWith('video/')) type = 'vid';

                            projectFilesBuffer.push({
                                name: file.name,
                                type: type,
                                data: e.target.result // Base64
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    label.innerText = 'Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª...';
                    label.classList.remove('text-green-600');
                }
            };

            window.populateAssignToDropdown = function () {
                const select = document.getElementById('assignTo');
                if (!select) return;
                select.innerHTML = '';

                // Default Option
                const def = document.createElement('option');
                def.value = '';
                def.innerText = '-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --';
                select.appendChild(def);

                // Populate from Users DB (use variable directly)
                const db = (typeof usersDB !== 'undefined') ? usersDB : (window.usersDB || USERS);

                if (db) {
                    Object.keys(db).forEach(email => {
                        const u = db[email];
                        const opt = document.createElement('option');
                        opt.value = email;
                        opt.innerText = u.name;
                        select.appendChild(opt);
                    });
                }
            };

            // Call populate on load
            setTimeout(window.populateAssignToDropdown, 2000);

            window.saveNewProject = function () {
                const name = document.getElementById('np_name').value;
                const type = document.getElementById('np_type').value;
                const dateInput = document.getElementById('np_date').value;
                const isFlexible = document.getElementById('np_flexible_date').checked;
                const person = document.getElementById('np_person').value;
                const budget = document.getElementById('np_budget').value;
                const tags = document.getElementById('np_tags').value;

                if (!name) { Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'warning'); return; }

                const newProject = {
                    id: Date.now(),
                    name: name,
                    type: type,
                    icon: type === 'Development' ? 'fa-code' : (type === 'Design' ? 'fa-pen-nib' : 'fa-project-diagram'),
                    status: 'working',
                    person: person,
                    budget: budget,
                    tags: tags,
                    endDate: isFlexible ? 'Ù…Ø³ØªÙ…Ø±' : (dateInput || '-'),
                    subitems: []
                };
                projectsDB.unshift(newProject);
                saveProjectsData();
                renderProjectTable();
                if (window.closeProjectModal) window.closeProjectModal();

                // Cleanup
                document.getElementById('np_name').value = '';
                document.getElementById('np_flexible_date').checked = false;
            };

            function saveProjectsData() {
                localStorage.setItem('projects_db_v3', JSON.stringify(projectsDB));
            }

            // --- MESSAGES LOGIC (PRIVATE CHAT & GROUP) ---
            // globalMessages and lastMsgCount are declared globally at top

            async function fetchMessages() {
                try {
                    const res = await fetch(`${API_BASE}/messages`);
                    if (res.ok) {
                        const data = await res.json();
                        globalMessages = data.map(m => ({
                            from: m.sender,
                            to: m.receiver,
                            text: m.content,
                            ts: m.timestamp,
                            is_read: m.is_read
                        }));
                        updateNotificationBadge();
                    }
                } catch (e) {
                    console.warn("API Chat fetch failed");
                    globalMessages = JSON.parse(localStorage.getItem('private_messages')) || [];
                }
            }

            async function fetchUsers() {
                try {
                    const res = await fetch(`${API_BASE}/users`);
                    if (res.ok) {
                        const data = await res.json();
                        data.forEach(u => {
                            if (!USERS[u.email]) USERS[u.email] = {};
                            USERS[u.email] = {
                                ...USERS[u.email],
                                email: u.email,
                                name: u.name,
                                role: u.role,
                                avatar: u.avatar,
                                color: u.color,
                                status: u.is_online ? 'online' : 'offline'
                            };
                        });
                        usersDB = USERS;
                    }
                } catch (e) { }
            }

            async function markAsRead(fromEmail) {
                if (!currentUser || fromEmail === 'group_family') return;
                try {
                    await fetch(`${API_BASE}/messages/read`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ from: fromEmail, to: currentUser.email })
                    });
                    await fetchMessages();
                } catch (e) { }
            }

            function updateNotificationBadge() {
                if (!currentUser) return;
                const unreadMsgs = globalMessages.filter(m => m.to === currentUser.email && !m.is_read).length;
                const pendingTasks = (tasksDB || []).filter(t => t.assigned_to === currentUser.email && t.status === 'pending').length;

                const total = unreadMsgs + pendingTasks;
                const badge = document.getElementById('navUnreadBadge');
                if (badge) {
                    if (total > 0) {
                        badge.innerText = total;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }

            function getMessages() {
                return globalMessages;
            }

            function loadChatUsers() {
                const list = document.getElementById('chatUserList');
                if (!list || !usersDB) return;

                list.innerHTML = '';

                // 1. ADD GROUP CHAT (Fixed Item)
                const groupTime = new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                const isGroupActive = activeChatUser && activeChatUser.email === 'group_family';
                list.innerHTML += `
    <div class="chat-user-item group ${isGroupActive ? 'active bg-blue-50 dark:bg-gray-700' : ''} hover:bg-purple-50 transition-colors cursor-pointer p-3 rounded-xl mb-2 flex items-center gap-3 border border-transparent hover:border-purple-100" 
         onclick="selectChatUser('group_family', 'Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø§Ù„ÙƒÙ„)', this)">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 text-white flex items-center justify-center font-bold shadow-md">
            <i class="fas fa-users"></i>
        </div>
        <div class="flex-1">
            <div class="flex justify-between items-center mb-1">
                <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø§Ù„ÙƒÙ„)</h4>
                <span class="text-[10px] text-gray-400">${groupTime}</span>
            </div>
            <p class="text-xs text-gray-400 truncate w-40 group-hover:text-purple-600">Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©...</p>
        </div>
    </div>
    <div class="h-px bg-gray-100 dark:bg-gray-700 my-2 mx-4"></div>
`;

                // 2. ADD OTHER USERS
                Object.values(usersDB).forEach(u => {
                    if (!u.email) return;
                    const ue = u.email.trim().toLowerCase();
                    const me = (currentUser && currentUser.email) ? currentUser.email.trim().toLowerCase() : '';

                    const isMe = (ue === me);
                    const displayName = isMe ? `${u.name} (Ø£Ù†Øª)` : u.name;

                    // Get unread for this specific user
                    const unreadCount = globalMessages.filter(m => m.from === u.email && m.to === currentUser.email && !m.is_read).length;

                    // Get last real message if exists
                    const allMsgs = getMessages();
                    const lastRealMsg = allMsgs.filter(m =>
                        (m.from === currentUser.email && m.to === u.email) ||
                        (m.from === u.email && m.to === currentUser.email)
                    ).pop();

                    const lastMsgText = lastRealMsg ? lastRealMsg.text : (isMe ? "Ø£Ø±Ø´ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." : "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†...");
                    const time = lastRealMsg ? new Date(lastRealMsg.ts).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '';

                    const isActive = activeChatUser && activeChatUser.email === u.email;

                    list.innerHTML += `
        <div class="chat-user-item group ${isActive ? 'active bg-blue-50 dark:bg-gray-700' : ''} hover:bg-gray-50 dark:hover:bg-gray-700 p-3 rounded-xl mb-1 flex items-center gap-3 cursor-pointer transition" 
             onclick="selectChatUser('${u.email}', '${u.name}', this)">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-sm relative" style="background-color: ${u.color || '#ccc'}">
                ${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : u.name.charAt(0)}
                <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${u.status === 'online' ? 'bg-green-500' : 'bg-gray-400'}"></span>
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                    <h4 class="font-bold text-sm text-gray-800 dark:text-white flex items-center gap-2">
                        ${displayName}
                        ${unreadCount > 0 ? `<span class="bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-full">${unreadCount}</span>` : ''}
                    </h4>
                    <span class="text-[10px] text-gray-400">${time}</span>
                </div>
                <p class="text-xs text-gray-400 truncate w-40 group-hover:text-gray-600 dark:group-hover:text-gray-300 dark:text-gray-500">${lastMsgText}</p>
            </div>
        </div>
    `;
                });
            }

            function selectChatUser(email, name, el) {
                const isMe = (currentUser && email === currentUser.email);
                const displayName = isMe ? `${name} (Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ)` : name;
                activeChatUser = { email, name: displayName };

                if (email !== 'group_family') markAsRead(email);

                // Highlight active user
                document.querySelectorAll('.chat-user-item').forEach(e => e.classList.remove('active', 'bg-blue-50', 'dark:bg-gray-700'));
                if (el) el.classList.add('active', 'bg-blue-50', 'dark:bg-gray-700');

                // Show Chat UI, Hide Empty State
                const emptyState = document.getElementById('chatEmptyState');
                if (emptyState) emptyState.classList.add('hidden');

                const header = document.getElementById('chatHeader');
                if (header) header.classList.remove('hidden');

                const win = document.getElementById('chatWindow');
                if (win) win.classList.remove('hidden');

                const inputArea = document.getElementById('chatInputArea');
                if (inputArea) inputArea.classList.remove('hidden');

                // Update Header
                const headerName = document.getElementById('chatHeaderName');
                if (headerName) headerName.innerText = displayName;

                const headerAvatar = document.getElementById('chatHeaderAvatar');
                if (headerAvatar) {
                    if (email === 'group_family') {
                        headerAvatar.innerHTML = '<i class="fas fa-users"></i>';
                        headerAvatar.style.backgroundColor = '#8b5cf6';
                    } else {
                        const u = Object.values(usersDB).find(x => x.email === email);
                        headerAvatar.innerText = name.charAt(0);
                        headerAvatar.style.backgroundColor = u ? u.color : '#ccc';
                    }
                }

                renderChatWindow();


            }

            function renderChatWindow() {
                if (!activeChatUser || !currentUser) return;

                const win = document.getElementById('chatWindow');
                if (!win) return;

                const msgs = getMessages();

                let conversation = [];
                if (activeChatUser.email === 'group_family') {
                    // Group Chat: Return ALL messages sent to 'group_family'
                    conversation = msgs.filter(m => m.to === 'group_family');
                } else {
                    // Private Chat
                    conversation = msgs.filter(m =>
                        (m.from === currentUser.email && m.to === activeChatUser.email) ||
                        (m.from === activeChatUser.email && m.to === currentUser.email)
                    );
                }

                win.innerHTML = '';

                if (conversation.length === 0) {
                    win.innerHTML = `
                    <div class="text-center py-10 opacity-50 select-none">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-gray-400">
                            <i class="far fa-comments"></i>
                        </div>
                        <p class="text-xs text-gray-400">Ù‡Ø°Ù‡ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${activeChatUser.name}</p>
                        <p class="text-[10px] text-gray-300 mt-1">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙ…Ø´ÙØ±Ø©</p>
                    </div>`;
                }

                // Group by Date? For now flat list
                let lastSender = null;

                conversation.forEach(m => {
                    const isMine = m.from === currentUser.email;
                    const senderObj = usersDB[m.from] || Object.values(usersDB).find(u => u.email === m.from);
                    const senderName = isMine ? 'Ø£Ù†Ø§' : (senderObj ? senderObj.name : (m.from.split('@')[0]));

                    // Group chat header or Private chat self-archiving indicator
                    let senderHeader = '';
                    if (activeChatUser.email === 'group_family' && !isMine && lastSender !== m.from) {
                        senderHeader = `<div class="text-[10px] font-bold text-gray-400 mb-1 ml-1">${senderName}</div>`;
                    }

                    win.innerHTML += `
                    <div class="flex flex-col ${isMine ? 'items-end' : 'items-start'} mb-2 fade-in">
                        ${senderHeader}
                        <div class="max-w-[80%] relative px-4 py-2 rounded-2xl text-sm shadow-sm
                                    ${isMine ? 'bg-palette-sidebar text-white rounded-br-none' : 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-600 rounded-bl-none'}">
                            ${m.text}
                            <div class="flex items-center justify-end gap-1 mt-1 opacity-60">
                                <span class="text-[9px] dir-ltr font-mono">
                                    ${new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </span>
                                ${isMine ? (m.is_read ? '<i class="fas fa-check-double text-[8px] text-blue-400"></i>' : '<i class="fas fa-check text-[8px] text-gray-400"></i>') : ''}
                            </div>
                        </div>
                    </div>
                `;
                    lastSender = m.from;
                });

                win.scrollTop = win.scrollHeight;
            }

            window.sendPrivateMessage = async function () {
                const input = document.getElementById('msgInput');
                if (!input) return;
                const text = input.value.trim();
                if (!text || !activeChatUser) return;

                try {
                    // Send to Backend
                    const res = await fetch(`${API_BASE}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            from: currentUser.email,
                            to: activeChatUser.email,
                            text: text
                        })
                    });

                    if (res.ok) {
                        input.value = '';
                        await fetchMessages(); // Update global messages
                        renderChatWindow(); // Re-render chat
                    } else {
                        console.error("Failed to send message");
                    }
                } catch (e) {
                    console.error("Error sending message:", e);
                }
            }
        </script>
        <script>
            // --- ATTENDANCE SYSTEM (UPDATED PAGE) ---
            let attendanceDB = JSON.parse(localStorage.getItem('attendance_db')) || {};

            function getTodayKey() {
                if (!currentUser) return null;
                const today = new Date().toISOString().split('T')[0];
                return `${currentUser.email} -${today} `;
            }

            function toggleAttendance() {
                if (!currentUser) { Swal.fire('Error', 'Please login first', 'error'); return; }
                const key = getTodayKey();
                let record = attendanceDB[key] || {};

                if (record.in && record.out) {
                    Swal.fire('Ø¥Ù†ØªÙ‡Ù‰ Ø§Ù„ÙŠÙˆÙ…', 'Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….', 'warning');
                    return;
                }

                if (!record.in) {
                    record.in = Date.now();
                    attendanceDB[key] = record;
                    Swal.fire({ title: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹', text: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${new Date().toLocaleTimeString()}`, icon: 'success', timer: 1500, showConfirmButton: false });
                } else if (!record.out) {
                    record.out = Date.now();
                    attendanceDB[key] = record;
                    const hours = calculateHours(record.in, record.out);
                    Swal.fire('Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‚Ø§Ø¡ ğŸ‘‹', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù. Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: ${hours}`, 'info');
                }

                localStorage.setItem('attendance_db', JSON.stringify(attendanceDB));
                updateAttendanceUI();
            }


            // 2. Ø¹Ø±Ø¶ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ (Team Logic)
            window.renderTeam = function () {
                const grid = document.getElementById('teamGrid');
                if (!grid) return;
                grid.innerHTML = '';

                Object.values(usersDB).forEach(user => {
                    const isOnline = user.status === 'online';
                    const bgColor = user.color || '#6366f1';

                    grid.innerHTML += `
                    <div class="bg-white dark:bg-palette-darkPanel p-6 rounded-3xl border border-palette-border dark:border-palette-darkBorder text-center shadow-sm hover:shadow-md transition group">
                        <div class="relative w-20 h-20 mx-auto mb-4">
                            <div class="w-full h-full rounded-full flex items-center justify-center text-white text-2xl font-bold overflow-hidden" style="background-color: ${bgColor}">
                                ${user.avatar ? `<img src="${user.avatar}" class="w-full h-full object-cover">` : user.name.charAt(0)}
                            </div>
                            <span class="absolute bottom-1 right-1 w-4 h-4 rounded-full border-2 border-white dark:border-gray-800 ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></span>
                        </div>
                        <h3 class="font-bold dark:text-white mb-1">${user.name}</h3>
                        <p class="text-xs text-gray-400 mb-4">${user.role}</p>
                        <button onclick="showPage('messages'); selectChatUser('${user.email}', '${user.name}')" 
                                class="text-xs bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-600 hover:text-white transition w-full font-bold flex items-center justify-center gap-2">
                            <i class="far fa-comment-dots ml-1"></i> Ù…Ø±Ø§Ø³Ù„Ø©
                        </button>
                    </div >`;
                });
            };


            // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Settings Update)
            window.updateProfile = function () {
                const newName = document.getElementById('settingsName').value;
                if (newName) {
                    currentUser.name = newName;
                    usersDB[currentUser.email].name = newName;

                    localStorage.setItem('users_db_v1', JSON.stringify(usersDB));
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

                    if (document.getElementById('userNameDisplay')) document.getElementById('userNameDisplay').innerText = newName;
                    if (document.getElementById('welcomeName')) document.getElementById('welcomeName').innerText = newName;
                    if (document.getElementById('settingsNameLabel')) document.getElementById('settingsNameLabel').innerText = newName;

                    Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            };

            // --- Preserved Helpers ---


            window.updateSettingsLabels = function () {
                if (currentUser) {
                    if (document.getElementById('settingsNameLabel')) document.getElementById('settingsNameLabel').innerText = currentUser.name;
                    if (document.getElementById('settingsRoleLabel')) document.getElementById('settingsRoleLabel').innerText = currentUser.role;
                    if (document.getElementById('settingsName')) document.getElementById('settingsName').value = currentUser.name;
                    renderUserAvatar(currentUser, 'settingsAvatar');
                }
            };

            const oldShowPage = window.showPage;
            window.showPage = function (id, el) {
                oldShowPage(id, el);
                if (id === 'settings') {
                    updateSettingsLabels();
                    switchSettingsTab('account');
                }
            };


            // --- NEW COLUMN MENU LOGIC ---

            let activeColumnBtn = null;

            window.toggleColumnMenu = function (btn, e) {
                e.stopPropagation();
                const menu = document.getElementById('columnTypeMenu');
                if (!menu) return;

                if (!menu.classList.contains('hidden')) {
                    // Close
                    menu.classList.add('hidden', 'opacity-0', 'scale-95');
                    activeColumnBtn = null;
                } else {
                    // Open
                    menu.classList.remove('hidden');
                    // Small delay to allow transition
                    setTimeout(() => menu.classList.remove('opacity-0', 'scale-95'), 10);

                    // Position
                    const rect = btn.getBoundingClientRect();
                    menu.style.top = (rect.bottom + 10) + 'px';
                    menu.style.left = (rect.left - 280) + 'px'; // Adjust to appear to the left if needed

                    // Safety check for screen edge
                    if (parseInt(menu.style.left) < 10) menu.style.left = '10px';

                    activeColumnBtn = btn;
                }
            };

            // Close menu when clicking outside
            document.addEventListener('click', function (e) {
                const menu = document.getElementById('columnTypeMenu');
                if (menu && !menu.contains(e.target) && activeColumnBtn && !activeColumnBtn.contains(e.target)) {
                    menu.classList.add('hidden', 'opacity-0', 'scale-95');
                    activeColumnBtn = null;
                }
            });

            window.itemMenuAction = function (type) {
                const menu = document.getElementById('columnTypeMenu');
                if (menu) menu.classList.add('hidden', 'opacity-0', 'scale-95');

                const headRow = document.getElementById('projectTableHeadRow');
                const body = document.getElementById('projectTableBody');
                if (!headRow || !body) return;

                // Add Header Cell
                const th = document.createElement('th');
                let userLabel = type.charAt(0).toUpperCase() + type.slice(1);
                let iconClass = '';

                switch (type) {
                    case 'dropdown': iconClass = 'fa-caret-square-down text-blue-500'; break;
                    case 'text': iconClass = 'fa-font text-yellow-500'; break;
                    case 'check': iconClass = 'fa-check-square text-green-500'; break;
                    case 'rating': iconClass = 'fa-star text-yellow-500'; break;
                    case 'formula': iconClass = 'fa-calculator text-purple-500'; break;
                    case 'priority': iconClass = 'fa-exclamation-triangle text-red-500'; break;
                    case 'link': iconClass = 'fa-link text-indigo-500'; break;
                    case 'doc': iconClass = 'fa-file-alt text-blue-600'; break;
                }

                th.innerHTML = `<div class="flex items-center gap-2"><i class="fas ${iconClass}"></i> ${userLabel}</div>`;

                // Insert before the last "Add Column" button (last child seems to be the button th)
                // The button is in the LAST th.
                headRow.insertBefore(th, headRow.lastElementChild);

                // Add Cell to All Existing Rows
                Array.from(body.children).forEach(row => {
                    const td = document.createElement('td');
                    td.className = "border-t border-[#e6e9ef] p-2"; // Apply basic styles

                    let cellContent = '';

                    if (type === 'dropdown') {
                        cellContent = `<select class="w-full bg-gray-50 border-none text-sm rounded p-1 outline-none">
                                        <option value="">- Select -</option>
                                        <option value="opt1" style="background:#c4dbf7;">Option 1</option>
                                        <option value="opt2" style="background:#ffd591;">Option 2</option>
                                        <option value="opt3" style="background:#ffb0b0;">Option 3</option>
                                    </select>`;
                    } else if (type === 'text') {
                        cellContent = `<input type="text" class="w-full bg-transparent outline-none text-sm" placeholder="...">`;
                    } else if (type === 'check') {
                        cellContent = `<div class="flex justify-center"><input type="checkbox" class="w-5 h-5 accent-green-500 cursor-pointer"></div>`;
                    } else if (type === 'rating') {
                        cellContent = `<div class="flex justify-center gap-1 text-gray-300 hover:text-yellow-400 cursor-pointer text-xs">
                                        <i class="fas fa-star" onclick="this.classList.toggle('text-yellow-400')"></i>
                                        <i class="fas fa-star" onclick="this.classList.toggle('text-yellow-400')"></i>
                                        <i class="fas fa-star" onclick="this.classList.toggle('text-yellow-400')"></i>
                                    </div>`;
                    } else if (type === 'priority') {
                        cellContent = `<div class="w-full h-8 flex items-center justify-center bg-gray-200 text-gray-500 rounded cursor-pointer text-xs font-bold" 
                                         onclick="cyclePriority(this)">Low</div>`;
                    } else if (type === 'formula') {
                        cellContent = `<div class="flex items-center gap-1">
                                        <i class="fas fa-calculator text-gray-400 text-[10px]"></i>
                                        <input type="number" class="w-full bg-transparent outline-none text-right font-mono text-sm" placeholder="0" onchange="runFormula()">
                                    </div>`;
                    } else if (type === 'link') {
                        cellContent = `<div class="flex items-center gap-1 text-blue-500">
                                        <i class="fas fa-external-link-alt text-[10px]"></i>
                                        <input type="text" class="w-full bg-transparent outline-none text-sm underline cursor-pointer" placeholder="www..." onclick="window.open(this.value? 'http://'+this.value : '#')">
                                    </div>`;
                    } else if (type === 'doc') {
                        cellContent = `<div class="flex justify-center cursor-pointer text-gray-400 hover:text-blue-600"><i class="far fa-file"></i></div>`;
                    }

                    td.innerHTML = cellContent;
                    row.appendChild(td);
                });

                // Notify
                const toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true
                });
                toast.fire({ icon: 'success', title: `Field '${userLabel}' Added` });
            };

            // Helper for Priority Click
            window.cyclePriority = function (el) {
                const states = [
                    { text: 'Low', class: 'bg-gray-200 text-gray-500' },
                    { text: 'Medium', class: 'bg-blue-400 text-white' },
                    { text: 'High', class: 'bg-purple-500 text-white' },
                    { text: 'Critical', class: 'bg-red-500 text-white' }
                ];
                // Find current index
                let currentText = el.innerText;
                let idx = states.findIndex(s => s.text === currentText);
                let nextIdx = (idx + 1) % states.length;

                el.className = `w-full h-8 flex items-center justify-center rounded cursor-pointer text-xs font-bold transition ${states[nextIdx].class}`;
                el.innerText = states[nextIdx].text;
            };

            // Dummy Formula Runner
            window.runFormula = function () {
                // Placeholder logic: maybe sum all numbers? 
                // For now just console log
                console.log("Formula calculated");
            };

            // --- SETTINGS TAB LOGIC ---
            window.switchSettingsTab = function (tabName) {
                // Hide all tabs
                document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));

                // Show selected tab
                const target = document.getElementById(`settings-${tabName}`);
                if (target) target.classList.remove('hidden');

                // Update Sidebar Buttons Styling
                ['account', 'security', 'notifications'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (t === tabName) {
                        btn.classList.remove('hover:bg-white', 'dark:hover:bg-gray-800', 'text-gray-600', 'dark:text-gray-300');
                        btn.classList.add('bg-palette-sidebar', 'text-white', 'font-bold', 'shadow-md');
                    } else {
                        btn.classList.add('hover:bg-white', 'dark:hover:bg-gray-800', 'text-gray-600', 'dark:text-gray-300');
                        btn.classList.remove('bg-palette-sidebar', 'text-white', 'font-bold', 'shadow-md');
                    }
                });
            };



            window.closeModal = function (id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                }
            };

            window.filterTasks = function (f) {
                console.log("Filtering tasks:", f);
                if (typeof renderTasks === 'function') {
                    renderTasks(f);
                } else if (window.renderTasks) {
                    window.renderTasks(f);
                }
            };



            window.toggleSetting = function (el, name) {
                const state = el.checked ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„';
                Swal.fire({
                    title: 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«',
                    text: `ØªÙ… ${state} ${name} Ø¨Ù†Ø¬Ø§Ø­`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            };

            // --- SHARED LINKS LOGIC ---
            let sharedLinks = JSON.parse(localStorage.getItem('shared_links_v1')) || [
                { id: 1, name: 'Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', url: '#', desc: 'Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©', type: 'Excel', ts: Date.now() }
            ];

            let currentLinkContentType = 'link';

            window.setLinkType = function (type) {
                currentLinkContentType = type;
                const isLink = type === 'link';
                const wrapLink = document.getElementById('wrapperLink');
                const wrapFile = document.getElementById('wrapperFile');
                if (wrapLink) wrapLink.classList.toggle('hidden', !isLink);
                if (wrapFile) wrapFile.classList.toggle('hidden', isLink);

                const btnLink = document.getElementById('btnTypeLink');
                const btnFile = document.getElementById('btnTypeFile');

                if (isLink) {
                    if (btnLink) btnLink.className = 'flex-1 py-2 text-xs font-bold rounded-lg transition bg-white dark:bg-gray-700 shadow-sm text-palette-primary';
                    if (btnFile) btnFile.className = 'flex-1 py-2 text-xs font-bold rounded-lg transition text-gray-500';
                    document.getElementById('linkUrl').setAttribute('required', '');
                } else {
                    if (btnFile) btnFile.className = 'flex-1 py-2 text-xs font-bold rounded-lg transition bg-white dark:bg-gray-700 shadow-sm text-palette-primary';
                    if (btnLink) btnLink.className = 'flex-1 py-2 text-xs font-bold rounded-lg transition text-gray-500';
                    document.getElementById('linkUrl').removeAttribute('required');
                }
            };

            window.getCurrentFileInputId = () => {
                const uploadTypeEl = document.querySelector('input[name="uploadType"]:checked');
                const uploadType = uploadTypeEl ? uploadTypeEl.value : 'file';
                return uploadType === 'folder' ? 'linkFolderInput' : 'linkFileInput';
            };

            window.toggleUploadInput = () => {
                const statusEl = document.getElementById('fileStatus');
                if (statusEl) statusEl.innerText = 'Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2GB)';
                document.getElementById('linkFileInput').value = '';
                document.getElementById('linkFolderInput').value = '';
            };

            window.handleFileSelected = (input) => {
                if (input.files && input.files.length > 0) {
                    const isFolder = input.hasAttribute('webkitdirectory');
                    let size = 0;
                    for (let f of input.files) size += f.size;

                    const sizeGB = size / (1024 * 1024 * 1024);
                    if (sizeGB > 2) {
                        Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ù…', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ùˆ 2GB', 'error');
                        input.value = '';
                        const statusEl = document.getElementById('fileStatus');
                        if (statusEl) statusEl.innerText = 'ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±: Ø§Ù„Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹';
                        return;
                    }

                    const status = isFolder ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${input.files.length} Ù…Ù„ÙØ§Øª` : `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù: ${input.files[0].name}`;
                    const statusEl = document.getElementById('fileStatus');
                    if (statusEl) statusEl.innerText = status;

                    const nameInput = document.getElementById('linkName');
                    if (nameInput && !nameInput.value) {
                        nameInput.value = isFolder ? 'Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯' : input.files[0].name;
                    }
                }
            };

            window.openLinkModal = function (id = null) {
                const modal = document.getElementById('linkModal');
                const title = document.getElementById('linkModalTitle');
                const form = document.getElementById('linkForm');

                if (form) form.reset();
                window.setLinkType('link');
                const statusEl = document.getElementById('fileStatus');
                if (statusEl) statusEl.innerText = 'Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2GB)';

                if (id) {
                    const link = sharedLinks.find(l => l.id == id);
                    if (link) {
                        if (title) title.innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                        document.getElementById('linkId').value = link.id;
                        document.getElementById('linkName').value = link.name;
                        document.getElementById('linkUrl').value = link.url || '';
                        document.getElementById('linkDesc').value = link.desc || '';
                        if (link.contentType === 'file' || link.contentType === 'folder') {
                            window.setLinkType('file');
                            if (statusEl) statusEl.innerText = 'ØªÙ… Ø±ÙØ¹ Ù…Ø­ØªÙˆÙ‰ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ±Ù‡)';
                        }
                    }
                } else {
                    if (title) title.innerText = 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©';
                    document.getElementById('linkId').value = '';
                }
                if (modal) modal.classList.remove('hidden');
            };

            window.addSharedLink = async function (e) {
                e.preventDefault();
                const id = document.getElementById('linkId').value;
                const name = document.getElementById('linkName').value;
                const desc = document.getElementById('linkDesc').value;

                let url = '';
                let contentType = currentLinkContentType;
                let typeIconName = 'Link';
                let fileData = null; // To store base64 data

                if (contentType === 'link') {
                    url = document.getElementById('linkUrl').value;
                    typeIconName = url.includes('docs.google.com') ? 'Google Doc' : (url.includes('sheet') ? 'Excel' : 'Link');
                } else {
                    const uploadTypeEl = document.querySelector('input[name="uploadType"]:checked');
                    const uploadType = uploadTypeEl ? uploadTypeEl.value : 'file';
                    const fileInput = document.getElementById(window.getCurrentFileInputId());

                    if (!id && (!fileInput.files || fileInput.files.length === 0)) {
                        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£Ùˆ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø±ÙØ¹', 'warning');
                        return;
                    }

                    contentType = uploadType === 'folder' ? 'folder' : 'file';
                    typeIconName = contentType === 'folder' ? 'Folder' : 'File';
                    url = '#';

                    // Read files as base64
                    if (fileInput.files.length > 0) {
                        if (contentType === 'file') {
                            const f = fileInput.files[0];
                            fileData = await new Promise(r => {
                                const reader = new FileReader();
                                reader.onload = e => r({ name: f.name, data: e.target.result });
                                reader.readAsDataURL(f);
                            });
                        } else {
                            // Folder: Read all files
                            fileData = await Promise.all([...fileInput.files].map(f => new Promise(r => {
                                const reader = new FileReader();
                                reader.onload = e => r({ name: f.webkitRelativePath || f.name, data: e.target.result });
                                reader.readAsDataURL(f);
                            })));
                        }
                    }
                }

                const linkData = {
                    name, url, desc, contentType,
                    type: typeIconName, ts: Date.now()
                };
                if (fileData) linkData.fileData = fileData;

                if (id) {
                    const index = sharedLinks.findIndex(l => l.id == id);
                    if (index !== -1) sharedLinks[index] = { ...sharedLinks[index], ...linkData };
                } else {
                    linkData.id = Date.now();
                    sharedLinks.unshift(linkData);
                }

                localStorage.setItem('shared_links_v1', JSON.stringify(sharedLinks));
                window.renderSharedLinks();
                closeModal('linkModal');
                Swal.fire({ title: 'ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©', text: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ÙƒØ² Ø¨Ù†Ø¬Ø§Ø­', icon: 'success', timer: 1500, showConfirmButton: false });
            };

            window.deleteSharedLink = function (id) {
                Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø·ØŸ',
                    text: 'Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        sharedLinks = sharedLinks.filter(l => l.id != id);
                        localStorage.setItem('shared_links_v1', JSON.stringify(sharedLinks));
                        window.renderSharedLinks();
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
                    }
                });
            };

            window.filterLinks = function (query) {
                const q = query.toLowerCase();
                document.querySelectorAll('.link-card').forEach(card => {
                    const nameLabel = card.getAttribute('data-name');
                    const descLabel = card.getAttribute('data-desc');
                    if (nameLabel.includes(q) || descLabel.includes(q)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            };

            window.renderSharedLinks = function () {
                const grid = document.getElementById('linksGrid');
                if (!grid) return;
                grid.innerHTML = '';

                sharedLinks.forEach(link => {
                    let icon = 'fa-link';
                    let color = 'bg-blue-50 text-blue-600';

                    const lowType = (link.type || '').toLowerCase();
                    const lowUrl = (link.url || '').toLowerCase();

                    if (lowType === 'excel' || lowUrl.includes('sheet')) {
                        icon = 'fa-file-excel';
                        color = 'bg-green-50 text-green-600';
                    } else if (lowType === 'folder' || link.contentType === 'folder') {
                        icon = 'fa-folder-open';
                        color = 'bg-yellow-50 text-yellow-600';
                    } else if (lowType === 'file' || link.contentType === 'file') {
                        icon = 'fa-file-alt';
                        color = 'bg-purple-50 text-purple-600';
                    } else if (lowUrl.includes('drive')) {
                        icon = 'fa-hdd';
                        color = 'bg-blue-50 text-blue-600';
                    } else if (lowUrl.includes('google.com/doc')) {
                        icon = 'fa-file-word';
                        color = 'bg-blue-100 text-blue-700';
                    }

                    grid.innerHTML += `
                    <div class="bg-white dark:bg-palette-darkPanel rounded-3xl p-6 border border-palette-border shadow-sm group hover:shadow-md transition relative overflow-hidden link-card" data-name="${link.name.toLowerCase()}" data-desc="${(link.desc || '').toLowerCase()}">
                        <div class="absolute top-4 left-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openLinkModal(${link.id})" class="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-500 flex items-center justify-center hover:bg-blue-500 hover:text-white transition shadow-sm" title="ØªØ¹Ø¯ÙŠÙ„">
                                <i class="fas fa-search text-[10px]"></i>
                            </button>
                            <button onclick="deleteSharedLink(${link.id})" class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition shadow-sm" title="Ø­Ø°Ù">
                                <i class="fas fa-trash-alt text-[10px]"></i>
                            </button>
                        </div>
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-2xl ${color} flex items-center justify-center text-xl shadow-sm">
                                <i class="fas ${icon}"></i>
                            </div>
                            <span class="text-[10px] bg-gray-50 dark:bg-gray-800 text-gray-400 px-2 py-1 rounded-md">${link.type}</span>
                        </div>
                        <h4 class="font-bold text-lg dark:text-white mb-1 text-right">${link.name}</h4>
                        <p class="text-xs text-gray-400 mb-6 text-right">${link.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                        <button onclick="${link.url === '#' ? `downloadSharedItem(${link.id})` : `window.open('${link.url}', '_blank')`}" class="w-full py-2.5 bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-xl flex items-center justify-center gap-2 font-bold text-xs hover:bg-palette-primary hover:text-white transition">
                            <i class="fas ${link.url === '#' ? 'fa-download' : 'fa-external-link-alt'}"></i> ${link.url === '#' ? 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·'}
                        </button>
                    </div>
                `;
                });
            };

            window.downloadSharedItem = async function (id) {
                const link = sharedLinks.find(l => l.id == id);
                if (!link || !link.fileData) {
                    Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ­Ù…ÙŠÙ„', 'warning');
                    return;
                }

                Swal.fire({
                    title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
                    text: 'ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    if (link.contentType === 'file') {
                        // Single File Download
                        const a = document.createElement('a');
                        a.href = link.fileData.data;
                        a.download = link.fileData.name;
                        a.click();
                    } else if (link.contentType === 'folder') {
                        // Folder Download: ZIP IT
                        const zip = new JSZip();
                        link.fileData.forEach(f => {
                            // Extract base64 without the prefix
                            const base64Content = f.data.split(',')[1];
                            zip.file(f.name, base64Content, { base64: true });
                        });
                        const content = await zip.generateAsync({ type: "blob" });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(content);
                        a.download = `${link.name}.zip`;
                        a.click();
                    }
                    Swal.close();
                } catch (e) {
                    console.error("Download error:", e);
                    Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„', 'error');
                }
            };

            // --- ROADMAP LOGIC ---
            let roadmapDB = JSON.parse(localStorage.getItem('roadmap_db_v1')) || [
                { id: 1, title: 'ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', who: 'Ù†ÙˆØ±Ø©', progress: 80, start: '2026-02-15', end: '2026-03-01', category: 'pm', parentId: null, done: false },
                { id: 101, title: 'ØªØµÙ…ÙŠÙ… Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', who: 'Ù†ÙˆØ±Ø©', progress: 100, start: '2026-02-16', end: '2026-02-18', category: 'pm', parentId: 1, done: true },
                { id: 102, title: 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†', who: 'Ù†ÙˆØ±Ø©', progress: 40, start: '2026-02-18', end: '2026-02-20', category: 'pm', parentId: 1, done: false },

                { id: 2, title: 'ÙˆØ±Ø´Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ', who: 'Ù„ÙŠÙ†Ø§', progress: 20, start: '2026-03-05', end: '2026-03-10', category: 'manage', parentId: null, done: false },
                { id: 201, title: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø³Ù†ÙˆÙŠØ©', who: 'Ù„ÙŠÙ†Ø§', progress: 10, start: '2026-03-06', end: '2026-03-07', category: 'manage', parentId: 2, done: false },

                { id: 3, title: 'Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Backend', who: 'ØºØ§Ø¯Ø©', progress: 0, start: '2026-02-25', end: '2026-03-15', category: 'dev', parentId: null, done: false },
                { id: 4, title: 'Ø­Ù…Ù„Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠ', who: 'Ù„ÙŠÙ†Ø§', progress: 0, start: '2026-04-01', end: '2026-04-15', category: 'general', parentId: null, done: false }
            ];

            window.openRoadmapModal = function (id = null, parentId = null) {
                const modal = document.getElementById('roadmapModal');
                const title = document.getElementById('roadmapModalTitle');
                const form = modal.querySelector('form');
                form.reset();

                document.getElementById('roadmapTaskId').value = id || '';
                document.getElementById('roadmapParentId').value = parentId || '';

                if (id) {
                    const task = roadmapDB.find(t => t.id == id);
                    if (task) {
                        title.innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©';
                        document.getElementById('rmTaskTitle').value = task.title;
                        document.getElementById('rmTaskWho').value = task.who;
                        document.getElementById('rmTaskCategory').value = task.category;
                        document.getElementById('rmTaskStart').value = task.start;
                        document.getElementById('rmTaskEnd').value = task.end;
                        const prog = task.progress || (task.done ? 100 : 0);
                        document.getElementById('rmTaskProgress').value = prog;
                        document.getElementById('rmTaskProgress').nextElementSibling.innerText = prog + '%';
                    }
                } else {
                    title.innerText = parentId ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                    document.getElementById('rmTaskProgress').value = 0;
                    document.getElementById('rmTaskProgress').nextElementSibling.innerText = '0%';
                }

                modal.classList.remove('hidden');
            };

            window.saveRoadmapTask = function (e) {
                e.preventDefault();
                const id = document.getElementById('roadmapTaskId').value;
                const parentId = document.getElementById('roadmapParentId').value;
                const progVal = parseInt(document.getElementById('rmTaskProgress').value);

                const taskData = {
                    id: id ? parseInt(id) : Date.now(),
                    title: document.getElementById('rmTaskTitle').value,
                    who: document.getElementById('rmTaskWho').value,
                    category: document.getElementById('rmTaskCategory').value,
                    start: document.getElementById('rmTaskStart').value,
                    end: document.getElementById('rmTaskEnd').value,
                    progress: progVal,
                    done: progVal === 100,
                    parentId: parentId ? parseInt(parentId) : null
                };

                if (id) {
                    roadmapDB = roadmapDB.map(t => t.id == id ? { ...t, ...taskData } : t);
                } else {
                    roadmapDB.push(taskData);
                }

                localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                renderRoadmap();
                closeModal('roadmapModal');
                Swal.fire({ title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', icon: 'success', timer: 1000, showConfirmButton: false });
            };

            window.toggleRoadmapDone = function (id) {
                const task = roadmapDB.find(t => t.id == id);
                if (task) {
                    task.done = !task.done;
                    localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                    renderRoadmap();
                }
            };

            window.quickAddSubTask = function (parentId, event) {
                if (event.key === 'Enter') {
                    const title = event.target.value.trim();
                    if (!title) return;

                    const parent = roadmapDB.find(t => t.id == parentId);
                    const newTask = {
                        id: Date.now(),
                        title: title,
                        who: parent ? parent.who : 'Ø§Ù„ÙƒÙ„',
                        category: parent ? parent.category : 'general',
                        start: new Date().toISOString().split('T')[0],
                        end: new Date().toISOString().split('T')[0],
                        process: 'Ù…Ù‡Ù…Ø© ÙØ±Ø¹ÙŠØ©',
                        done: false,
                        parentId: parentId
                    };

                    roadmapDB.push(newTask);
                    localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                    renderRoadmap();
                    event.target.value = '';
                    Swal.fire({ title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', icon: 'success', timer: 800, showConfirmButton: false });
                }
            };

            window.toggleSubTaskStatus = function (taskId, subTaskIndex) {
                const task = roadmapDB.find(t => t.id == taskId);
                if (task && task.subtasks && task.subtasks[subTaskIndex]) {
                    task.subtasks[subTaskIndex].completed = !task.subtasks[subTaskIndex].completed;
                    localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                    renderRoadmap();
                }
            };
            window.removeSubTaskFromArray = function (taskId, subTaskIndex) {
                const task = roadmapDB.find(t => t.id == taskId);
                if (task && task.subtasks) {
                    task.subtasks.splice(subTaskIndex, 1);
                    localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                    renderRoadmap();
                }
            };
            window.quickAddTaskToCategory = function (category, event) {
                if (event.key === 'Enter') {
                    const title = event.target.value.trim();
                    if (!title) return;

                    const newTask = {
                        id: Date.now(),
                        title: title,
                        who: 'Ø§Ù„ÙƒÙ„',
                        category: category,
                        start: new Date().toISOString().split('T')[0],
                        end: new Date().toISOString().split('T')[0],
                        process: 'Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                        done: false,
                        parentId: null
                    };

                    roadmapDB.push(newTask);
                    localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                    renderRoadmap();
                    Swal.fire({ title: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©', icon: 'success', timer: 800, showConfirmButton: false });
                }
            };

            window.updateRoadmapTitle = function (id, newTitle) {
                const task = roadmapDB.find(t => t.id == id);
                if (task && newTitle.trim()) {
                    task.title = newTitle.trim();
                    localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                    renderRoadmap();
                }
            };

            window.deleteRoadmapTask = function (id) {
                Swal.fire({
                    title: 'Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ',
                    text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const idsToDelete = [id];
                        const findChildren = (pid) => {
                            roadmapDB.filter(t => t.parentId == pid).forEach(child => {
                                idsToDelete.push(child.id);
                                findChildren(child.id);
                            });
                        };
                        findChildren(id);

                        roadmapDB = roadmapDB.filter(t => !idsToDelete.includes(t.id));
                        localStorage.setItem('roadmap_db_v1', JSON.stringify(roadmapDB));
                        renderRoadmap();
                    }
                });
            };

            function renderRoadmap() {
                const body = document.getElementById('roadmapTableBody');
                const head = document.getElementById('roadmapTimelineHeader');
                if (!body || !head) return;

                body.innerHTML = '';

                // 1. Calculate Timeline Range (14 days starting from 2 days ago)
                const today = new Date();
                const startRange = new Date(today);
                startRange.setDate(today.getDate() - 2);

                const timelineDays = [];
                let headHTML = '<div class="flex items-center justify-center gap-1 min-w-[300px]">';
                for (let i = 0; i < 14; i++) {
                    const d = new Date(startRange);
                    d.setDate(startRange.getDate() + i);
                    timelineDays.push(d.toISOString().split('T')[0]);

                    const isToday = d.toISOString().split('T')[0] === today.toISOString().split('T')[0];
                    const dayNum = d.getDate();
                    const dayName = d.toLocaleDateString('ar-SA', { weekday: 'narrow' });

                    headHTML += `
                    <div class="flex flex-col items-center w-8 ${isToday ? 'text-palette-primary font-bold' : 'text-gray-400'}">
                        <span class="text-[10px]">${dayName}</span>
                        <span class="text-xs ${isToday ? 'bg-palette-primary text-white w-6 h-6 rounded-full flex items-center justify-center shadow-sm' : ''}">${dayNum}</span>
                    </div>
                `;
                }
                headHTML += '</div>';
                head.innerHTML = headHTML;

                const categories = ['hr', 'pm', 'dev', 'manage', 'general'];
                const catNames = { 'hr': 'Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©', 'pm': 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§Ø±ÙŠØ¹', 'dev': 'ØªØ·ÙˆÙŠØ± ÙˆØ¨Ø±Ù…Ø¬Ø©', 'manage': 'Ø¥Ø¯Ø§Ø±Ø©', 'general': 'Ø¹Ø§Ù…' };
                const catColors = { 'hr': 'blue', 'pm': 'purple', 'dev': 'indigo', 'manage': 'orange', 'general': 'gray' };

                categories.forEach(cat => {
                    const catTasks = roadmapDB.filter(t => t.category === cat && !t.parentId);
                    if (catTasks.length === 0 && !roadmapDB.some(t => t.category === cat)) return;

                    body.innerHTML += `
                    <tr class="bg-${catColors[cat]}-50/30 dark:bg-${catColors[cat]}-900/10">
                        <td colspan="7" class="p-4 font-bold text-${catColors[cat]}-600 dark:text-${catColors[cat]}-400">${catNames[cat]}</td>
                    </tr>
                `;
                    catTasks.forEach(task => renderTaskRow(task, 0));
                });

                function getTaskProgressRecursive(taskId) {
                    const task = roadmapDB.find(t => t.id == taskId);
                    if (!task) return 0;
                    const kids = roadmapDB.filter(t => t.parentId == taskId);
                    if (kids.length > 0) {
                        const total = kids.reduce((acc, k) => acc + getTaskProgressRecursive(k.id), 0);
                        return Math.round(total / kids.length);
                    }
                    return task.done ? 100 : (task.progress || 0);
                }

                function renderTaskRow(task, level) {
                    const indent = level * 20;
                    const children = roadmapDB.filter(t => t.parentId == task.id);
                    const displayProgress = getTaskProgressRecursive(task.id);
                    const isFinalTask = children.length === 0;

                    // Timeline Shading Logic
                    let timelineRowHTML = '<div class="flex items-center justify-center gap-1 min-w-[300px] h-full">';
                    const tStart = new Date(task.start);
                    const tEnd = new Date(task.end);

                    timelineDays.forEach(dayStr => {
                        const d = new Date(dayStr);
                        const isActive = d >= tStart && d <= tEnd;
                        const isToday = dayStr === today.toISOString().split('T')[0];

                        let bgClass = 'bg-transparent';
                        let opacity = 'opacity-0';

                        if (isActive) {
                            opacity = 'opacity-100';
                            if (displayProgress >= 100) bgClass = 'bg-green-500';
                            else if (displayProgress > 0) bgClass = 'bg-blue-500';
                            else bgClass = 'bg-gray-300';
                        }

                        timelineRowHTML += `
                        <div class="w-8 h-6 flex items-center justify-center relative">
                            ${isToday ? '<div class="absolute inset-y-0 w-px bg-palette-primary/20 z-0"></div>' : ''}
                            <div class="w-6 h-2 rounded-full ${bgClass} ${opacity} z-10 transition-all roadmap-timeline-bar ${displayProgress > 0 && displayProgress < 100 ? 'animate-pulse-soft' : ''}" 
                                 title="${task.title}: ${displayProgress}%"></div>
                        </div>
                    `;
                    });
                    timelineRowHTML += '</div>';

                    body.innerHTML += `
                    <tr class="border-b border-gray-50 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition">
                        <td class="py-4 pr-4 font-medium dark:text-white" style="padding-right: ${indent + 16}px">
                            <div class="flex items-center gap-2">
                                ${level > 0 ? '<i class="fas fa-level-down-alt text-gray-300 transform -scale-x-100 mr-1 opacity-50"></i>' : ''}
                                ${isFinalTask ? `
                                    <input type="checkbox" ${task.done ? 'checked' : ''} 
                                        onclick="toggleRoadmapDone(${task.id})"
                                        class="w-4 h-4 accent-palette-primary rounded cursor-pointer">
                                ` : '<i class="fas fa-folder-open text-gray-300 text-xs"></i>'}
                                <span class="${task.done ? 'line-through text-gray-400' : ''} outline-none focus:bg-white dark:focus:bg-gray-700 p-1 rounded" 
                                      contenteditable="true" onblur="updateRoadmapTitle(${task.id}, this.innerText)">
                                    ${task.title}
                                </span>
                            </div>
                        </td>
                        <td class="py-4 text-gray-500 dark:text-gray-400 text-xs font-bold">${task.who}</td>
                        <td class="py-4">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden min-w-[60px]">
                                    <div class="h-full bg-gradient-to-l from-blue-500 to-indigo-600 transition-all duration-500" style="width: ${displayProgress}%"></div>
                                </div>
                                <span class="text-[10px] font-bold text-gray-400">${displayProgress}%</span>
                            </div>
                        </td>
                        <td class="py-4 text-gray-400 text-[10px] text-center">${task.start}</td>
                        <td class="py-4 text-gray-400 text-[10px] text-center">${task.end}</td>
                        <td class="py-4 text-center">${timelineRowHTML}</td>
                        <td class="py-4 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <button onclick="openRoadmapModal(null, ${task.id})" class="text-gray-400 hover:text-green-500 p-1"><i class="fas fa-plus-square"></i></button>
                                <button onclick="openRoadmapModal(${task.id})" class="text-gray-400 hover:text-blue-500 p-1"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteRoadmapTask(${task.id})" class="text-gray-400 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;

                    children.forEach(child => renderTaskRow(child, level + 1));
                }
            }

            // Initialize App
            (async function initApp() {
                if (window.fetchTasks) {
                    console.log("Fetching initial data...");
                    await fetchTasks();
                    renderTasks('all');
                }

                // Render UI dynamic components
                renderRoadmap();
                renderSharedLinks();

                // Polling for new content
                setInterval(async () => {
                    await fetchTasks();
                    if (window.fetchUsers) await fetchUsers();
                    if (window.fetchMessages) await fetchMessages();

                    const chatWin = document.getElementById('chatWindow');
                    const msgs = getMessages();
                    if (chatWin && !chatWin.classList.contains('hidden')) {
                        if (msgs.length !== lastMsgCount) {
                            if (typeof renderChatWindow === 'function') renderChatWindow();
                            lastMsgCount = msgs.length;
                        }
                    } else {
                        lastMsgCount = msgs.length;
                    }
                    if (typeof loadChatUsers === 'function') loadChatUsers();
                    if (typeof renderTeam === 'function') renderTeam();
                    if (typeof buildDashboard === 'function') {
                        const dashboardVisible = !document.getElementById('dashboard').classList.contains('hidden-section');
                        if (dashboardVisible) buildDashboard();
                    }
                    if (typeof renderReports === 'function') {
                        const reportsVisible = !document.getElementById('reports').classList.contains('hidden-section');
                        if (reportsVisible) renderReports();
                    }
                }, 3000);

                // Heartbeat every 15s to maintain online status
                setInterval(async () => {
                    if (currentUser && currentUser.email) {
                        try {
                            const res = await fetch(`${API_BASE}/heartbeat`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email: currentUser.email })
                            });
                        } catch (e) {
                            console.error("Heartbeat error");
                        }
                    }
                }, 15000);
            })();

            async function quickAddTask(title) {
                console.log("Quick add disabled.");
            }
        </script>
</body>

</html>
